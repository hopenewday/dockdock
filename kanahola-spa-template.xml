<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html b:css='false' b:defaultwidgetversion='2' b:layoutsVersion='3' b:responsive='true' b:templateVersion='1.3.3'
      expr:class='data:blog.languageDirection' expr:dir='data:blog.languageDirection' expr:lang='data:blog.locale'
      xmlns='http://www.w3.org/1999/xhtml'
      xmlns:b='http://www.google.com/2005/gml/b'
      xmlns:data='http://www.google.com/2005/gml/data'
      xmlns:expr='http://www.google.com/2005/gml/expr'>
<b:include name='themeColor'/>
<head>
  <b:include name='themeHead'/>
  <meta charset='utf-8'/>
  <meta content='width=device-width, initial-scale=1' name='viewport'/>
  <title><data:blog.pageTitle/></title>
  <b:include data='blog' name='all-head-content'/>

  <!-- PWA Support - Improved for Blogger Compatibility -->
  <meta name="theme-color" content="#4a90e2"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Kanahola Magazine"/>
  <!-- Web App Manifest - Using link tag for better compatibility -->
  <link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Kanahola Magazine&quot;,&quot;short_name&quot;:&quot;Kanahola&quot;,&quot;description&quot;:&quot;Lifestyle, travel, food, and culture magazine&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#4a90e2&quot;,&quot;orientation&quot;:&quot;portrait-primary&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;<b:eval expr='data:blog.logoUrl'/>&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;purpose&quot;:&quot;any maskable&quot;}],&quot;shortcuts&quot;:[{&quot;name&quot;:&quot;Latest Articles&quot;,&quot;short_name&quot;:&quot;Latest&quot;,&quot;description&quot;:&quot;View the latest articles&quot;,&quot;url&quot;:&quot;/&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;<b:eval expr='data:blog.logoUrl'/>&quot;,&quot;sizes&quot;:&quot;192x192&quot;}]}],&quot;related_applications&quot;:[],&quot;prefer_related_applications&quot;:false,&quot;categories&quot;:[&quot;lifestyle&quot;,&quot;magazines&quot;,&quot;travel&quot;,&quot;food&quot;,&quot;culture&quot;]}"/>
  <link expr:href='data:blog.logoUrl' rel="apple-touch-icon"/>

  <!-- Enhanced Resource Prioritization -->
  <!-- Early connection establishment for critical domains -->
  <link rel='preconnect' href='https://fonts.gstatic.com' crossorigin='anonymous'/>
  <link rel='preconnect' href='https://cdnjs.cloudflare.com' crossorigin='anonymous'/>
  <link rel='preconnect' href='https://code.jquery.com' crossorigin='anonymous'/>
  <link rel='preconnect' href='https://www.google-analytics.com' crossorigin='anonymous'/>
  <link rel='preconnect' href='https://www.googletagmanager.com' crossorigin='anonymous'/>

  <!-- Inline mobile-gestures.js to avoid external file dependency -->
  <script>
    /**
     * Kanahola Magazine - Mobile Gestures
     * Enhanced touch interactions for mobile devices
     */
    (function($) {
      'use strict';

      // Mobile Gesture Handler
      const MobileGestures = {
        // Configuration
        config: {
          swipeThreshold: 100, // Minimum distance for a swipe (in pixels)
          swipeTimeThreshold: 300, // Maximum time for a swipe (in milliseconds)
          pullThreshold: 80, // Threshold for pull-to-refresh (in pixels)
          maxPullDistance: 150, // Maximum pull distance (in pixels)
          animationDuration: 300, // Animation duration (in milliseconds)
          doubleTapDelay: 300, // Maximum delay between taps for double tap (in milliseconds)
          longPressDelay: 500, // Delay for long press (in milliseconds)
        },

        // State
        state: {
          touchStartX: 0,
          touchStartY: 0,
          touchEndX: 0,
          touchEndY: 0,
          touchStartTime: 0,
          touchEndTime: 0,
          isPulling: false,
          pullDistance: 0,
          lastTapTime: 0,
          longPressTimer: null,
          isScrolling: false,
          isInitialized: false,
          isRefreshing: false,
          swipeNavigationEnabled: true,
          pullToRefreshEnabled: true,
        },

        // DOM Elements
        elements: {
          body: $('body'),
          mainContent: $('.main-content'),
          header: $('.header'),
          pullToRefreshIndicator: null,
          swipeIndicatorLeft: null,
          swipeIndicatorRight: null,
        },

        // Initialize gesture handling
        init: function() {
          if (this.state.isInitialized) return;

          // Only initialize on touch devices
          if (!this.isTouchDevice()) {
            console.log('Not a touch device, skipping mobile gestures initialization');
            return;
          }

          this.createUIElements();
          this.bindEvents();

          this.state.isInitialized = true;
          console.log('Mobile gestures initialized');
        },

        // Check if device supports touch
        isTouchDevice: function() {
          return ('ontouchstart' in window) ||
                 (navigator.maxTouchPoints > 0) ||
                 (navigator.msMaxTouchPoints > 0);
        },

        // Create UI elements for gestures
        createUIElements: function() {
          // Create pull-to-refresh indicator
          this.elements.pullToRefreshIndicator = $('<div class="pull-to-refresh-indicator"><div class="pull-to-refresh-spinner"></div><span>Pull to refresh</span></div>');
          this.elements.body.prepend(this.elements.pullToRefreshIndicator);

          // Create swipe indicators
          this.elements.swipeIndicatorLeft = $('<div class="swipe-indicator swipe-indicator-left"><i class="fas fa-chevron-left"></i></div>');
          this.elements.swipeIndicatorRight = $('<div class="swipe-indicator swipe-indicator-right"><i class="fas fa-chevron-right"></i></div>');
          this.elements.body.append(this.elements.swipeIndicatorLeft);
          this.elements.body.append(this.elements.swipeIndicatorRight);
        },

        // Bind event listeners
        bindEvents: function() {
          // Touch events for the entire page
          this.elements.body.on('touchstart', this.handleTouchStart.bind(this));
          this.elements.body.on('touchmove', this.handleTouchMove.bind(this));
          this.elements.body.on('touchend', this.handleTouchEnd.bind(this));

          // Double tap event for zooming in on images
          $('.post-content img').on('touchend', this.handleImageDoubleTap.bind(this));

          // Prevent default on pull-to-refresh indicator
          this.elements.pullToRefreshIndicator.on('touchmove', function(e) {
            e.preventDefault();
          });
        },

        // Handle touch start event
        handleTouchStart: function(e) {
          const touch = e.originalEvent.touches[0];

          // Store initial touch position and time
          this.state.touchStartX = touch.clientX;
          this.state.touchStartY = touch.clientY;
          this.state.touchStartTime = Date.now();

          // Reset end values
          this.state.touchEndX = 0;
          this.state.touchEndY = 0;

          // Check for long press
          clearTimeout(this.state.longPressTimer);
          this.state.longPressTimer = setTimeout(() => {
            this.handleLongPress(e);
          }, this.config.longPressDelay);

          // Reset pull state
          this.state.isPulling = false;
          this.state.isScrolling = false;
        },

        // Handle touch move event
        handleTouchMove: function(e) {
          const touch = e.originalEvent.touches[0];

          // Update current touch position
          this.state.touchEndX = touch.clientX;
          this.state.touchEndY = touch.clientY;

          // Calculate distance moved
          const deltaX = this.state.touchEndX - this.state.touchStartX;
          const deltaY = this.state.touchEndY - this.state.touchStartY;

          // Determine if user is scrolling vertically
          if (Math.abs(deltaY) > Math.abs(deltaX) &amp;&amp; !this.state.isScrolling) {
            this.state.isScrolling = true;

            // Cancel long press when scrolling
            clearTimeout(this.state.longPressTimer);
          }

          // Handle horizontal swipe indicators
          if (Math.abs(deltaX) > 50 &amp;&amp; !this.state.isScrolling &amp;&amp; this.state.swipeNavigationEnabled) {
            if (deltaX > 0) {
              // Swiping right (go back)
              this.elements.swipeIndicatorLeft.addClass('active');
              this.elements.swipeIndicatorRight.removeClass('active');
            } else {
              // Swiping left (go forward)
              this.elements.swipeIndicatorRight.addClass('active');
              this.elements.swipeIndicatorLeft.removeClass('active');
            }
          } else {
            // Hide indicators if swipe is not significant
            this.elements.swipeIndicatorLeft.removeClass('active');
            this.elements.swipeIndicatorRight.removeClass('active');
          }

          // Handle pull-to-refresh
          if (this.state.pullToRefreshEnabled &amp;&amp;
              window.scrollY === 0 &amp;&amp;
              deltaY > 0 &amp;&amp;
              !this.state.isRefreshing) {

            // Prevent default to disable native scrolling
            e.preventDefault();

            this.state.isPulling = true;
            this.state.pullDistance = Math.min(deltaY, this.config.maxPullDistance);

            // Update pull-to-refresh indicator
            this.elements.pullToRefreshIndicator.css('transform', `translateY(${this.state.pullDistance - 60}px)`);

            // Update text based on pull distance
            if (this.state.pullDistance > this.config.pullThreshold) {
              this.elements.pullToRefreshIndicator.find('span').text('Release to refresh');
            } else {
              this.elements.pullToRefreshIndicator.find('span').text('Pull to refresh');
            }
          }
        },

        // Handle touch end event
        handleTouchEnd: function(e) {
          // Cancel long press timer
          clearTimeout(this.state.longPressTimer);

          // Update end time
          this.state.touchEndTime = Date.now();

          // Calculate swipe duration
          const swipeDuration = this.state.touchEndTime - this.state.touchStartTime;

          // Calculate distance
          const deltaX = this.state.touchEndX - this.state.touchStartX;
          const deltaY = this.state.touchEndY - this.state.touchStartY;

          // Hide swipe indicators
          this.elements.swipeIndicatorLeft.removeClass('active');
          this.elements.swipeIndicatorRight.removeClass('active');

          // Handle pull-to-refresh
          if (this.state.isPulling) {
            if (this.state.pullDistance > this.config.pullThreshold) {
              // Trigger refresh
              this.triggerRefresh();
            } else {
              // Reset pull-to-refresh indicator
              this.resetPullToRefresh();
            }

            this.state.isPulling = false;
            return;
          }

          // Check if it's a valid swipe
          if (Math.abs(deltaX) &gt; this.config.swipeThreshold &amp;&amp;
              swipeDuration &lt; this.config.swipeTimeThreshold &amp;&amp;
              !this.state.isScrolling &amp;&amp;
              this.state.swipeNavigationEnabled) {

            if (deltaX &gt; 0) {
              // Swipe right - go back
              this.handleSwipeRight();
            } else {
              // Swipe left - go forward
              this.handleSwipeLeft();
            }
          }

          // Check for double tap
          const currentTime = Date.now();
          if (currentTime - this.state.lastTapTime &lt; this.config.doubleTapDelay) {
            // Double tap detected
            this.handleDoubleTap(e);
          }

          this.state.lastTapTime = currentTime;
        },

        // Handle swipe right (go back)
        handleSwipeRight: function() {
          // Check if there's a back button in the page
          const backLink = $('.blog-pager-newer-link').attr('href');

          if (backLink) {
            // Show animation
            this.elements.mainContent.animate({
              opacity: 0,
              transform: 'translateX(100px)'
            }, 200, function() {
              // Navigate to the previous page
              window.location.href = backLink;
            });
          } else if (window.history.length &gt; 1) {
            // Go back in browser history
            window.history.back();
          }
        },

        // Handle swipe left (go forward)
        handleSwipeLeft: function() {
          // Check if there's a forward button in the page
          const forwardLink = $('.blog-pager-older-link').attr('href');

          if (forwardLink) {
            // Show animation
            this.elements.mainContent.animate({
              opacity: 0,
              transform: 'translateX(-100px)'
            }, 200, function() {
              // Navigate to the next page
              window.location.href = forwardLink;
            });
          } else if (window.history.length &gt; 1) {
            // Try to go forward in browser history
            window.history.forward();
          }
        },

        // Handle double tap
        handleDoubleTap: function(e) {
          // Check if double tap was on an image
          const $target = $(e.target);

          if ($target.is('img') || $target.closest('img').length) {
            // Toggle zoom on the image
            const $img = $target.is('img') ? $target : $target.closest('img');

            if ($img.hasClass('zoomed')) {
              // Zoom out
              $img.removeClass('zoomed');
              $img.css('transform', '');
            } else {
              // Zoom in
              $img.addClass('zoomed');
              $img.css('transform', 'scale(1.5)');

              // Add transition for smooth zoom
              $img.css('transition', 'transform 0.3s ease');
            }
          }
        },

        // Handle long press
        handleLongPress: function(e) {
          const $target = $(e.target);

          // Check if long press was on an image
          if ($target.is('img') || $target.closest('img').length) {
            const $img = $target.is('img') ? $target : $target.closest('img');

            // Create context menu for the image
            this.showImageContextMenu($img);
          }
        },

        // Show context menu for images
        showImageContextMenu: function($img) {
          // Remove any existing context menus
          $('.context-menu').remove();

          // Create context menu
          const $menu = $('<div class="context-menu"></div>');

          // Add menu items
          $menu.append('<div class="context-menu-item" data-action="save">Save Image</div>');
          $menu.append('<div class="context-menu-item" data-action="share">Share Image</div>');
          $menu.append('<div class="context-menu-item" data-action="cancel">Cancel</div>');

          // Position menu near the image
          $menu.css({
            top: $img.offset().top + $img.height() / 2,
            left: $img.offset().left + $img.width() / 2
          });

          // Add to body
          $('body').append($menu);

          // Show menu with animation
          setTimeout(() => {
            $menu.addClass('active');
          }, 10);

          // Handle menu item clicks
          $menu.on('click', '.context-menu-item', function() {
            const action = $(this).data('action');

            if (action === 'save') {
              // Create a link to download the image
              const link = document.createElement('a');
              link.href = $img.attr('src');
              link.download = 'kanahola-image.jpg';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } else if (action === 'share') {
              // Use Web Share API if available
              if (navigator.share) {
                navigator.share({
                  title: 'Kanahola Magazine Image',
                  text: 'Check out this image from Kanahola Magazine',
                  url: $img.attr('src')
                });
              } else {
                // Fallback - copy image URL
                navigator.clipboard.writeText($img.attr('src'))
                  .then(() => {
                    alert('Image URL copied to clipboard');
                  });
              }
            }

            // Remove menu
            $menu.removeClass('active');
            setTimeout(() => {
              $menu.remove();
            }, 300);
          });

          // Close menu when clicking outside
          $(document).on('click touchstart', function closeMenu(e) {
            if (!$(e.target).closest('.context-menu').length) {
              $menu.removeClass('active');
              setTimeout(() => {
                $menu.remove();
              }, 300);
              $(document).off('click touchstart', closeMenu);
            }
          });
        },

        // Trigger refresh action
        triggerRefresh: function() {
          // Show refreshing state
          this.state.isRefreshing = true;
          this.elements.pullToRefreshIndicator.addClass('refreshing');
          this.elements.pullToRefreshIndicator.css('transform', 'translateY(0)');
          this.elements.pullToRefreshIndicator.find('span').text('Refreshing...');

          // Refresh the page after a short delay
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        },

        // Reset pull-to-refresh indicator
        resetPullToRefresh: function() {
          this.elements.pullToRefreshIndicator.css('transform', 'translateY(-100%)');
          this.state.pullDistance = 0;
        }
      };

      // Initialize when DOM is ready
      $(document).ready(function() {
        // Initialize mobile gestures
        MobileGestures.init();
      });

    })(jQuery);
  </script>

  <!-- DNS prefetching for secondary resources -->
  <link rel='dns-prefetch' href='https://fonts.googleapis.com' />
  <link rel='dns-prefetch' href='https://www.google-analytics.com' />
  <link rel='dns-prefetch' href='https://www.googletagmanager.com' />
  <link rel='dns-prefetch' href='https://ajax.googleapis.com' />

  <!-- Preload critical resources with priority hints -->
  <link rel='preload' href='https://code.jquery.com/jquery-3.6.0.min.js' as='script' fetchpriority='high' />
  <link rel='preload' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css' as='style' fetchpriority='low' />
  <link rel='preload' href='https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css' as='style' fetchpriority='low' />

  <!-- Preload critical font files to prevent layout shifts -->
  <link rel='preload' href='https://fonts.gstatic.com/s/playfairdisplay/v30/nuFvD-vYSZviVYUb_rj3ij__anPXJzDwcbmjWBN2PKdFvXDXbtXK-F2qC0s.woff' as='font' type='font/woff' crossorigin='anonymous' />
  <link rel='preload' href='https://fonts.gstatic.com/s/sourcesanspro/v22/6xK3dSBYKcSV-LCoeQqfX1RYOo3qOK7j.woff' as='font' type='font/woff' crossorigin='anonymous' />

  <!-- Enhanced SEO Meta Tags - Optimized for Blogger -->
  <meta expr:content='data:blog.metaDescription ? data:blog.metaDescription : data:blog.pageName' name='description' />

  <!-- Dynamic keywords based on page type -->
  <b:if cond='data:blog.pageType == "item"'>
    <b:if cond='data:post.labels'>
      <meta expr:content='data:post.labels map (label => label.name) join ", "' name='keywords' />
    <b:else/>
      <meta expr:content='data:blog.pageName' name='keywords' />
    </b:if>
  <b:else/>
    <meta expr:content='data:blog.pageName' name='keywords' />
  </b:if>

  <!-- Robots and indexing directives -->
  <meta content='index, follow' name='robots' />
  <meta content='max-image-preview:large' name='robots' /> <!-- Enhanced image previews in search results -->
  <meta content='7 days' name='revisit-after' />

  <!-- Canonical URL with pagination handling -->
  <b:if cond='data:blog.url == data:blog.homepageUrl'>
    <link expr:href='data:blog.homepageUrl' rel='canonical' />
  <b:elseif cond='data:blog.pageType == "item"'/>
    <link expr:href='data:blog.canonicalUrl' rel='canonical' />
  <b:else/>
    <link expr:href='data:blog.url.canonical' rel='canonical' />
  </b:if>

  <!-- Pagination links for SEO -->
  <b:if cond='data:blog.pageType == "index"'>
    <b:if cond='data:blog.url.previousPageUrl'>
      <link expr:href='data:blog.url.previousPageUrl' rel='prev' />
    </b:if>
    <b:if cond='data:blog.url.nextPageUrl'>
      <link expr:href='data:blog.url.nextPageUrl' rel='next' />
    </b:if>
  </b:if>

  <!-- Author and language metadata -->
  <b:if cond='data:blog.pageType == "item" and data:post.author'>
    <meta expr:content='data:post.author.name' name='author' />
  <b:else/>
    <meta content='Kanahola Magazine' name='author' />
  </b:if>
  <meta content='en_US' name='language' />
  <meta content='English' name='language' />

  <!-- Mobile and theme metadata -->
  <meta content='#4a90e2' name='theme-color' />
  <meta content='true' name='HandheldFriendly' />
  <meta content='width' name='MobileOptimized' />

  <!-- Enhanced Open Graph Tags - Consolidated and optimized -->
  <!-- Basic OG tags for all pages -->
  <meta expr:content='data:blog.pageTitle' property='og:title' />
  <meta expr:content='data:blog.canonicalUrl' property='og:url' />
  <meta expr:content='data:blog.title' property='og:site_name' />
  <meta expr:content='data:blog.metaDescription ? data:blog.metaDescription : data:blog.pageName' property='og:description' />
  <meta content='en_US' property='og:locale' />

  <!-- Page type specific Open Graph tags -->
  <b:if cond='data:blog.pageType == "item"'>
    <meta content='article' property='og:type' />

    <!-- Article specific metadata -->
    <b:if cond='data:post.author'>
      <meta expr:content='data:post.author.name' property='article:author' />
    </b:if>
    <b:if cond='data:post.date'>
      <meta expr:content='data:post.date.iso8601' property='article:published_time' />
    </b:if>
    <b:if cond='data:post.lastUpdated'>
      <meta expr:content='data:post.lastUpdated.iso8601' property='article:modified_time' />
    </b:if>
    <b:if cond='data:post.labels'>
      <b:loop values='data:post.labels' var='label'>
        <meta expr:content='data:label.name' property='article:tag' />
      </b:loop>
      <meta expr:content='data:post.labels[0].name' property='article:section' />
    </b:if>
  <b:else/>
    <meta content='website' property='og:type' />
  </b:if>

  <!-- Primary image selection with robust fallbacks -->
  <b:if cond='data:blog.postImageUrl'>
    <meta expr:content='data:blog.postImageUrl' property='og:image' />
  <b:elseif cond='data:post.featuredImage'/>
    <meta expr:content='data:post.featuredImage' property='og:image' />
  <b:elseif cond='data:post.firstImageUrl'/>
    <meta expr:content='data:post.firstImageUrl' property='og:image' />
  <b:elseif cond='data:blog.logoUrl'/>
    <meta expr:content='data:blog.logoUrl' property='og:image' />
  <b:else/>
    <meta content='https://kanaholamagazine.com/logo.png' property='og:image' />
  </b:if>

  <!-- Image dimensions for better sharing -->
  <meta content='1200' property='og:image:width' />
  <meta content='630' property='og:image:height' />

  <!-- Twitter Card Tags - Optimized and consolidated -->
  <meta content='summary_large_image' name='twitter:card' />
  <meta expr:content='data:blog.pageTitle' name='twitter:title' />
  <meta expr:content='data:blog.metaDescription ? data:blog.metaDescription : data:blog.pageName' name='twitter:description' />
  <meta content='@kanahola' name='twitter:site' />

  <!-- Twitter image with same robust fallbacks as OG -->
  <b:if cond='data:blog.postImageUrl'>
    <meta expr:content='data:blog.postImageUrl' name='twitter:image' />
  <b:elseif cond='data:post.featuredImage'/>
    <meta expr:content='data:post.featuredImage' name='twitter:image' />
  <b:elseif cond='data:post.firstImageUrl'/>
    <meta expr:content='data:post.firstImageUrl' name='twitter:image' />
  <b:elseif cond='data:blog.logoUrl'/>
    <meta expr:content='data:blog.logoUrl' name='twitter:image' />
  <b:else/>
    <meta content='https://kanaholamagazine.com/logo.png' name='twitter:image' />
  </b:if>

  <!-- Twitter author for posts -->
  <b:if cond='data:blog.pageType == "item" and data:post.author'>
    <meta expr:content='&quot;@&quot; &amp;+ data:post.author.name' name='twitter:creator' />
  </b:if>

  <!-- Additional Twitter metadata -->
  <meta content='Kanahola Magazine' name='twitter:domain' />
  <meta expr:content='data:blog.canonicalUrl' name='twitter:url' />

  <!-- Core Schema.org structured data - Optimized for Blogger -->
  <!-- BlogPosting Schema for Posts/Articles -->
  <b:if cond='data:blog.pageType == "item"'>
  <script type='application/ld+json'>
  {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": <b:eval expr='data:blog.pageTitle.json'/>,
    "description": <b:eval expr='data:blog.metaDescription ? data:blog.metaDescription.json : data:blog.pageName.json'/>,
    "image": [
      <b:if cond='data:blog.postImageUrl'><b:eval expr='data:blog.postImageUrl.json'/></b:if>
      <b:elseif cond='data:post.featuredImage'/><b:eval expr='data:post.featuredImage.json'/></b:elseif>
      <b:elseif cond='data:post.firstImageUrl'/><b:eval expr='data:post.firstImageUrl.json'/></b:elseif>
      <b:else/><b:eval expr='data:blog.logoUrl ? data:blog.logoUrl.json : "https://kanaholamagazine.com/logo.png".json'/></b:else>
    ],
    "datePublished": <b:if cond='data:post.date'><b:eval expr='data:post.date.iso8601.json'/></b:if>,
    "dateModified": <b:if cond='data:post.lastUpdated'><b:eval expr='data:post.lastUpdated.iso8601.json'/></b:if><b:else/><b:if cond='data:post.date'><b:eval expr='data:post.date.iso8601.json'/></b:if></b:else>,
    "author": {
      "@type": "Person",
      "name": <b:if cond='data:post.author'><b:eval expr='data:post.author.name.json'/></b:if><b:else/>"Kanahola Magazine"</b:else>,
      "url": <b:if cond='data:post.author.profileUrl'><b:eval expr='data:post.author.profileUrl.json'/></b:if><b:else/><b:eval expr='(data:blog.homepageUrl + "p/about.html").json'/></b:else>
    },
    "publisher": {
      "@type": "Organization",
      "name": "Kanahola Magazine",
      "logo": {
        "@type": "ImageObject",
        "url": <b:eval expr='data:blog.logoUrl ? data:blog.logoUrl.json : "https://kanaholamagazine.com/logo.png".json'/>,
        "width": 600,
        "height": 60
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": <b:eval expr='data:blog.canonicalUrl.json'/>
    },
    "keywords": <b:if cond='data:post.labels'>"<b:loop values='data:post.labels' var='label'><b:eval expr='data:label.name'/><b:if cond='not data:label.isLast'>, </b:if></b:loop>"</b:if><b:else/>""</b:else>,
    "articleSection": <b:if cond='data:post.labels'><b:loop values='data:post.labels' var='label'><b:if cond='data:label.isFirst'><b:eval expr='data:label.name.json'/></b:if></b:loop></b:if><b:else/>"Blog"</b:else>,
    "wordCount": <b:eval expr='(data:post.body.length / 5).json'/>,
    "commentCount": <b:eval expr='data:post.numComments ? data:post.numComments.json : 0'/>,
    "inLanguage": "en-US",
    "isAccessibleForFree": true
  }
  </script>

  <!-- BreadcrumbList Schema for Posts -->
  <script type='application/ld+json'>
  {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": <b:eval expr='data:blog.homepageUrl.json'/>
      },
      <b:if cond='data:post.labels'>
      <b:loop values='data:post.labels' var='label'>
      <b:if cond='data:label.isFirst'>
      {
        "@type": "ListItem",
        "position": 2,
        "name": <b:eval expr='data:label.name.json'/>,
        "item": <b:eval expr='(data:blog.homepageUrl + "search/label/" + data:label.name).json'/>
      },
      </b:if>
      </b:loop>
      </b:if>
      {
        "@type": "ListItem",
        "position": 3,
        "name": <b:eval expr='data:blog.pageTitle.json'/>,
        "item": <b:eval expr='data:blog.canonicalUrl.json'/>
      }
    ]
  }
  </script>

  <!-- WebSite Schema for non-post pages -->
  <b:else/>
  <script type='application/ld+json'>
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": <b:eval expr='data:blog.title.json'/>,
    "url": <b:eval expr='data:blog.homepageUrl.json'/>,
    "description": <b:eval expr='data:blog.metaDescription ? data:blog.metaDescription.json : data:blog.title.json'/>,
    "publisher": {
      "@type": "Organization",
      "name": "Kanahola Magazine",
      "logo": {
        "@type": "ImageObject",
        "url": <b:eval expr='data:blog.logoUrl ? data:blog.logoUrl.json : "https://kanaholamagazine.com/logo.png".json'/>,
        "width": 600,
        "height": 60
      }
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": <b:eval expr='(data:blog.homepageUrl + "search?q={search_term_string}").json'/>,
      "query-input": "required name=search_term_string"
    },
    "inLanguage": "en-US"
  }
  </script>
  </b:if>

  <!-- Organization Schema - Always included -->
  <script type='application/ld+json'>
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Kanahola Magazine",
    "url": <b:eval expr='data:blog.homepageUrl.json'/>,
    "logo": {
      "@type": "ImageObject",
      "url": <b:eval expr='data:blog.logoUrl ? data:blog.logoUrl.json : "https://kanaholamagazine.com/logo.png".json'/>,
      "width": 600,
      "height": 60
    },
    "sameAs": [
      "https://facebook.com/kanaholamagazine",
      "https://twitter.com/kanahola",
      "https://instagram.com/kanaholamagazine",
      "https://pinterest.com/kanaholamagazine"
    ]
  }
  </script>

  <!-- Recipe Schema - Dynamically populated via CSS selectors -->
  <b:if cond='data:blog.pageType == "item"'>
  <b:if cond='data:view.isPost'>
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check if post contains recipe elements
    if (document.querySelector('.recipe-container, .recipe-ingredients, .recipe-instructions, .recipe-card')) {
      try {
        // Extract recipe data
        const recipeTitle = document.querySelector('.recipe-title')?.textContent.trim() || document.querySelector('h1')?.textContent.trim() || document.title;
        const recipeDescription = document.querySelector('.recipe-description')?.textContent.trim() || document.querySelector('meta[name="description"]')?.getAttribute('content') || '';
        const recipeImage = document.querySelector('.recipe-image')?.getAttribute('src') || document.querySelector('.post img')?.getAttribute('src') || '';
        const recipeAuthor = document.querySelector('.recipe-author')?.textContent.trim() || document.querySelector('.post-author')?.textContent.trim() || 'Kanahola Magazine';
        const recipeDate = document.querySelector('.recipe-date, .post-date')?.getAttribute('datetime') || new Date().toISOString();

        // Extract ingredients
        const ingredients = [];
        document.querySelectorAll('.recipe-ingredients li, .ingredients li').forEach(item => {
          ingredients.push(item.textContent.trim());
        });

        // Extract instructions
        const instructions = [];
        document.querySelectorAll('.recipe-instructions li, .recipe-steps li, .instructions li, .steps li').forEach((item, index) => {
          instructions.push({
            "@type": "HowToStep",
            "position": index + 1,
            "text": item.textContent.trim()
          });
        });

        // Create recipe schema
        const recipeSchema = {
          "@context": "https://schema.org",
          "@type": "Recipe",
          "name": recipeTitle,
          "image": recipeImage,
          "author": {
            "@type": "Person",
            "name": recipeAuthor
          },
          "datePublished": recipeDate,
          "description": recipeDescription,
          "recipeIngredient": ingredients,
          "recipeInstructions": instructions
        };

        // Add optional fields if available
        const prepTime = document.querySelector('.prep-time')?.textContent.trim();
        if (prepTime) recipeSchema.prepTime = prepTime;

        const cookTime = document.querySelector('.cook-time')?.textContent.trim();
        if (cookTime) recipeSchema.cookTime = cookTime;

        const totalTime = document.querySelector('.total-time')?.textContent.trim();
        if (totalTime) recipeSchema.totalTime = totalTime;

        const recipeYield = document.querySelector('.recipe-yield, .servings')?.textContent.trim();
        if (recipeYield) recipeSchema.recipeYield = recipeYield;

        // Add schema to page
        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.textContent = JSON.stringify(recipeSchema);
        document.head.appendChild(script);
      } catch (e) {
        console.error('Error creating recipe schema:', e);
      }
    }

    // Check for FAQ content
    if (document.querySelector('.faq-container, .faq-item, .faq-question, .faq-answer')) {
      try {
        const faqItems = [];
        document.querySelectorAll('.faq-item, .faq-container > div').forEach(item => {
          const question = item.querySelector('.faq-question, h3, h4, strong')?.textContent.trim();
          const answer = item.querySelector('.faq-answer, p')?.textContent.trim();

          if (question && answer) {
            faqItems.push({
              "@type": "Question",
              "name": question,
              "acceptedAnswer": {
                "@type": "Answer",
                "text": answer
              }
            });
          }
        });

        if (faqItems.length > 0) {
          const faqSchema = {
            "@context": "https://schema.org",
            "@type": "FAQPage",
            "mainEntity": faqItems
          };

          const script = document.createElement('script');
          script.type = 'application/ld+json';
          script.textContent = JSON.stringify(faqSchema);
          document.head.appendChild(script);
        }
      } catch (e) {
        console.error('Error creating FAQ schema:', e);
      }
    }

    // Check for HowTo content
    if (document.querySelector('.howto-container, .howto-steps, .step-by-step, .tutorial')) {
      try {
        const howtoTitle = document.querySelector('.howto-title')?.textContent.trim() || document.querySelector('h1')?.textContent.trim() || document.title;
        const howtoDescription = document.querySelector('.howto-description')?.textContent.trim() || document.querySelector('meta[name="description"]')?.getAttribute('content') || '';
        const howtoImage = document.querySelector('.howto-image')?.getAttribute('src') || document.querySelector('.post img')?.getAttribute('src') || '';

        const steps = [];
        document.querySelectorAll('.howto-step, .step-by-step li, .tutorial-steps li').forEach((item, index) => {
          steps.push({
            "@type": "HowToStep",
            "position": index + 1,
            "text": item.textContent.trim(),
            "image": item.querySelector('img')?.getAttribute('src') || ''
          });
        });

        if (steps.length > 0) {
          const howtoSchema = {
            "@context": "https://schema.org",
            "@type": "HowTo",
            "name": howtoTitle,
            "description": howtoDescription,
            "image": howtoImage,
            "step": steps
          };

          const script = document.createElement('script');
          script.type = 'application/ld+json';
          script.textContent = JSON.stringify(howtoSchema);
          document.head.appendChild(script);
        }
      } catch (e) {
        console.error('Error creating HowTo schema:', e);
      }
    }

    // Check for Review content
    if (document.querySelector('.review-container, .product-review, .rating-stars')) {
      try {
        const reviewTitle = document.querySelector('.review-title')?.textContent.trim() || document.querySelector('h1')?.textContent.trim() || document.title;
        const reviewBody = document.querySelector('.review-content, .review-text')?.textContent.trim() || '';
        const reviewAuthor = document.querySelector('.review-author, .post-author')?.textContent.trim() || 'Kanahola Magazine';
        const reviewDate = document.querySelector('.review-date, .post-date')?.getAttribute('datetime') || new Date().toISOString();

        // Extract rating
        let ratingValue = 5;
        const ratingText = document.querySelector('.rating-value')?.textContent.trim();
        if (ratingText) {
          const ratingMatch = ratingText.match(/(\d+(\.\d+)?)/);
          if (ratingMatch) {
            ratingValue = parseFloat(ratingMatch[1]);
          }
        }

        // Extract product details
        const productName = document.querySelector('.product-name')?.textContent.trim() || reviewTitle.replace('Review:', '').trim();
        const productImage = document.querySelector('.product-image')?.getAttribute('src') || document.querySelector('.post img')?.getAttribute('src') || '';
        const productDescription = document.querySelector('.product-description')?.textContent.trim() || '';
        const brandName = document.querySelector('.brand-name')?.textContent.trim() || '';

        const reviewSchema = {
          "@context": "https://schema.org",
          "@type": "Review",
          "name": reviewTitle,
          "reviewBody": reviewBody,
          "author": {
            "@type": "Person",
            "name": reviewAuthor
          },
          "datePublished": reviewDate,
          "reviewRating": {
            "@type": "Rating",
            "ratingValue": ratingValue,
            "bestRating": "5",
            "worstRating": "1"
          },
          "itemReviewed": {
            "@type": "Product",
            "name": productName,
            "image": productImage,
            "description": productDescription
          }
        };

        // Add brand if available
        if (brandName) {
          reviewSchema.itemReviewed.brand = {
            "@type": "Brand",
            "name": brandName
          };
        }

        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.textContent = JSON.stringify(reviewSchema);
        document.head.appendChild(script);
      } catch (e) {
        console.error('Error creating Review schema:', e);
      }
    }
  });
  </script>
  </b:if>
  </b:if>

  <!-- Theme CSS Style -->
  <b:skin><![CDATA[
    /*!***************************************************************
     * Theme Name          : Kanahola Magazine
     * Theme Version       : 1.0.0
     * Theme Description   : Lifestyle, Travel, Food, and Culture Magazine Blogger Theme
     ****************************************************************/

    /*
    <!--  Variable Definitions -->
    <Group description="Colors">
    <Variable name="primary.color" description="Primary Color" type="color" default="#e63946" value="#e63946"/>
    <Variable name="secondary.color" description="Secondary Color" type="color" default="#1d3557" value="#1d3557"/>
    <Variable name="text.color" description="Text Color" type="color" default="#333333" value="#333333"/>
    <Variable name="light.text" description="Light Text Color" type="color" default="#f1faee" value="#f1faee"/>
    <Variable name="background.color" description="Background Color" type="color" default="#ffffff" value="#ffffff"/>
    <Variable name="light.gray" description="Light Gray" type="color" default="#f8f9fa" value="#f8f9fa"/>
    <Variable name="medium.gray" description="Medium Gray" type="color" default="#e9ecef" value="#e9ecef"/>
    <Variable name="dark.gray" description="Dark Gray" type="color" default="#6c757d" value="#6c757d"/>
    <Variable name="border.color" description="Border Color" type="color" default="#dee2e6" value="#dee2e6"/>
    </Group>

    <Group description="Typography">
    <Variable name="heading.font" description="Heading Font" type="font" default="normal normal 700 1em 'Playfair Display', serif" value="normal normal 700 1em 'Playfair Display', serif"/>
    <Variable name="body.font" description="Body Font" type="font" default="normal normal 400 1em 'Source Sans Pro', sans-serif" value="normal normal 400 1em 'Source Sans Pro', sans-serif"/>
    </Group>

    <Group description="Layout">
    <Variable name="container.width" description="Container Width" type="length" default="1200px" min="800px" max="1400px" value="1200px"/>
    <Variable name="border.radius" description="Border Radius" type="length" default="8px" min="0px" max="20px" value="8px"/>
    </Group>

    <Group description="Dark Mode">
    <Variable name="dark.background" description="Dark Background" type="color" default="#121212" value="#121212"/>
    <Variable name="dark.text" description="Dark Mode Text" type="color" default="#e7e7e7" value="#e7e7e7"/>
    <Variable name="dark.card.bg" description="Dark Card Background" type="color" default="#1e1e1e" value="#1e1e1e"/>
    <Variable name="dark.border" description="Dark Border" type="color" default="#2d2d2d" value="#2d2d2d"/>
    <Variable name="dark.primary" description="Dark Primary Color" type="color" default="#f48c8c" value="#f48c8c"/>
    <Variable name="dark.secondary" description="Dark Secondary Color" type="color" default="#4a78b3" value="#4a78b3"/>
    <Variable name="dark.light.gray" description="Dark Light Gray" type="color" default="#2d2d2d" value="#2d2d2d"/>
    <Variable name="dark.medium.gray" description="Dark Medium Gray" type="color" default="#444444" value="#444444"/>
    <Variable name="dark.light.text" description="Dark Light Text" type="color" default="#cccccc" value="#cccccc"/>
    <Variable name="dark.medium.text" description="Dark Medium Text" type="color" default="#999999" value="#999999"/>
    </Group>
    */

    /* CSS Reset and Base Styles */
    /* CSS Reset */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* Theme Properties */
    :root {
      /* Colors */
      --primary-color: $(primary.color);
      --secondary-color: $(secondary.color);
      --text-color: $(text.color);
      --light-text: $(light.text);
      --background-color: $(background.color);
      --light-gray: $(light.gray);
      --medium-gray: $(medium.gray);
      --dark-gray: $(dark.gray);
      --border-color: $(border.color);

      /* Typography */
      --heading-font: $(heading.font);
      --body-font: $(body.font);

      /* Layout */
      --container-width: $(container.width);
      --border-radius: $(border.radius);

      /* Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2.5rem;
    }
    body { font-family: var(--body-font); color: var(--text-color); line-height: 1.6; background-color: var(--background-color); }
    h1, h2, h3, h4, h5, h6 { font-family: var(--heading-font); font-weight: 700; line-height: 1.2; margin-bottom: var(--spacing-md); }
    a { color: var(--secondary-color); text-decoration: none; transition: color 0.3s ease; }
    a:hover { color: var(--primary-color); }
    img { max-width: 100%; height: auto; display: block; }
    .container { max-width: var(--container-width); margin: 0 auto; padding: 0 var(--spacing-md); }
    .header { padding: var(--spacing-lg) 0; border-bottom: 1px solid var(--border-color); }
    .header-inner { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-family: var(--heading-font); font-size: 2rem; font-weight: 900; color: var(--secondary-color); }
    .logo a { color: inherit; }
    .nav-menu { display: flex; list-style: none; gap: var(--spacing-lg); }
    .nav-menu li a { font-weight: 600; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
    .mobile-menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary-color); }
    .content-wrapper { display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-xl); padding: var(--spacing-xl) 0; }
    .featured-section { margin-bottom: var(--spacing-xl); }
    .featured-post { position: relative; border-radius: 8px; overflow: hidden; margin-bottom: var(--spacing-lg); }
    .featured-image { height: 400px; object-fit: cover; width: 100%; }
    .featured-content { position: absolute; bottom: 0; left: 0; right: 0; padding: var(--spacing-lg); background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: var(--light-text); }
    .featured-title { font-size: 2rem; margin-bottom: var(--spacing-sm); }
    .featured-excerpt { margin-bottom: var(--spacing-md); }
    .post-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--spacing-lg); }
    .post-card { border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.3s ease; background-color: var(--background-color); }
    .post-thumbnail { height: 180px; object-fit: cover; }
    .post-content { padding: var(--spacing-md); }
    .post-title { font-size: 1.25rem; margin-bottom: var(--spacing-sm); }
    .post-meta { color: var(--dark-gray); font-size: 0.85rem; margin-bottom: var(--spacing-sm); }
    .post-excerpt { font-size: 0.9rem; margin-bottom: var(--spacing-md); }
    .read-more { font-weight: 600; color: var(--primary-color); }

    /* Responsive styles for critical content */
    @media (max-width: 992px) {
      .content-wrapper { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .mobile-menu-toggle { display: block; }
      .nav-menu { display: none; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--background-color); flex-direction: column; padding: var(--spacing-md); box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; }
      .nav-menu.active { display: flex; }
      .featured-image { height: 300px; }
      .featured-title { font-size: 1.5rem; }
    }
    @media (max-width: 576px) {
      .post-grid { grid-template-columns: 1fr; }
      .featured-image { height: 250px; }
    }

    /* Loading indicator styles */
    .page-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loader-spinner { width: 50px; height: 50px; border: 5px solid var(--medium-gray); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* PWA Update Notification */
    .update-notification { position: fixed; bottom: -100px; left: 0; right: 0; background-color: var(--secondary-color); color: white; padding: 15px; text-align: center; z-index: 9999; transition: bottom 0.3s ease; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
    .update-notification.active { bottom: 0; }
    .update-notification-content { display: flex; justify-content: center; align-items: center; gap: 15px; }
    .update-notification p { margin: 0; }
    .update-notification button { background-color: white; color: var(--secondary-color); border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

    /* Mobile Gesture Styles */
    .pull-to-refresh-indicator { position: absolute; top: 0; left: 0; width: 100%; height: 60px; display: flex; align-items: center; justify-content: center; background-color: var(--light-gray); transform: translateY(-100%); z-index: 1000; transition: transform 0.2s ease; }
    .pull-to-refresh-spinner { width: 24px; height: 24px; border: 3px solid rgba(74, 144, 226, 0.3); border-top-color: var(--primary-color); border-radius: 50%; margin-right: 10px; }
    .pull-to-refresh-indicator.refreshing .pull-to-refresh-spinner { animation: spin 1s infinite linear; }
    .swipe-indicator { position: fixed; top: 50%; width: 40px; height: 40px; background-color: rgba(0, 0, 0, 0.5); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: translateY(-50%) scale(0); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; z-index: 1000; }
    .swipe-indicator-left { left: 15px; }
    .swipe-indicator-right { right: 15px; }
    .swipe-indicator.active { transform: translateY(-50%) scale(1); opacity: 1; }

    /* Context Menu for Images */
    .context-menu { position: fixed; background-color: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; transform: scale(0.8); opacity: 0; transition: transform 0.2s ease, opacity 0.2s ease; }
    .context-menu.active { transform: scale(1); opacity: 1; }
    .context-menu-item { padding: 12px 20px; cursor: pointer; white-space: nowrap; }
    .context-menu-item:hover { background-color: var(--light-gray); }
    .context-menu-item:first-child { border-radius: 8px 8px 0 0; }
    .context-menu-item:last-child { border-radius: 0 0 8px 8px; }

    /* Image Zoom Styles */
    img.zoomed { position: relative; z-index: 100; }

    /* Offline Status Indicator */
    .offline-status { position: fixed; top: -50px; left: 0; right: 0; background-color: #ff9800; color: white; padding: 10px; text-align: center; z-index: 9999; transition: top 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .offline-status.active { top: 0; }
    .offline-status-content { display: flex; justify-content: center; align-items: center; gap: 10px; }
    .offline-status i { font-size: 1.2rem; }

    /* Notification Styles */
    .notification { position: fixed; top: 20px; right: -300px; background-color: var(--secondary-color); color: white; padding: 15px 20px; border-radius: 4px; z-index: 9999; transition: right 0.3s ease; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 300px; }
    .notification.active { right: 20px; }
    .notification-content { display: flex; align-items: center; }

    /* Amazon Sponsored Products Widget Styles */
    .amazon-products-widget {
      margin: var(--spacing-lg) 0;
      padding: var(--spacing-md);
      border-radius: 8px;
      background-color: var(--background-color);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }

    .amazon-products-widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .amazon-products-widget-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
    }

    .amazon-products-sponsored-label {
      font-size: 0.75rem;
      color: var(--dark-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 6px;
      border-radius: 3px;
      background-color: var(--light-gray);
    }

    .amazon-products-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: var(--spacing-md);
    }

    .amazon-product-card {
      display: flex;
      flex-direction: column;
      border-radius: 6px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      height: 100%;
      background-color: var(--background-color);
    }

    .amazon-product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .amazon-product-image-container {
      position: relative;
      padding-top: 100%; /* 1:1 Aspect Ratio */
      background-color: var(--light-gray);
    }

    .amazon-product-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: var(--spacing-xs);
    }

    .amazon-product-content {
      padding: var(--spacing-sm);
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .amazon-product-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      color: var(--text-color);
    }

    .amazon-product-price {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--spacing-xs);
    }

    .amazon-product-rating {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-xs);
    }

    .amazon-product-stars {
      color: #FFB900;
      font-size: 0.8rem;
      margin-right: 4px;
    }

    .amazon-product-reviews {
      font-size: 0.75rem;
      color: var(--dark-gray);
    }

    .amazon-product-prime {
      font-size: 0.7rem;
      color: #00A8E1;
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      display: flex;
      align-items: center;
    }

    .amazon-product-prime i {
      margin-right: 3px;
    }

    .amazon-product-button {
      margin-top: auto;
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: #FFD814;
      color: #0F1111;
      border: none;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: background-color 0.2s ease;
      text-decoration: none;
      display: block;
    }

    .amazon-product-button:hover {
      background-color: #F7CA00;
      color: #0F1111;
    }

    /* Responsive styles for Amazon widget */
    @media (max-width: 768px) {
      .amazon-products-container {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    }

    @media (max-width: 480px) {
      .amazon-products-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Dark Mode Styles */
    /* Dark mode theme variables */
    html.dark {
      --primary-color: $(dark.primary);
      --secondary-color: $(dark.secondary);
      --text-color: $(dark.text);
      --background-color: $(dark.background);
      --light-gray: $(dark.light.gray);
      --medium-gray: $(dark.medium.gray);
      --dark-gray: $(dark.medium.text);
      --border-color: $(dark.border);
      --card-bg: $(dark.card.bg);
      --light-text: $(dark.light.text);
    }

    /* Dark mode styles for Amazon widget */
    html.dark .amazon-products-widget {
      background-color: var(--card-bg);
      border-color: var(--border-color);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    html.dark .amazon-products-widget-title {
      color: var(--text-color);
    }

    html.dark .amazon-products-sponsored-label {
      background-color: var(--medium-gray);
      color: var(--light-text);
    }

    html.dark .amazon-product-card {
      background-color: var(--card-bg);
    }

    html.dark .amazon-product-image-container {
      background-color: var(--light-gray);
    }

    html.dark .amazon-product-title {
      color: var(--text-color);
    }

    html.dark .amazon-product-price {
      color: var(--primary-color);
    }

    html.dark .amazon-product-reviews {
      color: var(--dark-gray);
    }

    html.dark .amazon-product-button {
      background-color: var(--primary-color);
      color: var(--background-color);
    }

    html.dark .amazon-product-button:hover {
      background-color: var(--secondary-color);
    }

    /* Typography Styles */
    /* Font styles are managed through Blogger's variable system */
    /* The actual font loading is handled by Blogger's built-in mechanisms */

    /* Base Typography */
    body {
      font-family: var(--body-font);
      color: var(--text-color);
      line-height: 1.6;
      background-color: var(--background-color);
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: var(--heading-font);
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: var(--spacing-md);
      color: var(--text-color);
    }

    h1 { font-size: 2.5rem; }
    h2 { font-size: 2rem; }
    h3 { font-size: 1.75rem; }
    h4 { font-size: 1.5rem; }
    h5 { font-size: 1.25rem; }
    h6 { font-size: 1rem; }

    p {
      margin-bottom: var(--spacing-md);
    }

    strong, b {
      font-weight: 700;
    }

    em, i {
      font-style: italic;
    }
  ]]></b:skin>

  <!-- Enhanced font loading strategy -->
  <!-- Load fonts asynchronously with font-display strategy -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&amp;family=Source+Sans+Pro:wght@400;600;700&amp;display=swap&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&amp;family=Source+Sans+Pro:wght@400;600;700&amp;display=swap&amp;display=swap" /></noscript>

  <!-- Amazon Advertising API - Load asynchronously with fallback -->
  <script>
    // Function to load Amazon ads with error handling
    function loadAmazonAds() {
      try {
        // Create script element
        const script = document.createElement('script');
        script.async = true;
        script.src = '//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&amp;adInstanceId=YOUR_AD_INSTANCE_ID';

        // Add error handling
        script.onerror = function() {
          console.log('Amazon ads failed to load, using fallback content');
          // Replace ad containers with fallback content
          document.querySelectorAll('.amazon-products-widget').forEach(function(container) {
            container.innerHTML = `
              <div class="amazon-products-widget-header">
                <h3 class="amazon-products-widget-title">Recommended Products</h3>
              </div>
              <p>We have curated some products you might like. Please refresh to see recommendations.</p>
            `;
          });
        };

        // Append to document
        document.head.appendChild(script);
      } catch (e) {
        console.error('Error loading Amazon ads:', e);
      }
    }

    // Load ads when DOM is ready
    document.addEventListener('DOMContentLoaded', loadAmazonAds);
  </script>

  <!-- Font loading optimization script -->
  <script>
    // Font loading optimization
    if ("fonts" in document) {
      // Check if fonts are already available
      Promise.all([
        document.fonts.load("1em 'Playfair Display'"),
        document.fonts.load("1em 'Source Sans Pro'")
      ]).then(() => {
        document.documentElement.classList.add('fonts-loaded');
      }).catch(err => {
        console.warn('Font loading failed:', err);
        // Add fallback class to use system fonts
        document.documentElement.classList.add('fonts-failed');
      });

      // Set timeout to prevent waiting too long for fonts
      setTimeout(() => {
        if (!document.documentElement.classList.contains('fonts-loaded')) {
          document.documentElement.classList.add('fonts-timeout');
        }
      }, 3000);
    }
  </script>

  <!-- Service Worker Registration - Simplified for Blogger Compatibility -->
  <script>
    // Simple service worker registration for Blogger
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Define a simple service worker directly
        const swCode = `
          // Cache version
          const CACHE_NAME = 'kanahola-v1';

          // Resources to cache immediately
          const CORE_ASSETS = [
            '/',
            '/favicon.ico',
            'https://code.jquery.com/jquery-3.6.0.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css'
          ];

          // Install event - cache core assets
          self.addEventListener('install', event => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then(cache => {
                  console.log('[Service Worker] Caching core assets');
                  return cache.addAll(CORE_ASSETS);
                })
                .then(() => self.skipWaiting())
            );
          });

          // Activate event - clean up old caches
          self.addEventListener('activate', event => {
            event.waitUntil(
              caches.keys().then(cacheNames => {
                return Promise.all(
                  cacheNames.map(cacheName => {
                    if (cacheName !== CACHE_NAME) {
                      return caches.delete(cacheName);
                    }
                  })
                );
              }).then(() => self.clients.claim())
            );
          });

          // Fetch event - network first with cache fallback for HTML
          // Cache first with network fallback for assets
          self.addEventListener('fetch', event => {
            // Skip non-GET requests
            if (event.request.method !== 'GET') return;

            // Skip Blogger admin requests
            if (event.request.url.includes('/admin/') ||
                event.request.url.includes('blogger.com')) {
              return;
            }

            const requestURL = new URL(event.request.url);

            // For HTML requests (pages) - Network first, fallback to cache
            if (requestURL.pathname === '/' ||
                requestURL.pathname.endsWith('.html') ||
                requestURL.pathname.includes('/p/') ||
                requestURL.pathname.includes('/search/label/') ||
                !requestURL.pathname.includes('.')) {

              event.respondWith(
                fetch(event.request)
                  .then(response => {
                    // Cache the latest version
                    const responseClone = response.clone();
                    caches.open(CACHE_NAME).then(cache => {
                      cache.put(event.request, responseClone);
                    });
                    return response;
                  })
                  .catch(() => {
                    // If network fails, try the cache
                    return caches.match(event.request)
                      .then(cachedResponse => {
                        if (cachedResponse) {
                          return cachedResponse;
                        }

                        // If not in cache, show offline page
                        return caches.match('/offline.html')
                          .then(offlineResponse => {
                            return offlineResponse || new Response(
                              '<html><head><title>Offline</title></head><body><h1>You are offline</h1><p>Please check your connection.</p></body></html>',
                              { headers: { 'Content-Type': 'text/html' } }
                            );
                          });
                      });
                  })
              );
            }
            // For assets - Cache first, network fallback
            else {
              event.respondWith(
                caches.match(event.request)
                  .then(cachedResponse => {
                    // Return cached response if available
                    if (cachedResponse) {
                      return cachedResponse;
                    }

                    // Otherwise fetch from network
                    return fetch(event.request)
                      .then(response => {
                        // Cache the new response
                        const responseClone = response.clone();
                        caches.open(CACHE_NAME).then(cache => {
                          cache.put(event.request, responseClone);
                        });
                        return response;
                      });
                  })
              );
            }
          });

          // Listen for messages from clients
          self.addEventListener('message', event => {
            if (event.data && event.data.type === 'SKIP_WAITING') {
              self.skipWaiting();
            }
          });
        `;

        // Create a blob from the service worker code
        const blob = new Blob([swCode], {type: 'application/javascript'});
        const swUrl = URL.createObjectURL(blob);

        // Register the service worker
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('Service Worker registered successfully');

            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;

              // When the new service worker is installed
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Show update notification
                  const updateNotification = document.createElement('div');
                  updateNotification.className = 'update-notification';
                  updateNotification.innerHTML = `
                    <div class="update-notification-content">
                      <p>New content is available!</p>
                      <button id="update-app-button">Update Now</button>
                    </div>
                  `;
                  document.body.appendChild(updateNotification);

                  // Show notification with animation
                  setTimeout(() => updateNotification.classList.add('active'), 300);

                  // Update button handler
                  document.getElementById('update-app-button').addEventListener('click', () => {
                    // Tell the service worker to skipWaiting
                    newWorker.postMessage({type: 'SKIP_WAITING'});
                    window.location.reload();
                  });
                }
              });
            });
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });

        // Handle service worker updates
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          if (!refreshing) {
            refreshing = true;
            window.location.reload();
          }
        });
      });
    }
  </script>

  <!-- Main CSS Styles (loaded after critical CSS) -->
  <b:skin><![CDATA[
    /*
    -----------------------------------------------
    Kanahola Magazine Blog - SPA Template
    -----------------------------------------------
    */

    /* Reset and Base Styles - Modified for Blogger compatibility */
    /* Use more specific selectors to avoid conflicts with Blogger's default styles */
    .kanahola-template *,
    .kanahola-template *::before,
    .kanahola-template *::after {
      box-sizing: border-box;
    }

    /* Add Blogger-specific body class via JavaScript */
    /* JavaScript to add kanahola-template class to body for CSS scoping
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('kanahola-template');
    });
    */

    /* Reset only specific elements that we need to control */
    .kanahola-template h1,
    .kanahola-template h2,
    .kanahola-template h3,
    .kanahola-template h4,
    .kanahola-template h5,
    .kanahola-template h6,
    .kanahola-template p,
    .kanahola-template ul,
    .kanahola-template ol,
    .kanahola-template figure,
    .kanahola-template blockquote {
      margin: 0;
      padding: 0;
    }

    /* Blogger compatibility fixes */
    /* Override Blogger's default styles that might conflict with our design */
    .blog-posts .date-outer,
    .blog-posts .date-posts,
    .post-outer-container,
    .post-outer,
    .post {
      margin: 0 !important;
      padding: 0 !important;
      width: 100% !important;
      max-width: 100% !important;
    }

    /* Fix for Blogger's default image handling */
    .post-body img {
      max-width: 100%;
      height: auto;
    }

    /* Fix for Blogger's comment section */
    .comments {
      margin-top: 2rem;
    }

    /* Fix for Blogger's widget styling */
    .widget {
      margin-bottom: 2rem;
    }

    :root {
      /* Color Variables - Light Theme */
      --primary-color: #e63946;
      --secondary-color: #1d3557;
      --text-color: #333333;
      --light-text: #f1faee;
      --background-color: #ffffff;
      --surface-color: #ffffff;
      --light-gray: #f8f9fa;
      --medium-gray: #e9ecef;
      --dark-gray: #6c757d;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --card-bg: #ffffff;
      --input-bg: #ffffff;
      --input-text: #333333;
      --input-border: #dee2e6;
      --code-bg: #f5f5f5;
      --code-text: #333333;
      --blockquote-bg: #f8f9fa;
      --blockquote-border: #e63946;
      --link-color: #1d3557;
      --link-hover-color: #e63946;
      --button-bg: #e63946;
      --button-text: #ffffff;
      --button-hover-bg: #1d3557;
      --button-hover-text: #ffffff;
      --header-bg: #ffffff;
      --footer-bg: #f8f9fa;
      --footer-text: #6c757d;
      --selection-bg: #e63946;
      --selection-text: #ffffff;

      /* Dark Theme Variables */
      --dark-bg: #121212;
      --dark-surface: #1e1e1e;
      --dark-text: #e0e0e0;
      --dark-border: #333333;
      --dark-primary: #ff6b6b;
      --dark-secondary: #4ecdc4;
      --dark-light-gray: #2a2a2a;
      --dark-medium-gray: #3a3a3a;
      --dark-card-bg: #252525;
      --dark-input-bg: #2a2a2a;
      --dark-input-text: #e0e0e0;
      --dark-input-border: #444444;
      --dark-code-bg: #2d2d2d;
      --dark-code-text: #e0e0e0;
      --dark-blockquote-bg: #2a2a2a;
      --dark-blockquote-border: #ff6b6b;
      --dark-link-color: #4ecdc4;
      --dark-link-hover-color: #ff6b6b;
      --dark-button-bg: #ff6b6b;
      --dark-button-text: #121212;
      --dark-button-hover-bg: #4ecdc4;
      --dark-button-hover-text: #121212;
      --dark-header-bg: #1e1e1e;
      --dark-footer-bg: #1e1e1e;
      --dark-footer-text: #a0a0a0;
      --dark-shadow-color: rgba(0, 0, 0, 0.3);
      --dark-selection-bg: #ff6b6b;
      --dark-selection-text: #121212;

      /* Typography */
      --heading-font: 'Playfair Display', Georgia, serif;
      --body-font: 'Source Sans Pro', Arial, sans-serif;

      /* Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2.5rem;

      /* Container Width */
      --container-width: 1200px;
    }

    body {
      font-family: var(--body-font);
      color: var(--text-color);
      line-height: 1.6;
      background-color: var(--background-color);
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: var(--heading-font);
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: var(--spacing-md);
    }

    a {
      color: var(--secondary-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:hover {
      color: var(--primary-color);
    }

    img {
      max-width: 100%;
      height: auto;
      display: block;
    }

    /* Layout */
    .container {
      max-width: var(--container-width);
      margin: 0 auto;
      padding: 0 var(--spacing-md);
    }

    /* Header */
    .header {
      padding: var(--spacing-lg) 0;
      border-bottom: 1px solid var(--border-color);
    }

    .header-inner {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-family: var(--heading-font);
      font-size: 2rem;
      font-weight: 900;
      color: var(--secondary-color);
    }

    .logo a {
      color: inherit;
    }

    /* Navigation */
    .nav-menu {
      display: flex;
      list-style: none;
      gap: var(--spacing-lg);
    }

    .nav-menu li a {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 0.9rem;
    }

    .mobile-menu-toggle {
      display: none;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--secondary-color);
    }

    /* Main Content Layout */
    .content-wrapper {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: var(--spacing-xl);
      padding: var(--spacing-xl) 0;
    }

    /* Featured Section */
    .featured-section {
      margin-bottom: var(--spacing-xl);
    }

    .featured-post {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: var(--spacing-lg);
    }

    .featured-image {
      height: 400px;
      object-fit: cover;
      width: 100%;
    }

    .featured-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-lg);
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      color: var(--light-text);
    }

    .featured-title {
      font-size: 2rem;
      margin-bottom: var(--spacing-sm);
    }

    .featured-excerpt {
      margin-bottom: var(--spacing-md);
    }

    /* Post Grid */
    .post-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-lg);
    }

    /* Single Post Styles */
    .single-post {
      max-width: 800px;
      margin: 0 auto;
    }

    .single-post .post-title {
      font-size: 2.5rem;
      margin-bottom: var(--spacing-md);
    }

    .single-post .post-meta {
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .single-post .post-featured-image {
      margin-bottom: var(--spacing-lg);
      border-radius: 8px;
      overflow: hidden;
    }

    .single-post .featured-image {
      width: 100%;
      height: auto;
    }

    .single-post .post-body {
      font-size: 1.1rem;
      line-height: 1.8;
      margin-bottom: var(--spacing-xl);
    }

    .single-post .post-body p,
    .single-post .post-body ul,
    .single-post .post-body ol,
    .single-post .post-body blockquote {
      margin-bottom: var(--spacing-lg);
    }

    .single-post .post-body h2,
    .single-post .post-body h3,
    .single-post .post-body h4 {
      margin-top: var(--spacing-xl);
      margin-bottom: var(--spacing-md);
    }

    .single-post .post-body img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: var(--spacing-lg) 0;
    }

    .single-post .post-body blockquote {
      border-left: 4px solid var(--primary-color);
      padding-left: var(--spacing-lg);
      font-style: italic;
      color: var(--dark-gray);
    }

    .single-post .post-footer {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .post-share {
      margin-bottom: var(--spacing-lg);
    }

    .post-share h4 {
      margin-bottom: var(--spacing-md);
    }

    .social-share {
      display: flex;
      gap: var(--spacing-md);
    }

    .social-share a {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--light-gray);
      color: var(--secondary-color);
      transition: all 0.3s ease;
    }

    .social-share a:hover {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    .post-tags {
      margin-top: var(--spacing-lg);
    }

    .post-tags h4 {
      margin-bottom: var(--spacing-md);
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .tags a {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-md);
      background-color: var(--light-gray);
      border-radius: 20px;
      font-size: 0.85rem;
      transition: all 0.3s ease;
    }

    .tags a:hover {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    /* Article Tools */
    .post-tools {
      margin-top: var(--spacing-lg);
      padding: var(--spacing-md);
      background-color: var(--light-gray);
      border-radius: 8px;
    }

    .post-tools h4 {
      margin-top: 0;
      margin-bottom: var(--spacing-md);
    }

    .tools-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
    }

    .tool-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-md);
      background-color: var(--background-color);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tool-button i {
      margin-right: 5px;
    }

    .tool-button:hover {
      background-color: var(--primary-color);
      color: var(--light-text);
      border-color: var(--primary-color);
    }

    /* Dark mode styles for article tools */
    html.dark .post-tools {
      background-color: var(--light-gray);
    }

    html.dark .tool-button {
      background-color: var(--background-color);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    html.dark .tool-button:hover {
      background-color: var(--primary-color);
      color: var(--background-color);
      border-color: var(--primary-color);
    }

    /* Hidden class for TOC toggle */
    .table-of-contents.hidden {
      display: none;
    }

    /* Related Posts */
    .related-posts {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .related-posts h3 {
      margin-bottom: var(--spacing-lg);
      text-align: center;
    }

    /* Enhanced Reading Progress Bar */
    .reading-progress-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: rgba(0, 0, 0, 0.05);
      z-index: 9999;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .reading-progress-container.hidden {
      opacity: 0;
      transform: translateY(-5px);
      pointer-events: none;
    }

    .reading-progress-bar {
      height: 100%;
      background: var(--primary-color);
      width: 0;
      transition: width 0.2s ease;
      box-shadow: 0 0 3px rgba(230, 57, 70, 0.5);
    }

    .reading-progress-text {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      z-index: 9990;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .reading-progress-text.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .reading-progress-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 9990;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .reading-progress-toggle:hover {
      background-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .reading-progress-toggle.active {
      background-color: var(--primary-color);
    }

    /* Dark mode styles for reading progress */
    html.dark .reading-progress-container {
      background: rgba(255, 255, 255, 0.05);
    }

    html.dark .reading-progress-bar {
      background: var(--primary-color);
      box-shadow: 0 0 3px rgba(255, 107, 107, 0.5);
    }

    html.dark .reading-progress-text {
      background-color: rgba(30, 30, 30, 0.9);
    }

    html.dark .reading-progress-toggle {
      background-color: var(--light-gray);
    }

    html.dark .reading-progress-toggle:hover,
    html.dark .reading-progress-toggle.active {
      background-color: var(--primary-color);
    }

    /* Enhanced Table of Contents */
    .table-of-contents {
      background-color: var(--light-gray);
      border-radius: 8px;
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
      position: relative;
    }

    .table-of-contents-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .table-of-contents h4 {
      margin: 0;
      font-size: 1.2rem;
    }

    .table-of-contents-toggle {
      background: none;
      border: none;
      color: var(--secondary-color);
      cursor: pointer;
      padding: 5px;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      transition: color 0.2s ease;
    }

    .table-of-contents-toggle:hover {
      color: var(--primary-color);
    }

    .table-of-contents-toggle i {
      margin-right: 5px;
    }

    .table-of-contents ul {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 400px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
    }

    .table-of-contents.collapsed ul {
      max-height: 0;
      overflow: hidden;
    }

    .table-of-contents li {
      margin-bottom: var(--spacing-xs);
    }

    .table-of-contents .toc-link {
      display: block;
      padding: 5px 0;
      color: var(--secondary-color);
      text-decoration: none;
      transition: all 0.2s ease;
      border-left: 2px solid transparent;
      padding-left: 10px;
      margin-left: -10px;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .table-of-contents .toc-link:hover {
      color: var(--primary-color);
      background-color: rgba(0, 0, 0, 0.05);
    }

    .table-of-contents .toc-link.active {
      color: var(--primary-color);
      font-weight: bold;
      border-left: 2px solid var(--primary-color);
    }

    /* Floating TOC */
    .table-of-contents.floating {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 280px;
      max-width: 90%;
      max-height: calc(100vh - 160px);
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      opacity: 0.9;
      transform: translateX(0);
    }

    .table-of-contents.floating:hover {
      opacity: 1;
    }

    .table-of-contents.floating.collapsed {
      width: auto;
      padding: 10px;
    }

    .table-of-contents.floating.collapsed .table-of-contents-header {
      margin-bottom: 0;
    }

    /* TOC toggle button for mobile */
    .toc-mobile-toggle {
      position: fixed;
      bottom: 70px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      color: white;
      border: none;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 101;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .toc-mobile-toggle:hover {
      background-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .toc-mobile-toggle.active {
      background-color: var(--primary-color);
    }

    /* Dark mode styles for TOC */
    html.dark .table-of-contents {
      background-color: var(--card-bg);
      border-left: 4px solid var(--primary-color);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    html.dark .table-of-contents-toggle {
      color: var(--text-color);
    }

    html.dark .table-of-contents-toggle:hover {
      color: var(--primary-color);
    }

    html.dark .table-of-contents .toc-link.active {
      border-left: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    html.dark .table-of-contents .toc-link:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    html.dark .toc-mobile-toggle {
      background-color: var(--card-bg);
    }

    html.dark .toc-mobile-toggle:hover,
    html.dark .toc-mobile-toggle.active {
      background-color: var(--primary-color);
    }

    /* Responsive styles for TOC */
    @media (max-width: 992px) {
      .table-of-contents.floating {
        display: none;
      }

      .toc-mobile-toggle {
        display: flex;
      }

      .table-of-contents.mobile-visible {
        display: block;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 350px;
        max-height: 80vh;
        z-index: 1000;
      }

      .toc-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
      }

      .toc-overlay.active {
        display: block;
      }
    }

    /* These styles are now handled by CSS variables in the html.dark selector */
    /* Basic elements */
    html.dark .header {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: var(--border-color);
    }

    html.dark .footer {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: var(--border-color);
    }

    html.dark .post-card,
    html.dark .widget,
    html.dark .single-post,
    html.dark .comment-card,
    html.dark .table-of-contents,
    html.dark .related-posts {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-color: var(--border-color);
    }

    /* Links */
    html.dark a {
      color: var(--primary-color);
    }

    html.dark a:hover {
      color: var(--secondary-color);
    }

    /* Inputs and forms */
    html.dark input,
    html.dark textarea,
    html.dark select {
      background-color: var(--light-gray);
      color: var(--text-color);
      border-color: var(--border-color);
    }

    html.dark input::placeholder,
    html.dark textarea::placeholder {
      color: rgba(224, 224, 224, 0.6);
    }

    /* Buttons */
    html.dark .btn-primary {
      background-color: var(--primary-color);
      color: var(--background-color);
    }

    html.dark .btn-primary:hover {
      background-color: var(--secondary-color);
      color: var(--background-color);
    }

    html.dark .btn-secondary {
      background-color: var(--medium-gray);
      color: var(--text-color);
    }

    /* Code blocks */
    html.dark pre,
    html.dark code {
      background-color: var(--light-gray);
      color: var(--text-color);
      border-color: var(--border-color);
    }

    /* Syntax highlighting for dark mode (Prism.js) */
    html.dark .token.comment,
    html.dark .token.prolog,
    html.dark .token.doctype,
    html.dark .token.cdata {
      color: #6a9955;
    }

    html.dark .token.punctuation {
      color: #d4d4d4;
    }

    html.dark .token.property,
    html.dark .token.tag,
    html.dark .token.boolean,
    html.dark .token.number,
    html.dark .token.constant,
    html.dark .token.symbol,
    html.dark .token.deleted {
      color: #b5cea8;
    }

    html.dark .token.selector,
    html.dark .token.attr-name,
    html.dark .token.string,
    html.dark .token.char,
    html.dark .token.builtin,
    html.dark .token.inserted {
      color: #ce9178;
    }

    html.dark .token.operator,
    html.dark .token.entity,
    html.dark .token.url,
    html.dark .language-css .token.string,
    html.dark .style .token.string {
      color: #d4d4d4;
    }

    html.dark .token.atrule,
    html.dark .token.attr-value,
    html.dark .token.keyword {
      color: #569cd6;
    }

    html.dark .token.function,
    html.dark .token.class-name {
      color: #dcdcaa;
    }

    html.dark .token.regex,
    html.dark .token.important,
    html.dark .token.variable {
      color: #d16969;
    }

    html.dark .token.important,
    html.dark .token.bold {
      font-weight: bold;
    }

    html.dark .token.italic {
      font-style: italic;
    }

    /* Blockquotes */
    html.dark blockquote {
      background-color: var(--light-gray);
      border-color: var(--primary-color);
      color: var(--text-color);
    }

    /* Selection */
    html.dark ::selection {
      background-color: var(--primary-color);
      color: var(--background-color);
    }

    /* Shadows */
    html.dark .post-card,
    html.dark .widget,
    html.dark .single-post {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    /* Borders */
    html.dark .border-color,
    html.dark hr,
    html.dark .post-footer,
    html.dark .comment-divider {
      border-color: var(--border-color);
    }

    /* Theme transition */
    html.theme-transition,
    html.theme-transition *,
    html.theme-transition *:before,
    html.theme-transition *:after {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease !important;
    }

    /* Theme toggle container in sidebar */
    .theme-toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-md);
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--medium-gray);
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary-color);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    /* Dark mode styles for toggle */
    html.dark .toggle-slider {
      background-color: var(--border-color);
    }

    html.dark input:checked + .toggle-slider {
      background-color: var(--primary-color);
    }

    /* Enhanced Font Size Controls */
    .font-size-controls {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .font-size-controls span {
      margin-right: var(--spacing-sm);
      font-weight: 500;
    }

    .font-size-controls button {
      background: var(--light-gray);
      border: 1px solid var(--border-color);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      font-weight: 600;
    }

    .font-size-controls button:hover {
      background: var(--primary-color);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .font-size-controls button.active {
      background: var(--primary-color);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .font-size-controls button:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    /* Dark mode styles for font size controls */
    html.dark .font-size-controls button {
      background: var(--light-gray);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    html.dark .font-size-controls button:hover,
    html.dark .font-size-controls button.active {
      background: var(--primary-color);
      color: var(--background-color);
    }

    /* Font size classes using rem-based sizing for consistent scaling */
    html {
      font-size: 16px; /* Base font size */
    }

    html.font-size-small {
      font-size: 14px;
    }

    html.font-size-medium {
      font-size: 16px;
    }

    html.font-size-large {
      font-size: 18px;
    }

    html.font-size-xlarge {
      font-size: 20px;
    }

    /* Ensure all text elements scale proportionally */
    .post-body {
      font-size: 1rem;
      line-height: 1.6;
    }

    .post-body h1 { font-size: 2rem; }
    .post-body h2 { font-size: 1.75rem; }
    .post-body h3 { font-size: 1.5rem; }
    .post-body h4 { font-size: 1.25rem; }
    .post-body h5 { font-size: 1.1rem; }
    .post-body h6 { font-size: 1rem; }
    .post-body p, .post-body li { font-size: 1rem; }
    .post-body blockquote { font-size: 1.1rem; }
    .post-body .caption, .post-body figcaption { font-size: 0.9rem; }

    /* Estimated Reading Time */
    .reading-time {
      display: inline-flex;
      align-items: center;
      margin-left: var(--spacing-md);
      color: var(--dark-gray);
      font-size: 0.85rem;
    }

    .reading-time i {
      margin-right: 5px;
    }

    /* Enhanced Comments */
    .comments {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
    }

    .comments h3 {
      margin-bottom: var(--spacing-lg);
    }

    .comment {
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: var(--spacing-sm);
    }

    .comment-author {
      font-weight: bold;
    }

    .comment-date {
      color: var(--dark-gray);
      font-size: 0.85rem;
    }

    .comment-content {
      margin-bottom: var(--spacing-sm);
    }

    .comment-actions {
      display: flex;
      gap: var(--spacing-md);
    }

    .comment-reply {
      color: var(--secondary-color);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .comment-replies {
      margin-left: var(--spacing-xl);
      padding-left: var(--spacing-md);
      border-left: 2px solid var(--border-color);
    }

    .comment-form {
      margin-top: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .comment-form textarea {
      width: 100%;
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-bottom: var(--spacing-md);
      resize: vertical;
      min-height: 100px;
    }

    .comment-form button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .comment-form button:hover {
      background-color: var(--secondary-color);
    }

    .reply-form {
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      display: none;
    }

    .reply-form.active {
      display: block;
    }

    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: var(--spacing-lg);
      cursor: pointer;
      background: none;
      border: none;
      color: var(--text-color);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.3s ease;
    }

    .theme-toggle:hover {
      background-color: rgba(0, 0, 0, 0.05);
      transform: translateY(-2px);
    }

    .theme-toggle:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    html.dark .theme-toggle {
      color: var(--text-color);
    }

    html.dark .theme-toggle:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .theme-toggle-icon {
      width: 20px;
      height: 20px;
      transition: transform 0.5s ease;
    }

    .theme-toggle:hover .theme-toggle-icon {
      transform: rotate(15deg);
    }

    /* Infinite Scroll Toggle */
    .infinite-scroll-toggle {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
      margin-right: var(--spacing-sm);
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--medium-gray);
      transition: .4s;
      border-radius: 20px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--primary-color);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    /* Loading Indicator and Error Message for Infinite Scroll */
    .infinite-scroll-loader {
      text-align: center;
      padding: var(--spacing-lg);
      display: none;
    }

    .infinite-scroll-loader.active {
      display: block;
    }

    .infinite-scroll-error {
      text-align: center;
      padding: var(--spacing-lg);
      margin: var(--spacing-md) 0;
      background-color: rgba(230, 57, 70, 0.1);
      border-radius: 8px;
      color: var(--primary-color);
      border: 1px solid rgba(230, 57, 70, 0.3);
    }

    .retry-load {
      display: inline-block;
      margin-left: var(--spacing-sm);
      padding: var(--spacing-xs) var(--spacing-md);
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .retry-load:hover {
      background-color: var(--secondary-color);
    }

    /* Sentinel element styling */
    #infinite-scroll-sentinel {
      position: relative;
    }

    html.dark .infinite-scroll-error {
      background-color: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.3);
      color: var(--primary-color);
    }

    html.dark .retry-load {
      background-color: var(--primary-color);
      color: var(--background-color);
    }

    html.dark .retry-load:hover {
      background-color: var(--secondary-color);
    }

    /* Image Lightbox */
    .image-lightbox-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .post-featured-image:hover .image-lightbox-overlay {
      opacity: 1;
    }

    .lightbox-button {
      background: rgba(255,255,255,0.8);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
      color: var(--secondary-color);
      transition: all 0.3s ease;
    }

    .lightbox-button:hover {
      background: var(--primary-color);
      color: white;
    }

    .image-lightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .lightbox-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
    }

    .lightbox-content img {
      max-width: 100%;
      max-height: 90vh;
      object-fit: contain;
    }

    .lightbox-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: none;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
    }

    /* Enhanced Code Syntax Highlighting */
    pre {
      background-color: var(--code-bg);
      border-radius: 8px;
      padding: var(--spacing-md);
      margin: var(--spacing-lg) 0;
      overflow: auto;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-color);
      max-height: 600px;
    }

    code {
      font-family: 'Fira Code', 'JetBrains Mono', 'Cascadia Code', 'Courier New', Courier, monospace;
      font-size: 0.9em;
      tab-size: 2;
      hyphens: none;
    }

    :not(pre) > code {
      background-color: var(--light-gray);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      color: var(--secondary-color);
      font-size: 0.9em;
      white-space: nowrap;
    }

    /* Prism.js toolbar enhancements */
    .code-toolbar {
      position: relative;
    }

    .code-toolbar .toolbar {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: flex;
      gap: 5px;
      z-index: 10;
    }

    .code-toolbar:hover .toolbar {
      opacity: 1;
    }

    .toolbar-item button {
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 0.3em 0.7em;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .toolbar-item button:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    /* Copy button states */
    .toolbar-item button.copy-button {
      position: relative;
    }

    .toolbar-item button.copy-button.success {
      background-color: rgba(40, 167, 69, 0.7);
    }

    .toolbar-item button.copy-button.error {
      background-color: rgba(220, 53, 69, 0.7);
    }

    /* Line numbers styling */
    pre.line-numbers {
      padding-left: 3.8em;
      counter-reset: linenumber;
    }

    pre.line-numbers > code {
      position: relative;
      white-space: inherit;
    }

    .line-numbers .line-numbers-rows {
      position: absolute;
      pointer-events: none;
      top: 0;
      font-size: 100%;
      left: -3.8em;
      width: 3em;
      letter-spacing: -1px;
      border-right: 1px solid rgba(0, 0, 0, 0.2);
      user-select: none;
    }

    .line-numbers-rows > span {
      display: block;
      counter-increment: linenumber;
    }

    .line-numbers-rows > span:before {
      content: counter(linenumber);
      color: rgba(0, 0, 0, 0.4);
      display: block;
      padding-right: 0.8em;
      text-align: right;
    }

    /* Language tag */
    div.code-toolbar > .toolbar > .toolbar-item > span {
      background-color: var(--primary-color);
      color: white;
      padding: 0.3em 0.7em;
      border-radius: 3px;
      font-size: 0.8em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: bold;
    }

    /* Line highlight */
    .line-highlight {
      background: rgba(255, 255, 0, 0.1);
      background: linear-gradient(to right, rgba(255, 255, 0, 0.1) 70%, rgba(255, 255, 0, 0));
    }

    /* Match braces */
    .token.punctuation.brace-hover,
    .token.punctuation.brace-selected {
      outline: solid 1px;
      outline-color: rgba(65, 105, 225, 0.5);
      background-color: rgba(65, 105, 225, 0.1);
    }

    /* Code block with filename */
    pre[data-filename]::before {
      content: attr(data-filename);
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.3);
      color: white;
      padding: 0.2em 0.7em;
      font-size: 0.8em;
      border-radius: 7px 7px 0 0;
      font-family: var(--body-font);
    }

    pre[data-filename] {
      padding-top: 2.2em;
    }

    /* Dark mode adjustments */
    html.dark pre {
      background-color: var(--light-gray);
      border-color: var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    html.dark :not(pre) > code {
      background-color: var(--light-gray);
      color: var(--primary-color);
    }

    html.dark .line-numbers-rows {
      border-right-color: rgba(255, 255, 255, 0.2);
    }

    html.dark .line-numbers-rows > span:before {
      color: rgba(255, 255, 255, 0.4);
    }

    html.dark .toolbar-item button {
      background-color: rgba(0, 0, 0, 0.4);
    }

    html.dark .toolbar-item button:hover {
      background-color: rgba(0, 0, 0, 0.6);
    }

    html.dark pre[data-filename]::before {
      background-color: rgba(0, 0, 0, 0.5);
    }

    /* Responsive adjustments for code blocks */
    @media (max-width: 768px) {
      pre {
        font-size: 0.85em;
        padding: var(--spacing-sm);
      }

      pre.line-numbers {
        padding-left: 3.2em;
      }

      .line-numbers .line-numbers-rows {
        left: -3.2em;
        width: 2.5em;
      }

      pre[data-filename] {
        padding-top: 2em;
      }
    }

    /* Code block max height with scroll indicator */
    pre.max-height {
      position: relative;
    }

    pre.max-height::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 30px;
      background: linear-gradient(to bottom, transparent, var(--code-bg));
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    pre.max-height.scrollable::after {
      opacity: 1;
    }

    html.dark pre.max-height::after {
      background: linear-gradient(to bottom, transparent, var(--light-gray));
    }

    /* Recommendation System Styles */
    .post-recommendations {
      margin: var(--spacing-xl) 0;
      padding: var(--spacing-md);
      background-color: var(--light-gray);
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .post-recommendations h3 {
      margin-top: 0;
      margin-bottom: var(--spacing-md);
      font-size: 1.5rem;
      color: var(--secondary-color);
    }

    .recommendations-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-lg);
    }

    .recommendations-loading .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-sm);
    }

    .recommendations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-md);
    }

    .recommendation-card {
      background-color: var(--background-color);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .recommendation-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .recommendation-image-link {
      display: block;
      position: relative;
      padding-top: 56.25%; /* 16:9 aspect ratio */
      overflow: hidden;
    }

    .recommendation-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }

    .recommendation-card:hover .recommendation-image {
      transform: scale(1.05);
    }

    .recommendation-content {
      padding: var(--spacing-md);
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .recommendation-title {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: var(--spacing-sm);
      line-height: 1.3;
    }

    .recommendation-title a {
      color: var(--text-color);
      text-decoration: none;
    }

    .recommendation-title a:hover {
      color: var(--primary-color);
    }

    .recommendation-excerpt {
      font-size: 0.9rem;
      margin-bottom: var(--spacing-md);
      color: var(--dark-gray);
      flex-grow: 1;
    }

    .recommendation-meta {
      font-size: 0.8rem;
      color: var(--dark-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recommendation-similarity {
      background-color: var(--light-gray);
      padding: 3px 8px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* Dark mode styles for recommendations */
    html.dark .post-recommendations {
      background-color: var(--light-gray);
      border-left-color: var(--primary-color);
    }

    html.dark .post-recommendations h3 {
      color: var(--text-color);
    }

    html.dark .recommendations-loading .spinner {
      border-color: rgba(255, 255, 255, 0.1);
      border-left-color: var(--primary-color);
    }

    html.dark .recommendation-card {
      background-color: var(--card-bg);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    html.dark .recommendation-card:hover {
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    html.dark .recommendation-title a {
      color: var(--text-color);
    }

    html.dark .recommendation-title a:hover {
      color: var(--primary-color);
    }

    html.dark .recommendation-excerpt {
      color: var(--dark-gray);
    }

    html.dark .recommendation-meta {
      color: var(--dark-gray);
    }

    html.dark .recommendation-similarity {
      background-color: var(--medium-gray);
    }

    /* Responsive Gallery Styles */
    .gallery-container {
      margin: var(--spacing-lg) 0;
      display: grid;
      gap: var(--spacing-sm);
      grid-template-columns: repeat(1, 1fr);
    }

    .gallery-two-column {
      grid-template-columns: repeat(2, 1fr);
    }

    .gallery-three-column {
      grid-template-columns: repeat(3, 1fr);
    }

    .gallery-four-column {
      grid-template-columns: repeat(2, 1fr);
    }

    .gallery-masonry {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-auto-rows: minmax(100px, auto);
      gap: var(--spacing-sm);
    }

    .gallery-item {
      margin: 0;
      position: relative;
      overflow: hidden;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .gallery-item:hover {
      transform: translateY(-3px);
    }

    .gallery-item img {
      width: 100%;
      height: auto;
      display: block;
      transition: transform 0.3s ease;
    }

    .gallery-item:hover img {
      transform: scale(1.03);
    }

    .gallery-item figcaption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.9rem;
      opacity: 0;
      transform: translateY(100%);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .gallery-item:hover figcaption {
      opacity: 1;
      transform: translateY(0);
    }

    /* Gallery Lightbox */
    .gallery-lightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .gallery-lightbox.active {
      opacity: 1;
      visibility: visible;
    }

    .lightbox-content {
      position: relative;
      max-width: 90%;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .lightbox-image-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lightbox-image-container img {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
    }

    .lightbox-caption {
      color: white;
      text-align: center;
      padding: var(--spacing-md);
      font-size: 1rem;
      max-width: 800px;
    }

    .lightbox-counter {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
      margin-top: var(--spacing-sm);
    }

    .lightbox-close,
    .lightbox-prev,
    .lightbox-next {
      background: none;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
      padding: 10px;
      position: absolute;
      z-index: 10;
      opacity: 0.7;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .lightbox-close:hover,
    .lightbox-prev:hover,
    .lightbox-next:hover {
      opacity: 1;
    }

    .lightbox-close {
      top: 20px;
      right: 20px;
    }

    .lightbox-prev {
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    .lightbox-next {
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
    }

    /* Video Container */
    .video-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      max-width: 100%;
      margin: var(--spacing-lg) 0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }

    /* Accordion/Collapsible Sections */
    .accordion-header {
      background-color: var(--light-gray);
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0 0 0;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      transition: background-color 0.3s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .accordion-header:hover {
      background-color: var(--medium-gray);
    }

    .accordion-icon {
      width: 20px;
      height: 20px;
      position: relative;
      transition: transform 0.3s ease;
    }

    .accordion-icon::before,
    .accordion-icon::after {
      content: '';
      position: absolute;
      background-color: var(--secondary-color);
      transition: transform 0.3s ease;
    }

    .accordion-icon::before {
      top: 9px;
      left: 0;
      width: 100%;
      height: 2px;
    }

    .accordion-icon::after {
      top: 0;
      left: 9px;
      width: 2px;
      height: 100%;
    }

    .accordion-header[aria-expanded="true"] .accordion-icon::after {
      transform: rotate(90deg);
      opacity: 0;
    }

    .accordion-panel {
      overflow: hidden;
      padding: 0 var(--spacing-md);
      border-radius: 0 0 8px 8px;
      background-color: var(--background-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: var(--spacing-md);
    }

    /* Content Tabs */
    .tabs-list {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--border-color);
    }

    .tab-button {
      padding: var(--spacing-sm) var(--spacing-md);
      background-color: var(--light-gray);
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease, color 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .tab-button[aria-selected="true"] {
      background-color: var(--primary-color);
      color: white;
    }

    .tab-button:hover:not([aria-selected="true"]) {
      background-color: var(--medium-gray);
    }

    .tab-button:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    .tab-panel {
      padding: var(--spacing-md);
      background-color: var(--background-color);
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    /* Dark mode styles for content features */
    html.dark .accordion-header {
      background-color: var(--light-gray);
    }

    html.dark .accordion-header:hover {
      background-color: var(--medium-gray);
    }

    html.dark .accordion-icon::before,
    html.dark .accordion-icon::after {
      background-color: var(--text-color);
    }

    html.dark .accordion-panel {
      background-color: var(--background-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    html.dark .tab-button {
      background-color: var(--light-gray);
      color: var(--text-color);
    }

    html.dark .tab-button[aria-selected="true"] {
      background-color: var(--primary-color);
      color: var(--background-color);
    }

    html.dark .tab-button:hover:not([aria-selected="true"]) {
      background-color: var(--medium-gray);
    }

    html.dark .tab-panel {
      background-color: var(--background-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Responsive styles for content features */
    @media (min-width: 768px) {
      .gallery-four-column {
        grid-template-columns: repeat(4, 1fr);
      }

      .gallery-masonry {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .recommendations-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      }

      .gallery-three-column {
        grid-template-columns: repeat(2, 1fr);
      }

      .lightbox-prev {
        left: 10px;
      }

      .lightbox-next {
        right: 10px;
      }

      .tabs-list {
        flex-direction: column;
        gap: 5px;
        border-bottom: none;
      }

      .tab-button {
        border-radius: 8px;
      }
    }

    @media (max-width: 480px) {
      .recommendations-grid {
        grid-template-columns: 1fr;
      }

      .gallery-two-column,
      .gallery-three-column,
      .gallery-four-column,
      .gallery-masonry {
        grid-template-columns: 1fr;
      }
    }

    /* Print-Friendly Version Styles */
    .print-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-sm) var(--spacing-md);
      background-color: var(--light-gray);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: var(--spacing-md);
      color: var(--text-color);
    }

    .print-button i {
      margin-right: 5px;
    }

    .print-button:hover {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* Dark mode styles for print button */
    html.dark .print-button {
      background-color: var(--light-gray);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    html.dark .print-button:hover {
      background-color: var(--primary-color);
      color: var(--background-color);
      border-color: var(--primary-color);
    }

    /* Print Stylesheet */
    @media print {
      /* Reset all backgrounds and colors for better printing */
      body, .header, .footer, .sidebar, .post-card, .widget, .single-post {
        background: white !important;
        color: black !important;
        box-shadow: none !important;
      }

      /* Hide unnecessary elements */
      .header, .footer, .sidebar, .nav-menu, .mobile-menu-toggle,
      .social-share, .post-tags, .post-tools, .comments, .related-posts,
      .ad-container, .newsletter-widget, .theme-toggle, .reading-progress-container,
      .reading-progress-toggle, .exit-intent-popup, .ad-blocker-notice,
      .offline-status, .notification, .page-loader, .print-button {
        display: none !important;
      }

      /* Adjust layout for printing */
      .container, .content-wrapper, .main-content, .single-post {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        grid-template-columns: 1fr !important;
      }

      /* Typography improvements for print */
      body {
        font-size: 12pt !important;
        line-height: 1.5 !important;
        font-family: Georgia, 'Times New Roman', Times, serif !important;
      }

      h1, h2, h3, h4, h5, h6 {
        page-break-after: avoid !important;
        page-break-inside: avoid !important;
        font-family: Georgia, 'Times New Roman', Times, serif !important;
      }

      h1 { font-size: 24pt !important; }
      h2 { font-size: 20pt !important; }
      h3 { font-size: 16pt !important; }
      h4 { font-size: 14pt !important; }
      h5, h6 { font-size: 12pt !important; }

      p, li, blockquote {
        page-break-inside: avoid !important;
        orphans: 3 !important;
        widows: 3 !important;
      }

      /* Image optimization for print */
      img, .featured-image, .post-featured-image img {
        max-width: 100% !important;
        height: auto !important;
        page-break-inside: avoid !important;
      }

      /* Add URL after links for better reference in print */
      a[href]:after {
        content: " (" attr(href) ")";
        font-size: 90%;
        color: #666;
      }

      /* Don't show URL for internal links and javascript */
      a[href^="#"]:after,
      a[href^="javascript:"]:after {
        content: "";
      }

      /* Add page breaks before major sections */
      h1, h2 {
        page-break-before: always !important;
      }

      /* First heading should not have a page break before */
      .post-title:first-child,
      h1:first-child,
      h2:first-child {
        page-break-before: avoid !important;
      }

      /* Add print-specific header with blog info */
      .single-post:before {
        content: "Kanahola Magazine";
        display: block;
        text-align: center;
        font-size: 18pt;
        font-weight: bold;
        margin-bottom: 20pt;
        border-bottom: 1pt solid #ccc;
        padding-bottom: 10pt;
      }

      /* Add print-specific footer with URL and date */
      .single-post:after {
        content: "Printed from Kanahola Magazine (" attr(data-url) ") on " attr(data-print-date);
        display: block;
        text-align: center;
        font-size: 9pt;
        color: #666;
        margin-top: 20pt;
        border-top: 1pt solid #ccc;
        padding-top: 10pt;
      }
    }

    /* Enhanced Media Gallery */
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin: var(--spacing-lg) 0;
    }

    .gallery-item {
      position: relative;
      overflow: hidden;
      border-radius: 6px;
      cursor: pointer;
    }

    .gallery-item img {
      transition: transform 0.3s ease;
      width: 100%;
      height: 200px;
      object-fit: cover;
    }

    .gallery-item:hover img {
      transform: scale(1.05);
    }

    .gallery-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .gallery-item:hover .gallery-caption {
      opacity: 1;
    }

    /* Enhanced Lightbox */
    .image-lightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .image-lightbox.active {
      opacity: 1;
      visibility: visible;
    }

    .lightbox-content {
      position: relative;
      max-width: 90%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .lightbox-image {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 4px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .lightbox-caption {
      color: white;
      margin-top: var(--spacing-md);
      text-align: center;
      max-width: 80%;
    }

    .lightbox-controls {
      position: absolute;
      top: 50%;
      width: 100%;
      display: flex;
      justify-content: space-between;
      transform: translateY(-50%);
      z-index: 1;
    }

    .lightbox-control {
      background: rgba(255,255,255,0.2);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      border: none;
      margin: 0 var(--spacing-md);
    }

    .lightbox-control:hover {
      background: rgba(255,255,255,0.3);
    }

    .lightbox-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: none;
      border: none;
      color: white;
      font-size: 2rem;
      cursor: pointer;
    }

    .lightbox-counter {
      position: absolute;
      bottom: -30px;
      left: 0;
      right: 0;
      text-align: center;
      color: white;
      font-size: 0.9rem;
    }

    /* Print Styles - Enhanced for better print output */
    @media print {
      body {
        font-size: 12pt;
        line-height: 1.5;
        background: #fff !important;
        color: #000 !important;
      }

      .header, .footer, .sidebar, .post-share, .related-posts,
      .comments, .nav-menu, .mobile-menu-toggle, .reading-progress-container,
      .reading-progress-text, .reading-progress-toggle, .theme-toggle,
      .font-size-controls, .post-footer, .image-lightbox-overlay,
      .lightbox-button, .page-loader, .infinite-scroll-loader {
        display: none !important;
      }

      .container {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
      }

      .content-wrapper {
        display: block;
        padding: 0;
      }

      .single-post {
        padding: 0;
        margin: 0;
        border: none;
        box-shadow: none;
      }

      .post-title {
        font-size: 24pt;
        margin-bottom: 1cm;
      }

      .post-meta {
        font-size: 10pt;
        margin-bottom: 1cm;
      }

      .post-body {
        font-size: 12pt;
      }

      a {
        color: #000 !important;
        text-decoration: none !important;
      }

      a[href]:after {
        content: " (" attr(href) ")";
        font-size: 10pt;
        font-style: italic;
      }

      a[href^="#"]:after,
      a[href^="javascript:"]:after,
      a[href*="blogger.com"]:after,
      a[href*="blogspot.com"]:after {
        content: "";
      }

      img {
        max-width: 100% !important;
        page-break-inside: avoid;
      }

      h1, h2, h3, h4, h5, h6 {
        page-break-after: avoid;
        page-break-inside: avoid;
      }

      p, blockquote, ul, ol, dl, table {
        page-break-inside: avoid;
      }

      p {
        orphans: 3;
        widows: 3;
      }

      /* Add page breaks before major sections */
      h1, h2 {
        page-break-before: always;
      }

      /* Ensure images print well */
      img {
        display: block;
        margin: 1cm auto;
      }

      /* Print URL for external links */
      .post-body a[href^="http"]:after {
        content: " (" attr(href) ")";
        font-size: 10pt;
        font-style: italic;
      }
    }

    /* Error Page */
    .error-page {
      text-align: center;
      padding: var(--spacing-xl) 0;
      max-width: 600px;
      margin: 0 auto;
    }

    .error-code {
      font-size: 8rem;
      font-weight: 900;
      color: var(--primary-color);
      line-height: 1;
      margin-bottom: var(--spacing-md);
    }

    .error-title {
      font-size: 2.5rem;
      margin-bottom: var(--spacing-md);
    }

    .error-message {
      font-size: 1.2rem;
      color: var(--dark-gray);
      margin-bottom: var(--spacing-xl);
    }

    .error-actions {
      display: flex;
      justify-content: center;
      gap: var(--spacing-md);
    }

    .btn {
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-lg);
      border-radius: 30px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: var(--light-text);
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
      color: var(--light-text);
    }

    .btn-secondary {
      background-color: var(--light-gray);
      color: var(--secondary-color);
    }

    .btn-secondary:hover {
      background-color: var(--medium-gray);
    }

    /* Error Container for AJAX errors */
    .error-container {
      text-align: center;
      padding: var(--spacing-xl) 0;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Accessibility - Screen reader only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    .post-card {
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      background-color: var(--background-color);
    }

    .post-card:hover {
      transform: translateY(-5px);
    }

    .post-thumbnail {
      height: 180px;
      object-fit: cover;
    }

    .post-content {
      padding: var(--spacing-md);
    }

    .post-title {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-sm);
    }

    .post-meta {
      color: var(--dark-gray);
      font-size: 0.85rem;
      margin-bottom: var(--spacing-sm);
    }

    .post-excerpt {
      font-size: 0.9rem;
      margin-bottom: var(--spacing-md);
    }

    .read-more {
      font-weight: 600;
      color: var(--primary-color);
    }

    /* Sidebar */
    .sidebar {
      padding-top: var(--spacing-xl);
    }

    .widget {
      margin-bottom: var(--spacing-xl);
      padding: var(--spacing-lg);
      background-color: var(--light-gray);
      border-radius: 8px;
    }

    .widget-title {
      font-size: 1.25rem;
      margin-bottom: var(--spacing-lg);
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--primary-color);
    }

    /* Footer */
    .footer {
      background-color: var(--secondary-color);
      color: var(--light-text);
      padding: var(--spacing-xl) 0;
      margin-top: var(--spacing-xl);
    }

    .footer-inner {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--spacing-lg);
    }

    .footer-widget h3 {
      margin-bottom: var(--spacing-lg);
      font-size: 1.2rem;
    }

    .footer-bottom {
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
    }

    /* Page Loader */
    .page-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    /* NoScript Warning */
    .noscript-warning {
      background-color: var(--primary-color);
      color: var(--light-text);
      padding: var(--spacing-md);
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 9999;
    }

    .noscript-warning p {
      margin: 0;
      font-weight: 600;
    }

    .loader-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid var(--medium-gray);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Newsletter Styles */
    .newsletter-form {
      background-color: var(--light-gray);
      padding: var(--spacing-lg);
      border-radius: 8px;
      margin-bottom: var(--spacing-lg);
    }

    .newsletter-form h3 {
      margin-bottom: var(--spacing-md);
      font-size: 1.25rem;
    }

    .newsletter-form p {
      margin-bottom: var(--spacing-md);
      font-size: 0.9rem;
    }

    .newsletter-form-input {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .newsletter-form-input input {
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .newsletter-form-input button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .newsletter-form-input button:hover {
      background-color: #d32f2f;
    }

    /* Exit Intent Popup */
    .exit-intent-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .exit-intent-popup.active {
      opacity: 1;
      visibility: visible;
    }

    .exit-intent-popup-content {
      background-color: white;
      padding: var(--spacing-xl);
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      position: relative;
      text-align: center;
    }

    .exit-intent-popup-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--dark-gray);
    }

    .exit-intent-popup h2 {
      margin-bottom: var(--spacing-md);
      color: var(--secondary-color);
    }

    .exit-intent-popup p {
      margin-bottom: var(--spacing-lg);
    }

    /* Content Gating */
    .premium-content-gate {
      background-color: var(--light-gray);
      padding: var(--spacing-lg);
      border-radius: 8px;
      margin: var(--spacing-lg) 0;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .premium-content-gate h3 {
      margin-bottom: var(--spacing-md);
      color: var(--secondary-color);
    }

    .premium-content-gate p {
      margin-bottom: var(--spacing-md);
    }

    .premium-content-gate .newsletter-form-input {
      max-width: 400px;
      margin: 0 auto;
    }

    /* Ad Management Styles */
    .ad-container {
      margin: var(--spacing-lg) 0;
      text-align: center;
      min-height: 250px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--light-gray);
      border-radius: 8px;
      overflow: hidden;
    }

    .ad-container.sidebar-ad {
      min-height: 300px;
      margin-bottom: var(--spacing-lg);
    }

    .ad-container img {
      max-width: 100%;
      height: auto;
    }

    .ad-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--dark-gray);
      margin-bottom: var(--spacing-xs);
      display: block;
    }

    /* Ad Blocker Notice */
    .ad-blocker-notice {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .ad-blocker-notice.active {
      opacity: 1;
      visibility: visible;
    }

    .ad-blocker-notice-content {
      background-color: white;
      padding: var(--spacing-xl);
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      text-align: center;
    }

    .ad-blocker-notice h2 {
      margin-bottom: var(--spacing-md);
      color: var(--primary-color);
    }

    .ad-blocker-notice p {
      margin-bottom: var(--spacing-lg);
    }

    .ad-blocker-notice button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .ad-blocker-notice button:hover {
      background-color: #d32f2f;
    }

    /* Social Proof Elements */
    .post-view-counter {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--dark-gray);
      font-size: 0.85rem;
    }

    .post-view-counter i {
      color: var(--primary-color);
    }

    .social-share-container {
      display: flex;
      gap: var(--spacing-sm);
      margin: var(--spacing-lg) 0;
    }

    .social-share-button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1rem;
      transition: transform 0.3s ease;
    }

    .social-share-button:hover {
      transform: translateY(-3px);
    }

    .social-share-button.facebook {
      background-color: #3b5998;
    }

    .social-share-button.twitter {
      background-color: #1da1f2;
    }

    .social-share-button.pinterest {
      background-color: #bd081c;
    }

    .social-share-button.linkedin {
      background-color: #0077b5;
    }

    .social-share-button.whatsapp {
      background-color: #25d366;
    }

    .social-share-counter {
      font-size: 0.8rem;
      color: var(--dark-gray);
      text-align: center;
      margin-top: var(--spacing-xs);
    }

    /* EmailKit Integration Styles */
    .newsletter-success-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--secondary-color);
      color: white;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 9999;
      font-size: 0.9rem;
      max-width: 300px;
    }

    .newsletter-trigger {
      cursor: pointer;
    }

    .reading-time-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      color: var(--dark-gray);
      font-size: 0.85rem;
      margin-bottom: var(--spacing-md);
    }

    .reading-time-container i {
      color: var(--secondary-color);
    }

    .engagement-meter {
      height: 4px;
      background-color: var(--medium-gray);
      border-radius: 2px;
      margin-top: var(--spacing-xs);
      overflow: hidden;
    }

    .engagement-meter-fill {
      height: 100%;
      background-color: var(--primary-color);
      width: 0;
      transition: width 0.3s ease;
    }

    .popular-posts-widget {
      margin-bottom: var(--spacing-lg);
    }

    .popular-post-item {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-md);
      border-bottom: 1px solid var(--border-color);
    }

    .popular-post-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .popular-post-thumbnail {
      width: 80px;
      height: 80px;
      border-radius: 4px;
      overflow: hidden;
      flex-shrink: 0;
    }

    .popular-post-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .popular-post-content {
      flex-grow: 1;
    }

    .popular-post-title {
      font-size: 0.95rem;
      margin-bottom: var(--spacing-xs);
      font-weight: 600;
    }

    .popular-post-meta {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 0.8rem;
      color: var(--dark-gray);
    }

    /* Responsive Styles */
    @media (max-width: 992px) {
      .content-wrapper {
        grid-template-columns: 1fr;
      }

      .sidebar {
        padding-top: 0;
      }

      .footer-inner {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block;
      }

      .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: var(--background-color);
        flex-direction: column;
        padding: var(--spacing-md);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 100;
      }

      .nav-menu.active {
        display: flex;
      }

      .featured-image {
        height: 300px;
      }

      .featured-title {
        font-size: 1.5rem;
      }
    }

    @media (max-width: 576px) {
      .post-grid {
        grid-template-columns: 1fr;
      }

      .footer-inner {
        grid-template-columns: 1fr;
      }

      .featured-image {
        height: 250px;
      }

      /* Mobile styles for reading progress */
      .reading-progress-container {
        height: 4px;
      }

      .reading-progress-text {
        bottom: 60px;
        right: 10px;
        font-size: 0.75rem;
        padding: 6px 10px;
        max-width: 250px;
      }

      .reading-progress-toggle {
        bottom: 15px;
        left: 15px;
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
      }

      /* Ensure the reading progress text doesn't overlap with the toggle button */
      .reading-progress-text.visible {
        bottom: 60px;
      }
    }
  ]]></b:skin>

  <!-- JavaScript -->
  <b:js><![CDATA[
    //
    /*
    -----------------------------------------------
    Kanahola Magazine Blog - SPA Functionality
    -----------------------------------------------
    */

    (function($) {
      'use strict';

      // SPA Configuration
      const SPA = {
        // Cache DOM elements
        elements: {
          mainContent: $('.main-content'),
          pageLoader: $('.page-loader'),
          header: $('.header'),
          footer: $('.footer')
        },

        // SPA state
        state: {
          currentUrl: window.location.href,
          isLoading: false,
          isInitialized: false
        },

        // Initialize SPA functionality
        init: function() {
          if (this.state.isInitialized) return;

          this.bindEvents();
          this.setupInitialState();

          this.state.isInitialized = true;
          console.log('SPA initialized');
        },

        // Bind all event listeners
        bindEvents: function() {
          // Intercept all internal link clicks
          $(document).on('click', 'a[href^="/"]:not([target="_blank"])', this.handleLinkClick.bind(this));

          // Handle browser back/forward buttons
          $(window).on('popstate', this.handlePopState.bind(this));

          // Mobile menu toggle
          $('.mobile-menu-toggle').on('click', this.toggleMobileMenu);
        },

        // Set up initial state based on current URL
        setupInitialState: function() {
          // Store initial page state
          const initialState = {
            title: document.title,
            url: window.location.href,
            content: this.elements.mainContent.html()
          };

          // Replace current history state with initial state
          window.history.replaceState(initialState, initialState.title, initialState.url);
        },

        // Handle internal link clicks
        handleLinkClick: function(e) {
          const $link = $(e.currentTarget);
          const url = $link.attr('href');

          // Skip if modifier keys are pressed or it's an external link
          if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || url.indexOf('http') === 0) {
            return;
          }

          // Skip Blogger-specific URLs that shouldn't be handled by SPA
          const excludedPatterns = [
            '/search',
            '/feeds/',
            '/comments/',
            '/rearrange',
            '/b/layout-preview',
            '/b/uploadImage',
            '/b/deleteImage',
            'blogger.com'
          ];

          // Check if URL matches any excluded pattern
          for (const pattern of excludedPatterns) {
            if (url.includes(pattern)) {
              console.log('Skipping SPA for excluded URL:', url);
              return; // Allow default browser navigation
            }
          }

          // Skip if link has specific classes or attributes that indicate it shouldn't use SPA
          if ($link.hasClass('no-spa') ||
              $link.attr('target') === '_blank' ||
              $link.attr('download') ||
              $link.closest('.comment-form, .blogger-clickTrap').length) {
            console.log('Skipping SPA for excluded element:', $link);
            return; // Allow default browser navigation
          }

          e.preventDefault();

          // Don't reload if clicking the current page
          if (url === window.location.pathname) {
            return;
          }

          // Load the new page
          this.loadPage(url);
        },

        // Handle browser back/forward buttons
        handlePopState: function(e) {
          if (e.originalEvent.state) {
            const state = e.originalEvent.state;

            // If we have cached content, use it
            if (state.content) {
              this.elements.mainContent.html(state.content);
              document.title = state.title;
              this.updateActiveNavLink(state.url);
              window.scrollTo(0, 0);
            } else {
              // Otherwise load the page
              this.loadPage(state.url, false);
            }
          }
        },

        // Load page content via AJAX with caching
        loadPage: function(url, pushState = true) {
          // Don't load if already loading
          if (this.state.isLoading) return;

          this.state.isLoading = true;
          this.showLoader();

          // Check if page is in cache
          const cachedPage = CacheManager.getItem(url);
          if (cachedPage) {
            console.log('Loading page from cache:', url);

            // Update the page with cached content
            this.updatePage(cachedPage.content, cachedPage.title, url, pushState);

            // Complete the loading process
            this.state.isLoading = false;
            this.hideLoader();

            // Fetch fresh content in the background for next visit
            this.prefetchPage(url);

            return;
          }

          // Not in cache, load via AJAX with Blogger-specific handling
          $.ajax({
            url: url,
            type: 'GET',
            dataType: 'html',
            timeout: 10000,
            success: (response) => {
              // Create a temporary div to parse the HTML response
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = response;

              // Extract title with fallbacks
              let title = '';
              const titleElement = tempDiv.querySelector('title');
              if (titleElement) {
                title = titleElement.textContent;
              } else {
                // Fallback to current title if not found
                title = document.title;
              }

              // Extract content with robust fallbacks for Blogger's structure
              let content = '';

              // Try multiple selectors that might contain the main content in Blogger
              const contentSelectors = [
                '.main-content',
                '.blog-posts',
                '.post-outer-container',
                '.post-body',
                '.post'
              ];

              // Try each selector until we find content
              for (const selector of contentSelectors) {
                const contentElement = tempDiv.querySelector(selector);
                if (contentElement) {
                  content = contentElement.innerHTML;
                  break;
                }
              }

              // If still no content, try to extract the post content area
              if (!content) {
                const postBody = tempDiv.querySelector('.post-body');
                if (postBody) {
                  content = postBody.innerHTML;
                }
              }

              // If still no content, use a more generic approach
              if (!content) {
                const mainElement = tempDiv.querySelector('main') ||
                                   tempDiv.querySelector('.main') ||
                                   tempDiv.querySelector('#main');
                if (mainElement) {
                  content = mainElement.innerHTML;
                }
              }

              // Last resort fallback
              if (!content) {
                console.warn('Could not extract content from response, using body content');
                const bodyContent = tempDiv.querySelector('body');
                if (bodyContent) {
                  // Try to exclude header and footer
                  const header = bodyContent.querySelector('header') || bodyContent.querySelector('.header');
                  const footer = bodyContent.querySelector('footer') || bodyContent.querySelector('.footer');

                  if (header) header.remove();
                  if (footer) footer.remove();

                  content = bodyContent.innerHTML;
                } else {
                  // Absolute last resort
                  content = tempDiv.innerHTML;
                }
              }

              // Cache the page content if we successfully extracted it
              if (content) {
                CacheManager.setItem(url, {
                  title: title,
                  content: content,
                  timestamp: Date.now()
                });

                // Update the page
                this.updatePage(content, title, url, pushState);
              } else {
                // If we couldn't extract content, handle as error
                console.error('Failed to extract content from page:', url);
                this.handlePageLoadError(url);
              }
            },
            error: (xhr, status, error) => {
              console.error('Error loading page:', error);
              this.handlePageLoadError(url);

              // For network errors, redirect to the URL directly as fallback
              if (status === 'timeout' || status === 'error' || xhr.status === 0) {
                console.log('Network error, falling back to direct navigation');
                window.location.href = url;
              }
            },
            complete: () => {
              this.state.isLoading = false;
              this.hideLoader();
            }
          });
        },

        // Prefetch page in the background
        prefetchPage: function(url) {
          // Use requestIdleCallback to prefetch during browser idle time
          if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
              this.fetchPageInBackground(url);
            });
          } else {
            // Fallback for browsers without requestIdleCallback
            setTimeout(() => {
              this.fetchPageInBackground(url);
            }, 2000);
          }
        },

        // Fetch page in background without updating UI
        fetchPageInBackground: function(url) {
          $.ajax({
            url: url,
            type: 'GET',
            dataType: 'html',
            success: (response) => {
              // Create a temporary div to parse the HTML response
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = response;

              // Extract title with fallbacks
              let title = '';
              const titleElement = tempDiv.querySelector('title');
              if (titleElement) {
                title = titleElement.textContent;
              } else {
                // Fallback to current title if not found
                title = document.title;
              }

              // Extract content with robust fallbacks for Blogger's structure
              let content = '';

              // Try multiple selectors that might contain the main content in Blogger
              const contentSelectors = [
                '.main-content',
                '.blog-posts',
                '.post-outer-container',
                '.post-body',
                '.post'
              ];

              // Try each selector until we find content
              for (const selector of contentSelectors) {
                const contentElement = tempDiv.querySelector(selector);
                if (contentElement) {
                  content = contentElement.innerHTML;
                  break;
                }
              }

              // If we found content, update the cache
              if (content) {
                // Update cache with fresh content
                CacheManager.setItem(url, {
                  title: title,
                  content: content,
                  timestamp: Date.now()
                });

                console.log('Background fetch complete for:', url);
              } else {
                console.warn('Background fetch found no content for:', url);
              }
            },
            error: (xhr, status, error) => {
              console.warn('Background fetch failed for:', url, error);
            }
          });
        },

        // Handle page load errors
        handlePageLoadError: function(url) {
          // Create error message
          const errorContent = `
            <div class="error-container">
              <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <h2 class="error-title">Page Load Error</h2>
              <p class="error-message">Sorry, we couldn't load the page you requested.</p>
              <div class="error-actions">
                <button class="retry-button" onclick="window.location.reload()">Retry</button>
                <a href="/" class="home-button">Go to Homepage</a>
              </div>
            </div>
          `;

          // Update the page with error content
          this.elements.mainContent.html(errorContent);
          document.title = 'Error - Kanahola Magazine';

          // Hide loader
          this.hideLoader();

          // Log the error
          console.error('Failed to load page:', url);

          // Add event listener for retry button
          $('.retry-button').on('click', (e) => {
            e.preventDefault();
            // Try to load the page again
            this.loadPage(url);
          });
        },

        // Update page content and state
        updatePage: function(content, title, url, pushState) {
          // Update DOM
          this.elements.mainContent.html(content);
          document.title = title;

          // Update active navigation link
          this.updateActiveNavLink(url);

          // Update browser history
          if (pushState) {
            const state = {
              title: title,
              url: url,
              content: content
            };

            window.history.pushState(state, title, url);
          }

          // Update metadata for SEO
          this.updateMetadata(title, url);

          // Scroll to top
          window.scrollTo(0, 0);

          // Run any scripts in the new content
          this.executeScripts(content);

          // Trigger event for UX enhancements to initialize
          $(document).trigger('spa:contentLoaded');

          // Update metadata for SEO
          this.updateMetadata(title, url);
        },

        // Enhanced metadata update for SEO and social sharing
        updateMetadata: function(title, url) {
          // Get content details for metadata
          const description = this.extractDescription();
          const images = this.extractImages();

          // Update canonical URL
          $('link[rel="canonical"]').attr('href', url);

          // Update Open Graph tags
          $('meta[property="og:title"]').attr('content', title);
          $('meta[property="og:url"]').attr('content', url);
          if (description) {
            $('meta[property="og:description"]').attr('content', description);
          }

          // Update Open Graph image with priority selection
          if (images.length > 0) {
            $('meta[property="og:image"]').attr('content', images[0]);
          }

          // Update Twitter Card tags
          $('meta[name="twitter:title"]').attr('content', title);
          $('meta[name="twitter:url"]').attr('content', url);
          if (description) {
            $('meta[name="twitter:description"]').attr('content', description);
          }
          if (images.length > 0) {
            $('meta[name="twitter:image"]').attr('content', images[0]);
          }

          // Update page type specific metadata
          const isArticlePage = $('.single-post').length > 0 || $('.post-body').length > 0;
          if (isArticlePage) {
            $('meta[property="og:type"]').attr('content', 'article');

            // Update article specific metadata
            const authorName = $('.post-author').text().replace('by ', '') || 'Kanahola Magazine';
            const publishDate = $('.post-date').attr('datetime') || new Date().toISOString();
            const categories = [];
            $('.post-categories a, .post-labels a').each(function() {
              categories.push($(this).text().trim());
            });

            // Update article author
            $('meta[property="article:author"]').attr('content', authorName);

            // Update article publish date
            $('meta[property="article:published_time"]').attr('content', publishDate);

            // Update article tags/categories
            if (categories.length > 0) {
              // Remove existing article:tag meta tags
              $('meta[property="article:tag"]').remove();

              // Add new article:tag meta tags
              categories.forEach(category => {
                $('head').append(`<meta property="article:tag" content="${category}">`);
              });

              // Update article section
              $('meta[property="article:section"]').attr('content', categories[0]);
            }
          } else {
            $('meta[property="og:type"]').attr('content', 'website');
          }

          // Log metadata update for debugging
          console.log('Metadata updated for:', url);
        },

        // Extract description from content
        extractDescription: function() {
          // Try to find description in this priority order:
          // 1. Post excerpt
          // 2. First paragraph of content
          // 3. Meta description
          // 4. Default site description

          let description = '';

          if ($('.post-excerpt').length > 0) {
            description = $('.post-excerpt').text().trim();
          } else if ($('.post-body p').length > 0) {
            description = $('.post-body p').first().text().trim();
          } else if ($('meta[name="description"]').length > 0) {
            description = $('meta[name="description"]').attr('content');
          } else {
            description = 'Kanahola Magazine - Your source for insightful articles and stories';
          }

          // Truncate description if too long (max 160 chars for SEO, 200 for social)
          if (description.length > 200) {
            description = description.substring(0, 197) + '...';
          }

          return description;
        },

        // Extract images from content with priority order
        extractImages: function() {
          // Image selection priority:
          // 1. Featured image
          // 2. First image in content
          // 3. Author image
          // 4. Default site logo

          const images = [];

          // Check for featured image
          if ($('.post-featured-image img').length > 0) {
            images.push($('.post-featured-image img').attr('src'));
          }

          // Check for first content image
          if (images.length === 0 && $('.post-body img').length > 0) {
            images.push($('.post-body img').first().attr('src'));
          }

          // Check for author image
          if (images.length === 0 && $('.author-avatar img').length > 0) {
            images.push($('.author-avatar img').attr('src'));
          }

          // Add default site logo as fallback
          if (images.length === 0) {
            images.push($('link[rel="icon"]').attr('href') || 'https://kanaholamagazine.com/logo.png');
          }

          // Ensure images are absolute URLs
          for (let i = 0; i < images.length; i++) {
            if (images[i].startsWith('/')) {
              images[i] = window.location.origin + images[i];
            }
          }

          return images;
        },

        // Helper method to extract list items
        extractListItems: function(selector) {
          const items = [];
          $(selector).each(function() {
            items.push($(this).text().trim());
          });
          return items;
        },

        // Extract description from content
        extractDescription: function() {
          // Try to find description in this priority order:
          // 1. Post excerpt
          // 2. First paragraph of content
          // 3. Meta description
          // 4. Default site description

          let description = '';

          if ($('.post-excerpt').length > 0) {
            description = $('.post-excerpt').text().trim();
          } else if ($('.post-body p').length > 0) {
            description = $('.post-body p').first().text().trim();
          } else if ($('meta[name="description"]').length > 0) {
            description = $('meta[name="description"]').attr('content');
          } else {
            description = 'Kanahola Magazine - Your source for insightful articles and stories';
          }

          // Truncate description if too long (max 160 chars for SEO, 200 for social)
          if (description.length > 200) {
            description = description.substring(0, 197) + '...';
          }

          return description;
        },

        // Extract images from content with priority order
        extractImages: function() {
          // Image selection priority:
          // 1. Featured image
          // 2. First image in content
          // 3. Author image
          // 4. Default site logo

          const images = [];

          // Check for featured image
          if ($('.post-featured-image img').length > 0) {
            images.push($('.post-featured-image img').attr('src'));
          }

          // Check for first content image
          if (images.length === 0 && $('.post-body img').length > 0) {
            images.push($('.post-body img').first().attr('src'));
          }

          // Check for author image
          if (images.length === 0 && $('.author-avatar img').length > 0) {
            images.push($('.author-avatar img').attr('src'));
          }

          // Add default site logo as fallback
          if (images.length === 0) {
            images.push($('link[rel="icon"]').attr('href') || 'https://kanaholamagazine.com/logo.png');
          }

          // Ensure images are absolute URLs
          for (let i = 0; i < images.length; i++) {
            if (images[i].startsWith('/')) {
              images[i] = window.location.origin + images[i];
            }
          }

          return images;
        },

        // Execute any scripts in the loaded content
        executeScripts: function(content) {
          const $content = $('<div>').html(content);
          const scripts = $content.find('script');

          scripts.each(function() {
            const script = document.createElement('script');
            script.type = 'text/javascript';

            if ($(this).attr('src')) {
              script.src = $(this).attr('src');
            } else {
              script.text = $(this).text();
            }

            document.body.appendChild(script);
            document.body.removeChild(script);
          });

          // Re-initialize code syntax highlighting if Prism is loaded
          if (typeof Prism !== 'undefined') {
            // Add line-numbers class to all pre elements
            document.querySelectorAll('pre').forEach(pre => {
              if (!pre.classList.contains('line-numbers')) {
                pre.classList.add('line-numbers');
              }

              // Wrap code blocks with language class if not already present
              const code = pre.querySelector('code');
              if (code && !code.classList.contains('language-')) {
                // Try to detect language or default to markup
                let detectedLang = 'markup';
                const content = code.textContent.trim();

                if (content.startsWith('<') && content.includes('>')) {
                  detectedLang = 'markup';
                } else if (content.includes('{') && content.includes('}') && content.includes(';')) {
                  detectedLang = 'css';
                } else if (content.includes('function') || content.includes('var ') || content.includes('const ')) {
                  detectedLang = 'javascript';
                } else if (content.includes('import ') && content.includes('from ')) {
                  detectedLang = 'javascript';
                } else if (content.includes('def ') || content.includes('import ') && !content.includes('from ')) {
                  detectedLang = 'python';
                }

                code.classList.add(`language-${detectedLang}`);
              }
            });

            // Highlight all code blocks
            Prism.highlightAll();
          }
        },

        // Update active navigation link
        updateActiveNavLink: function(url) {
          $('.nav-menu li a').removeClass('active');
          $(`.nav-menu li a[href="${url}"]`).addClass('active');

          // Close mobile menu if open
          $('.nav-menu').removeClass('active');
        },

        // Handle page load errors
        handlePageLoadError: function(url) {
          // Show error message
          this.elements.mainContent.html(`
            <div class="error-container">
              <h2>Oops! Something went wrong</h2>
              <p>We couldn't load the page you requested. Please try again later.</p>
              <a href="/" class="btn btn-primary">Go to Homepage</a>
            </div>
          `);

          // Update title
          document.title = 'Error - Kanahola Magazine';
        },

        // Toggle mobile menu
        toggleMobileMenu: function() {
          $('.nav-menu').toggleClass('active');
        },

        // Show page loader
        showLoader: function() {
          this.elements.pageLoader.fadeIn(200);
        },

        // Hide page loader
        hideLoader: function() {
          this.elements.pageLoader.fadeOut(200);
        }
      };

      // Enhanced Cache Management for SPA
      const CacheManager = {
        // Cache configuration
        config: {
          cacheVersion: 'kanahola-v2', // Increment version when making significant changes
          maxCacheItems: 20, // Increased cache size
          cacheExpiration: 24 * 60 * 60 * 1000, // 24 hours in milliseconds
          itemExpiration: 60 * 60 * 1000, // Individual items expire after 1 hour
          priorityPages: ['/'], // Pages that should always be cached
          storageMethod: 'localStorage', // 'localStorage' or 'sessionStorage'
        },

        // Storage interface
        storage: {
          getItem: function(key) {
            return window[CacheManager.config.storageMethod].getItem(key);
          },
          setItem: function(key, value) {
            return window[CacheManager.config.storageMethod].setItem(key, value);
          },
          removeItem: function(key) {
            return window[CacheManager.config.storageMethod].removeItem(key);
          },
          clear: function() {
            return window[CacheManager.config.storageMethod].clear();
          }
        },

        // Initialize cache
        init: function() {
          // Check if storage is available
          if (!this.isStorageAvailable()) {
            console.warn('Storage is not available. Caching disabled.');
            return;
          }

          // Create cache if it doesn't exist or version has changed
          const existingCache = this.storage.getItem(this.config.cacheVersion);
          if (!existingCache) {
            this.storage.setItem(this.config.cacheVersion, JSON.stringify({
              items: {},
              keys: [],
              timestamp: Date.now(),
              metadata: {
                version: this.config.cacheVersion,
                created: Date.now()
              }
            }));
          }

          // Clean expired cache
          this.cleanExpiredCache();

          // Prefetch priority pages
          this.prefetchPriorityPages();
        },

        // Check if storage is available
        isStorageAvailable: function() {
          try {
            const storage = window[this.config.storageMethod];
            const testKey = '__storage_test__';
            storage.setItem(testKey, testKey);
            storage.removeItem(testKey);
            return true;
          } catch (e) {
            return false;
          }
        },

        // Get item from cache
        getItem: function(key) {
          try {
            const cache = JSON.parse(this.storage.getItem(this.config.cacheVersion));
            if (!cache || !cache.items || !cache.items[key]) {
              return null;
            }

            // Check if item has expired
            const item = cache.items[key];
            const now = Date.now();
            if (now - item.timestamp > this.config.itemExpiration &&
                !this.config.priorityPages.includes(key)) {
              // Item expired, remove it
              this.removeItem(key);
              return null;
            }

            // Update access timestamp and move to end of keys array (most recently used)
            this.updateItemAccess(key);

            return item;
          } catch (e) {
            console.warn('Error getting cached item:', e);
            return null;
          }
        },

        // Set item in cache
        setItem: function(key, value) {
          try {
            const cache = JSON.parse(this.storage.getItem(this.config.cacheVersion));
            if (!cache) {
              this.init();
              return this.setItem(key, value);
            }

            // If key already exists, update it
            if (cache.items[key]) {
              cache.items[key] = {
                ...value,
                timestamp: Date.now(),
                lastAccessed: Date.now()
              };

              // Move to end of keys array (most recently used)
              const keyIndex = cache.keys.indexOf(key);
              if (keyIndex > -1) {
                cache.keys.splice(keyIndex, 1);
                cache.keys.push(key);
              }

              this.storage.setItem(this.config.cacheVersion, JSON.stringify(cache));
              return;
            }

            // If cache is full, remove least recently used items
            while (cache.keys.length >= this.config.maxCacheItems &&
                  !this.config.priorityPages.includes(cache.keys[0])) {
              const oldestKey = cache.keys.shift();
              delete cache.items[oldestKey];
            }

            // Add new item
            cache.keys.push(key);
            cache.items[key] = {
              ...value,
              timestamp: Date.now(),
              lastAccessed: Date.now()
            };

            // Update cache timestamp
            cache.timestamp = Date.now();

            this.storage.setItem(this.config.cacheVersion, JSON.stringify(cache));
          } catch (e) {
            console.warn('Cache storage failed:', e);

            // If storage is full, try to free up space
            if (e.name === 'QuotaExceededError') {
              this.clearOldItems();
              // Try again with reduced data
              try {
                this.setItem(key, {
                  title: value.title,
                  content: value.content.substring(0, 50000), // Truncate content
                  timestamp: Date.now()
                });
              } catch (e2) {
                console.error('Failed to store even with reduced content:', e2);
                // Last resort: clear everything and start fresh
                this.storage.clear();
                this.init();
              }
            }
          }
        },

        // Update item access timestamp
        updateItemAccess: function(key) {
          try {
            const cache = JSON.parse(this.storage.getItem(this.config.cacheVersion));
            if (cache && cache.items && cache.items[key]) {
              // Update last accessed timestamp
              cache.items[key].lastAccessed = Date.now();

              // Move to end of keys array (most recently used)
              const keyIndex = cache.keys.indexOf(key);
              if (keyIndex > -1) {
                cache.keys.splice(keyIndex, 1);
                cache.keys.push(key);
              }

              this.storage.setItem(this.config.cacheVersion, JSON.stringify(cache));
            }
          } catch (e) {
            console.warn('Error updating item access:', e);
          }
        },

        // Remove item from cache
        removeItem: function(key) {
          try {
            const cache = JSON.parse(this.storage.getItem(this.config.cacheVersion));
            if (cache && cache.items && cache.items[key]) {
              delete cache.items[key];

              const keyIndex = cache.keys.indexOf(key);
              if (keyIndex > -1) {
                cache.keys.splice(keyIndex, 1);
              }

              this.storage.setItem(this.config.cacheVersion, JSON.stringify(cache));
            }
          } catch (e) {
            console.warn('Error removing cached item:', e);
          }
        },

        // Clean expired cache
        cleanExpiredCache: function() {
          try {
            const cache = JSON.parse(this.storage.getItem(this.config.cacheVersion));
            if (!cache) return;

            const now = Date.now();

            // Check if entire cache has expired
            if (now - cache.timestamp > this.config.cacheExpiration) {
              this.storage.removeItem(this.config.cacheVersion);
              this.init();
              return;
            }

            // Check individual items
            let keysToRemove = [];
            for (const key in cache.items) {
              if (now - cache.items[key].timestamp > this.config.itemExpiration &&
                  !this.config.priorityPages.includes(key)) {
                keysToRemove.push(key);
              }
            }

            // Remove expired items
            if (keysToRemove.length > 0) {
              keysToRemove.forEach(key => {
                delete cache.items[key];
                const keyIndex = cache.keys.indexOf(key);
                if (keyIndex > -1) {
                  cache.keys.splice(keyIndex, 1);
                }
              });

              this.storage.setItem(this.config.cacheVersion, JSON.stringify(cache));
            }
          } catch (e) {
            console.warn('Error cleaning cache:', e);
            // If error, reset cache
            this.storage.removeItem(this.config.cacheVersion);
            this.init();
          }
        },

        // Clear old items to free up space
        clearOldItems: function() {
          try {
            const cache = JSON.parse(this.storage.getItem(this.config.cacheVersion));
            if (!cache) return;

            // Keep only priority pages and 5 most recent items
            const keysToKeep = [...this.config.priorityPages];
            const recentKeys = cache.keys.slice(-5);

            for (const key of recentKeys) {
              if (!keysToKeep.includes(key)) {
                keysToKeep.push(key);
              }
            }

            // Create new cache with only kept items
            const newCache = {
              items: {},
              keys: [],
              timestamp: Date.now(),
              metadata: cache.metadata || {
                version: this.config.cacheVersion,
                created: Date.now()
              }
            };

            for (const key of keysToKeep) {
              if (cache.items[key]) {
                newCache.items[key] = cache.items[key];
                newCache.keys.push(key);
              }
            }

            this.storage.setItem(this.config.cacheVersion, JSON.stringify(newCache));
          } catch (e) {
            console.warn('Error clearing old items:', e);
            // Last resort
            this.storage.clear();
            this.init();
          }
        },

        // Prefetch priority pages
        prefetchPriorityPages: function() {
          // Use requestIdleCallback to prefetch during browser idle time
          if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
              this.config.priorityPages.forEach(url => {
                if (!this.getItem(url)) {
                  fetch(url)
                    .then(response => response.text())
                    .then(html => {
                      const parser = new DOMParser();
                      const doc = parser.parseFromString(html, 'text/html');
                      const title = doc.title;
                      const content = doc.querySelector('.main-content')?.innerHTML;

                      if (content) {
                        this.setItem(url, {
                          title: title,
                          content: content,
                          timestamp: Date.now()
                        });
                      }
                    })
                    .catch(err => console.warn('Error prefetching priority page:', url, err));
                }
              });
            }, { timeout: 5000 });
          }
        }
      };

      // Initialize when DOM is ready - using DOMContentLoaded for faster initialization
      document.addEventListener('DOMContentLoaded', function() {
        // Initialize cache manager
        CacheManager.init();

        // Initialize SPA functionality
        SPA.init();

        // Add active class to current nav item
        const currentPath = window.location.pathname;
        $(`.nav-menu li a[href="${currentPath}"]`).addClass('active');

        // Initialize lazy loading for images
        if ('IntersectionObserver' in window) {
          // Modern browsers - use IntersectionObserver
          initLazyLoading();
        } else {
          // Legacy browsers - load polyfill first
          const script = document.createElement('script');
          script.src = 'https://polyfill.io/v3/polyfill.min.js?features=IntersectionObserver';
          script.onload = initLazyLoading;
          document.head.appendChild(script);
        }
      });

      // Enhanced lazy loading for images with srcset support
      function initLazyLoading() {
        // Select all lazy images
        const lazyImages = [].slice.call(document.querySelectorAll('img.lazy'));

        if (!lazyImages.length) {
          return; // No lazy images found
        }

        if ('IntersectionObserver' in window) {
          // Create config with rootMargin to start loading images before they appear
          const config = {
            rootMargin: '50px 0px', // Start loading 50px before image enters viewport
            threshold: 0.01 // Trigger when 1% of the image is visible
          };

          const lazyImageObserver = new IntersectionObserver(function(entries, observer) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                const lazyImage = entry.target;

                // Handle srcset if available
                if (lazyImage.dataset.srcset) {
                  lazyImage.srcset = lazyImage.dataset.srcset;
                }

                // Set src (will act as fallback if srcset is available)
                if (lazyImage.dataset.src) {
                  lazyImage.src = lazyImage.dataset.src;
                }

                // Remove lazy class to avoid re-processing
                lazyImage.classList.remove('lazy');

                // Stop observing the image
                observer.unobserve(lazyImage);

                // Dispatch an event that can be used to trigger other actions
                lazyImage.dispatchEvent(new Event('lazyloaded'));
              }
            });
          }, config);

          // Start observing each lazy image
          lazyImages.forEach(function(lazyImage) {
            lazyImageObserver.observe(lazyImage);
          });

          // Prefetch images that are likely to be viewed soon
          prefetchNextImages();
        } else {
          // Fallback for browsers without IntersectionObserver
          // Use a more efficient throttled scroll handler
          let active = false;
          const lazyLoad = throttle(function() {
            if (active === false) {
              active = true;

              setTimeout(function() {
                lazyImages.forEach(function(lazyImage, index) {
                  if ((lazyImage.getBoundingClientRect().top <= window.innerHeight + 100 &&
                       lazyImage.getBoundingClientRect().bottom >= -100) &&
                       getComputedStyle(lazyImage).display !== 'none') {

                    // Handle srcset if available
                    if (lazyImage.dataset.srcset) {
                      lazyImage.srcset = lazyImage.dataset.srcset;
                    }

                    // Set src
                    if (lazyImage.dataset.src) {
                      lazyImage.src = lazyImage.dataset.src;
                    }

                    lazyImage.classList.remove('lazy');

                    // Remove from array to avoid reprocessing
                    lazyImages.splice(index, 1);

                    // If all images are loaded, remove event listeners
                    if (lazyImages.length === 0) {
                      document.removeEventListener('scroll', lazyLoad);
                      window.removeEventListener('resize', lazyLoad);
                      window.removeEventListener('orientationchange', lazyLoad);
                    }
                  }
                });

                active = false;
              }, 200);
            }
          }, 200); // Throttle to run at most every 200ms

          // Add event listeners
          document.addEventListener('scroll', lazyLoad);
          window.addEventListener('resize', lazyLoad);
          window.addEventListener('orientationchange', lazyLoad);

          // Initial load check
          lazyLoad();
        }
      }

      // Throttle function to limit how often a function runs
      function throttle(func, limit) {
        let lastFunc;
        let lastRan;
        return function() {
          const context = this;
          const args = arguments;
          if (!lastRan) {
            func.apply(context, args);
            lastRan = Date.now();
          } else {
            clearTimeout(lastFunc);
            lastFunc = setTimeout(function() {
              if ((Date.now() - lastRan) >= limit) {
                func.apply(context, args);
                lastRan = Date.now();
              }
            }, limit - (Date.now() - lastRan));
          }
        };
      }

      // Prefetch next set of images that are likely to be viewed
      function prefetchNextImages() {
        // Use requestIdleCallback to prefetch during browser idle time
        if ('requestIdleCallback' in window) {
          requestIdleCallback(function() {
            // Find visible post cards and prefetch the next few
            const visibleCards = document.querySelectorAll('.post-card:not(.prefetched)');
            let count = 0;

            visibleCards.forEach(function(card) {
              // Limit to next 3 cards to avoid excessive prefetching
              if (count < 3) {
                card.classList.add('prefetched');

                // Find next siblings that aren't yet in viewport
                let nextCard = card.nextElementSibling;
                while (nextCard && count < 3) {
                  const img = nextCard.querySelector('img.lazy');
                  if (img && img.dataset.src) {
                    // Create a new image to prefetch without displaying
                    const prefetchImg = new Image();
                    prefetchImg.src = img.dataset.src;
                    count++;
                  }
                  nextCard = nextCard.nextElementSibling;
                }
              }
            });
          }, { timeout: 2000 }); // 2 second timeout
        }
      }
    })(jQuery);

    // Related Posts Function
    function relatedPosts(json) {
      var content = '';

      for (var i = 0; i < json.feed.entry.length; i++) {
        var entry = json.feed.entry[i];
        var title = entry.title.$t;
        var url = '';

        // Get the post URL
        for (var j = 0; j < entry.link.length; j++) {
          if (entry.link[j].rel == 'alternate') {
            url = entry.link[j].href;
            break;
          }
        }

        // Get the post thumbnail
        var thumbnail = '';
        if (entry.media$thumbnail && entry.media$thumbnail.url) {
          thumbnail = entry.media$thumbnail.url;
        } else {
          thumbnail = 'https://via.placeholder.com/500x300';
        }

        // Create the related post card
        content += '<article class="post-card">';
        content += '<div class="post-thumbnail-container">';
        content += '<a href="' + url + '">';
        content += '<img class="post-thumbnail" src="' + thumbnail + '" alt="' + title + '">';
        content += '</a>';
        content += '</div>';
        content += '<div class="post-content">';
        content += '<h2 class="post-title"><a href="' + url + '">' + title + '</a></h2>';
        content += '</div>';
        content += '</article>';
      }

      // Add the related posts to the container
      document.querySelector('.related-posts .post-grid').innerHTML = content;
    }
    //
  ]]></b:js>
</head>

<body>
  <!-- Reading Progress Bar -->
  <div class='reading-progress-container'>
    <div class='reading-progress-bar'></div>
  </div>

  <!-- Reading Progress Toggle Button -->
  <button class='reading-progress-toggle' title='Toggle reading progress indicator'>
    <i class='fa fa-chart-line'></i>
  </button>

  <!-- Fallback for when JavaScript is disabled -->
  <noscript>
    <div class='noscript-warning'>
      <div class='container'>
        <p>For the best experience, please enable JavaScript in your browser settings.</p>
      </div>
    </div>
    <style>
      .page-loader { display: none !important; }
    </style>
  </noscript>
  <!-- Main template structure -->
  <b:section id='navbar' maxwidgets='1' showaddelement='false'>
    <b:widget id='Navbar1' locked='true' title='Navbar' type='Navbar'/>
  </b:section>

  <div class='container'>
    <!-- Header -->
    <b:section class='header' id='header' maxwidgets='1' showaddelement='false'>
      <b:widget id='Header1' locked='false' title='Kanahola Magazine (Header)' type='Header'>
        <b:includable id='main' var='this'>
          <div class='header-inner'>
            <div class='logo'>
              <a expr:href='data:blog.homepageUrl'>
                <b:if cond='data:imageUrl'>
                  <img expr:alt='data:title' expr:src='data:imageUrl'/>
                <b:else/>
                  <h1><data:title/></h1>
                </b:if>
              </a>
            </div>

            <button class='mobile-menu-toggle' aria-label='Toggle menu'>
              <i class='fa fa-bars'></i>
            </button>
        </b:includable>
      </b:widget>
    </b:section>

        <b:section class='navigation' id='navigation' maxwidgets='1' showaddelement='false'>
          <b:widget id='PageList1' locked='false' title='Navigation Menu' type='PageList'>
            <b:includable id='main'>
              <nav class='navigation'>
                <ul class='nav-menu'>
                  <b:loop values='data:links' var='link'>
                    <li>
                      <a expr:href='data:link.href'><data:link.title/></a>
                    </li>
                  </b:loop>
                  <li>
                    <button class='theme-toggle' title='Toggle dark mode' aria-label='Toggle dark/light mode' role='switch' aria-checked='false'>
                      <i class='theme-toggle-icon fa fa-moon' aria-hidden='true'></i>
                      <span class='sr-only'>Toggle dark mode</span>
                    </button>
                  </li>
                </ul>
              </nav>
            </b:includable>
          </b:widget>
        </b:section>
      </div>
    </div>

    <!-- Main content wrapper -->
    <div class='content-wrapper'>
      <!-- Main content area -->
      <main class='main-content'>
        <!-- Featured Section (Homepage only) -->
        <b:if cond='data:view.isHomepage'>
          <section class='featured-section'>
            <b:section id='featured-posts' maxwidgets='1' showaddelement='false'>
              <b:widget id='FeaturedPost1' locked='false' title='Featured Post' type='FeaturedPost'/>
            </b:section>
          </section>
        </b:if>

        <!-- Main Posts Section -->
        <section class='posts-section'>
          <b:section id='main' showaddelement='false'>
            <b:widget id='Blog1' locked='true' title='Blog Posts' type='Blog'>
              <b:includable id='main' var='top'>
                <!-- Check for 404 error page -->
                <b:if cond='data:view.isError'>
                  <b:include name='error-page'/>
                <b:else/>
                  <b:if cond='data:mobileIndex'>
                    <!-- Mobile index -->
                    <div class='blog-posts hfeed'>
                      <b:loop values='data:posts' var='post'>
                        <b:include data='post' name='mobile-index-post'/>
                      </b:loop>
                    </div>
                    <b:include name='mobile-nextprev'/>
                  <b:else/>
                    <!-- Desktop index -->
                    <div class='blog-posts hfeed'>
                      <b:if cond='data:view.isMultipleItems'>
                        <!-- Multiple items -->
                        <div class='post-grid'>
                          <b:loop values='data:posts' var='post'>
                            <b:include data='post' name='post-card'/>
                          </b:loop>
                        </div>
                        <div class='infinite-scroll-loader'>
                          <div class='loader-spinner'></div>
                          <p>Loading more posts...</p>
                        </div>
                        <b:include name='nextprev'/>
                      <b:else/>
                        <!-- Single item -->
                        <b:loop values='data:posts' var='post'>
                          <b:include data='post' name='post'/>
                        </b:loop>
                      </b:if>
                    </div>
                  </b:if>
                  <b:include name='feedLinks'/>
                </b:if>
              </b:includable>

              <b:includable id='post-card' var='post'>
                <article class='post-card'>
                  <b:if cond='data:post.featuredImage'>
                    <div class='post-thumbnail-container'>
                      <a expr:href='data:post.url'>
                        <!-- Enhanced image optimization with low-quality image placeholder (LQIP) -->
                        <picture>
                          <!-- WebP format for modern browsers -->
                          <source
                            expr:srcset='data:post.featuredImage.isResizable ?
                                        resizeImage(data:post.featuredImage, 400, "400w.webp") + ", " +
                                        resizeImage(data:post.featuredImage, 800, "800w.webp") + ", " +
                                        data:post.featuredImage + ".webp 1200w" :
                                        data:post.featuredImage + ".webp"'
                            expr:sizes='(max-width: 576px) 100vw, (max-width: 992px) 50vw, 33vw'
                            type='image/webp'/>

                          <!-- Fallback for browsers that don't support WebP -->
                          <img class='post-thumbnail lazy'
                               expr:alt='data:post.title'
                               expr:data-src='data:post.featuredImage'
                               expr:data-srcset='data:post.featuredImage + " 1200w, " +
                                                data:post.featuredImage.isResizable ?
                                                resizeImage(data:post.featuredImage, 800, "800w") + ", " +
                                                resizeImage(data:post.featuredImage, 400, "400w") : ""'
                               expr:sizes='(max-width: 576px) 100vw, (max-width: 992px) 50vw, 33vw'
                               src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='
                               loading='lazy'
                               decoding='async'
                               fetchpriority='low'/>
                        </picture>

                        <!-- Preload next image on hover -->
                        <script>
                          document.addEventListener('DOMContentLoaded', function() {
                            const link = document.querySelector('a[href="<data:post.url/>"]');
                            if (link) {
                              link.addEventListener('mouseenter', function() {
                                const nextCard = this.closest('.post-card').nextElementSibling;
                                if (nextCard) {
                                  const nextImg = nextCard.querySelector('img.lazy');
                                  if (nextImg && nextImg.dataset.src) {
                                    const preloadImg = new Image();
                                    preloadImg.src = nextImg.dataset.src;
                                  }
                                }
                              });
                            }
                          });
                        </script>
                      </a>
                    </div>
                  </b:if>
                  <div class='post-content'>
                    <h2 class='post-title'>
                      <a expr:href='data:post.url'><data:post.title/></a>
                    </h2>
                    <div class='post-meta'>
                      <span class='post-date'><data:post.date/></span>
                      <b:if cond='data:post.author'>
                        <span class='post-author'>by <data:post.author.name/></span>
                      </b:if>
                      <!-- Add estimated reading time -->
                      <span class='reading-time'>
                        <i class='far fa-clock'></i>
                        <span class='reading-time-text'>
                          <b:eval expr='data:post.snippets.short.length / 1000 * 60 > 1 ?
                                        Math.ceil(data:post.snippets.short.length / 1000 * 60) :
                                        1'/> min read
                        </span>
                      </span>
                    </div>
                    <div class='post-excerpt'>
                      <b:eval expr='data:post.snippets.short snippet { length: 120, links: false, linebreaks: false, ellipsis: true }'/>
                    </div>
                    <a class='read-more' expr:href='data:post.url'>Read More</a>
                  </div>
                </article>
              </b:includable>

              <b:includable id='post' var='post'>
                <div class='single-post'>
                  <article class='post hentry' expr:id='&quot;post-&quot; + data:post.id'>
                    <h1 class='post-title entry-title'>
                      <b:if cond='data:post.link or (data:post.url and data:blog.url != data:post.url)'>
                        <a expr:href='data:post.link ?: data:post.url'><data:post.title/></a>
                      <b:else/>
                        <data:post.title/>
                      </b:if>
                    </h1>

                    <div class='post-meta'>
                      <span class='post-date'><data:post.date/></span>
                      <b:if cond='data:post.author'>
                        <span class='post-author'>by <data:post.author.name/></span>
                      </b:if>
                      <b:if cond='data:post.labels'>
                        <span class='post-labels'>
                          <b:loop values='data:post.labels' var='label'>
                            <a expr:href='data:label.url' rel='tag'><data:label.name/></a><b:if cond='not data:label.isLast'>,</b:if>
                          </b:loop>
                        </span>
                      </b:if>
                      <span class='reading-time'>
                        <i class='fa fa-clock'></i>
                        <span class='reading-time-text'></span>
                      </span>
                    </div>

                    <b:if cond='data:post.featuredImage'>
                      <div class='post-featured-image'>
                        <!-- Enhanced featured image with WebP support and better loading strategy -->
                        <picture>
                          <!-- WebP format for modern browsers -->
                          <source
                            expr:srcset='data:post.featuredImage.isResizable ?
                                        resizeImage(data:post.featuredImage, 400, "400w.webp") + ", " +
                                        resizeImage(data:post.featuredImage, 800, "800w.webp") + ", " +
                                        data:post.featuredImage + ".webp 1200w" :
                                        data:post.featuredImage + ".webp"'
                            expr:sizes='(max-width: 576px) 100vw, (max-width: 992px) 100vw, 800px'
                            type='image/webp'/>

                          <!-- Fallback for browsers that don't support WebP -->
                          <img class='featured-image'
                               expr:alt='data:post.title'
                               expr:src='data:post.featuredImage'
                               expr:srcset='data:post.featuredImage + " 1200w, " +
                                           data:post.featuredImage.isResizable ?
                                           resizeImage(data:post.featuredImage, 800, "800w") + ", " +
                                           resizeImage(data:post.featuredImage, 400, "400w") : ""'
                               expr:sizes='(max-width: 576px) 100vw, (max-width: 992px) 100vw, 800px'
                               loading='eager'
                               fetchpriority='high'
                               decoding='async'/>
                        </picture>

                        <!-- Image lightbox functionality -->
                        <div class='image-lightbox-overlay'>
                          <button class='lightbox-button' aria-label='View full image'>
                            <i class='fas fa-search-plus'></i>
                          </button>
                        </div>

                        <script>
                          document.addEventListener('DOMContentLoaded', function() {
                            const featuredImage = document.querySelector('.post-featured-image img');
                            const lightboxButton = document.querySelector('.lightbox-button');

                            if (featuredImage && lightboxButton) {
                              lightboxButton.addEventListener('click', function() {
                                // Create lightbox
                                const lightbox = document.createElement('div');
                                lightbox.className = 'image-lightbox';
                                lightbox.innerHTML = `
                                  <div class="lightbox-content">
                                    <img src="${featuredImage.src}" alt="${featuredImage.alt}">
                                    <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
                                  </div>
                                `;

                                document.body.appendChild(lightbox);
                                document.body.style.overflow = 'hidden';

                                // Close lightbox on click
                                lightbox.addEventListener('click', function(e) {
                                  if (e.target === lightbox || e.target.className === 'lightbox-close') {
                                    document.body.removeChild(lightbox);
                                    document.body.style.overflow = '';
                                  }
                                });

                                // Close on escape key
                                document.addEventListener('keydown', function(e) {
                                  if (e.key === 'Escape' && document.querySelector('.image-lightbox')) {
                                    document.body.removeChild(lightbox);
                                    document.body.style.overflow = '';
                                  }
                                });
                              });
                            }
                          });
                        </script>
                      </div>
                    </b:if>

                    <div class='post-body entry-content' expr:id='&quot;post-body-&quot; + data:post.id'>
                      <!-- Insert premium content gate after first few paragraphs for posts with premium label -->
                      <b:if cond='data:post.labels any (l =&gt; l.name == "premium")'>
                        <b:with value='data:post.body' var='postBody'>
                          <!-- Display first 3 paragraphs -->
                          <b:eval expr='postBody.substring(0, postBody.indexOf("</p>", postBody.indexOf("</p>", postBody.indexOf("</p>") + 4) + 4) + 4)'/>

                          <!-- Premium Content Gate with EmailKit Integration -->
                          <div class='premium-content-gate'>
                            <h3>This is Premium Content</h3>
                            <p>Subscribe to our newsletter to continue reading this premium article and get access to all our exclusive content.</p>
                            <!-- EmailKit Trigger Button -->
                            <button class='newsletter-trigger' id='premium-content-trigger' style='background-color: var(--primary-color); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: 4px; font-weight: 600; cursor: pointer; width: 100%; max-width: 400px; margin: var(--spacing-md) auto; display: block;'>
                              Subscribe to Continue Reading
                            </button>
                            <!-- Keep the original form for fallback but hide it -->
                            <form class='newsletter-form-input' id='premium-content-form' style='display: none;'>
                              <input type='text' name='name' placeholder='Your Name' required/>
                              <input type='email' name='email' placeholder='Your Email' required/>
                              <button type='submit'>Subscribe to Continue Reading</button>
                            </form>
                          </div>

                          <!-- Hidden premium content (will be shown after subscription) -->
                          <div class='premium-content-hidden' style='display: none;'>
                            <b:eval expr='postBody.substring(postBody.indexOf("</p>", postBody.indexOf("</p>", postBody.indexOf("</p>") + 4) + 4) + 4)'/>
                          </div>
                        </b:with>
                      <b:else/>
                        <data:post.body/>
                      </b:if>
                    </div>

                    <div class='post-footer'>
                      <!-- Post View Counter -->
                      <div class='post-view-counter'>
                        <i class='fas fa-eye'></i> <span>0 views</span>
                      </div>

                      <!-- Reading Engagement Meter -->
                      <div class='reading-engagement'>
                        <div class='reading-time-container'>
                          <i class='fas fa-book-reader'></i> <span>Reading engagement</span>
                        </div>
                        <div class='engagement-meter'>
                          <div class='engagement-meter-fill'></div>
                        </div>
                      </div>

                      <!-- Enhanced Social Share -->
                      <div class='post-share'>
                        <h4>Share This Post</h4>
                        <div class='social-share-container'>
                          <a class='social-share-button facebook' data-platform='facebook' expr:href='&quot;https://www.facebook.com/sharer/sharer.php?u=&quot; + data:post.url' rel='nofollow' target='_blank' aria-label='Share on Facebook'>
                            <i class='fab fa-facebook-f'></i>
                          </a>
                          <span class='social-share-counter' data-platform='facebook'>0</span>

                          <a class='social-share-button twitter' data-platform='twitter' expr:href='&quot;https://twitter.com/intent/tweet?url=&quot; + data:post.url + &quot;&amp;text=&quot; + data:post.title' rel='nofollow' target='_blank' aria-label='Share on Twitter'>
                            <i class='fab fa-twitter'></i>
                          </a>
                          <span class='social-share-counter' data-platform='twitter'>0</span>

                          <a class='social-share-button pinterest' data-platform='pinterest' expr:href='&quot;https://pinterest.com/pin/create/button/?url=&quot; + data:post.url + &quot;&amp;description=&quot; + data:post.title' rel='nofollow' target='_blank' aria-label='Share on Pinterest'>
                            <i class='fab fa-pinterest-p'></i>
                          </a>
                          <span class='social-share-counter' data-platform='pinterest'>0</span>

                          <a class='social-share-button linkedin' data-platform='linkedin' expr:href='&quot;https://www.linkedin.com/sharing/share-offsite/?url=&quot; + data:post.url' rel='nofollow' target='_blank' aria-label='Share on LinkedIn'>
                            <i class='fab fa-linkedin-in'></i>
                          </a>
                          <span class='social-share-counter' data-platform='linkedin'>0</span>

                          <a class='social-share-button whatsapp' data-platform='whatsapp' expr:href='&quot;https://api.whatsapp.com/send?text=&quot; + data:post.title + &quot; &quot; + data:post.url' rel='nofollow' target='_blank' aria-label='Share on WhatsApp'>
                            <i class='fab fa-whatsapp'></i>
                          </a>
                          <span class='social-share-counter' data-platform='whatsapp'>0</span>
                        </div>
                      </div>

                      <b:if cond='data:post.labels'>
                        <div class='post-tags'>
                          <h4>Tags</h4>
                          <div class='tags'>
                            <b:loop values='data:post.labels' var='label'>
                              <a expr:href='data:label.url' rel='tag'><data:label.name/></a>
                            </b:loop>
                          </div>
                        </div>
                      </b:if>

                      <!-- Print and Reading Tools -->
                      <div class='post-tools'>
                        <h4>Article Tools</h4>
                        <div class='tools-buttons'>
                          <!-- Print Button -->
                          <button class='tool-button print-button' title='Print this article'>
                            <i class='fas fa-print'></i> Print Article
                          </button>

                          <!-- Toggle Table of Contents Button -->
                          <button class='tool-button toggle-toc-button' title='Toggle table of contents'>
                            <i class='fas fa-list'></i> Toggle Contents
                          </button>

                          <!-- Scroll to Top Button -->
                          <button class='tool-button scroll-top-button' title='Scroll to top'>
                            <i class='fas fa-arrow-up'></i> Back to Top
                          </button>
                        </div>

                        <script>
                          document.addEventListener('DOMContentLoaded', function() {
                            // Print button functionality - will be handled by our enhanced JavaScript
                            // This is kept for backward compatibility with older browsers
                            const printButton = document.querySelector('.print-button');
                            if (printButton) {
                              printButton.addEventListener('click', function() {
                                // Add current URL and date to the single post for print footer
                                const singlePost = document.querySelector('.single-post');
                                if (singlePost) {
                                  singlePost.setAttribute('data-url', window.location.href);
                                  singlePost.setAttribute('data-print-date', new Date().toLocaleDateString());
                                }
                                window.print();
                              });
                            }

                            // Toggle TOC button functionality
                            const tocButton = document.querySelector('.toggle-toc-button');
                            const toc = document.querySelector('.table-of-contents');
                            if (tocButton && toc) {
                              tocButton.addEventListener('click', function() {
                                toc.classList.toggle('hidden');
                                if (toc.classList.contains('hidden')) {
                                  tocButton.innerHTML = '<i class="fas fa-list"></i> Show Contents';
                                } else {
                                  tocButton.innerHTML = '<i class="fas fa-list"></i> Hide Contents';
                                }
                              });
                            } else if (tocButton) {
                              // Hide button if no TOC exists
                              tocButton.style.display = 'none';
                            }

                            // Scroll to top button functionality
                            const scrollTopButton = document.querySelector('.scroll-top-button');
                            if (scrollTopButton) {
                              scrollTopButton.addEventListener('click', function() {
                                window.scrollTo({
                                  top: 0,
                                  behavior: 'smooth'
                                });
                              });
                            }
                          });
                        </script>
                      </div>
                    </div>
                  </article>

                  <b:if cond='data:blog.pageType == &quot;item&quot;'>
                    <!-- Related posts -->
                    <div class='related-posts'>
                      <h3>You May Also Like</h3>
                      <div class='post-grid'>
                        <b:loop values='data:post.labels' var='label'>
                          <b:if cond='data:label.isFirst'>
                            <script expr:src='&quot;/feeds/posts/default/-/&quot; + data:label.name + &quot;?alt=json-in-script&amp;callback=relatedPosts&amp;max-results=3&quot;'/>
                          </b:if>
                        </b:loop>
                      </div>
                    </div>

                    <!-- Comments -->
                    <b:include data='post' name='comments'/>
                  </b:if>
                </div>
              </b:includable>

              <!-- Custom 404 Error Page -->
              <b:includable id='error-page'>
                <div class='error-page'>
                  <div class='error-code'>404</div>
                  <h1 class='error-title'>Page Not Found</h1>
                  <p class='error-message'>The page you were looking for doesn't exist or has been moved.</p>
                  <div class='error-actions'>
                    <a href='/' class='btn btn-primary'>Go to Homepage</a>
                    <a href='/p/contact.html' class='btn btn-secondary'>Contact Us</a>
                  </div>
                </div>
              </b:includable>

              <!-- Enhanced Comments Section -->
              <b:includable id='comments' var='post'>
                <div class='comments' id='comments'>
                  <h3>
                    <b:if cond='data:post.numComments == 1'>
                      1 Comment
                    <b:else/>
                      <data:post.numComments/> Comments
                    </b:if>
                  </h3>

                  <b:if cond='data:post.allowComments'>
                    <div class='comments-content'>
                      <div id='comment-holder'>
                        <data:post.commentHtml/>
                      </div>
                    </div>

                    <p class='comment-footer'>
                      <b:if cond='data:post.embedCommentForm'>
                        <b:if cond='data:post.allowNewComments'>
                          <b:include data='post' name='comment-form'/>
                        <b:else/>
                          <data:post.noNewCommentsText/>
                        </b:if>
                      <b:else/>
                        <b:if cond='data:post.allowComments'>
                          <a expr:href='data:post.addCommentUrl' expr:onclick='data:post.addCommentOnclick'>
                            <data:post.addCommentText/>
                          </a>
                        </b:if>
                      </b:if>
                    </p>
                  </b:if>
                </div>
              </b:includable>

              <!-- Comment Form -->
              <b:includable id='comment-form' var='post'>
                <div class='comment-form'>
                  <a name='comment-form'></a>
                  <h4 id='comment-post-message'>Leave a Comment</h4>
                  <b:if cond='data:this.messages.blogComment != &quot;&quot;'>
                    <p><data:this.messages.blogComment/></p>
                  </b:if>
                  <div class='comment-form-container'>
                    <form expr:action='data:post.commentFormIframeSrc' expr:id='data:widget.instanceId + &quot;_comment-form&quot;' method='post' name='commentForm' target='commentIframe'>
                      <input name='postID' type='hidden' value='<data:post.id'/>
                      <textarea name='commentBody' placeholder='Write your comment here...'></textarea>
                      <div class='comment-form-footer'>
                        <button type='submit'>Post Comment</button>
                      </div>
                    </form>
                  </div>
                  <iframe allowtransparency='allowtransparency' expr:id='data:widget.instanceId + &quot;_comment-editor&quot;' expr:name='data:widget.instanceId + &quot;_comment-editor&quot;' expr:src='data:post.commentFormIframeSrc' frameborder='0' height='0' width='0'></iframe>
                  <script type='text/javascript'>
                    BLOG_CMT_createIframe('<data:post.appRpcRelayPath/>');
                  </script>
                </div>
              </b:includable>
            </b:widget>
          </b:section>
        </section>
      </main>

      <!-- Sidebar -->
      <aside class='sidebar'>
        <b:section class='sidebar-section' id='sidebar-top' maxwidgets='3' showaddelement='true'>
          <!-- Reading Settings Widget -->
          <b:widget id='HTML1' locked='false' title='Reading Settings' type='HTML'>
            <b:includable id='main'>
              <div class='widget reading-settings-widget'>
                <h3 class='widget-title'><data:title/></h3>
                <div class='widget-content'>
                  <!-- Font Size Controls -->
                  <div class='font-size-controls'>
                    <span>Text Size:</span>
                    <button class='font-size-btn' data-size='small' title='Small text'>A-</button>
                    <button class='font-size-btn' data-size='medium' title='Medium text'>A</button>
                    <button class='font-size-btn' data-size='large' title='Large text'>A+</button>
                    <button class='font-size-btn' data-size='xlarge' title='Extra large text'>A++</button>
                  </div>
                </div>
              </div>
            </b:includable>
          </b:widget>

          <!-- Infinite Scroll Toggle Widget -->
          <b:widget id='HTML2' locked='false' title='Infinite Scroll Toggle' type='HTML'>
            <b:includable id='main'>
              <div class='widget'>
                <div class='widget-content'>
                  <div class='infinite-scroll-toggle'>
                    <label class='toggle-switch'>
                      <input type='checkbox' id='infinite-scroll-toggle'/>
                      <span class='toggle-slider'></span>
                    </label>
                    <span>Enable Infinite Scrolling</span>
                  </div>
                </div>
              </div>
            </b:includable>
          </b:widget>

          <!-- Newsletter Widget with EmailKit Integration -->
          <b:widget id='HTML3' locked='false' title='Subscribe to Our Newsletter' type='HTML'>
            <b:includable id='main'>
              <div class='widget newsletter-widget'>
                <h3 class='widget-title'><data:title/></h3>
                <div class='widget-content'>
                  <div class='newsletter-form'>
                    <p>Get the latest articles, exclusive content, and updates delivered straight to your inbox.</p>
                    <!-- EmailKit Trigger Button -->
                    <button class='newsletter-trigger' style='background-color: var(--primary-color); color: white; border: none; padding: var(--spacing-sm) var(--spacing-md); border-radius: 4px; font-weight: 600; cursor: pointer; width: 100%; margin-top: var(--spacing-md);'>
                      Subscribe to Newsletter
                    </button>
                    <!-- Keep the original form for fallback but hide it -->
                    <form class='newsletter-form-input' id='sidebar-newsletter-form' style='display: none;'>
                      <input type='text' name='name' placeholder='Your Name' required/>
                      <input type='email' name='email' placeholder='Your Email' required/>
                      <button type='submit'>Subscribe</button>
                    </form>
                  </div>
                </div>
              </div>
            </b:includable>
          </b:widget>
        </b:section>

        <b:section class='sidebar-section' id='sidebar-middle' maxwidgets='3' showaddelement='true'>
          <!-- Sidebar Ad Widget -->
          <b:widget id='HTML4' locked='false' title='Advertisement' type='HTML'>
            <b:includable id='main'>
              <div class='widget'>
                <div class='widget-content'>
                  <div class='ad-container sidebar-ad' id='sidebar-ad-1'>
                    <span class='ad-label'>Advertisement</span>
                    <!-- Ad content will be inserted by JavaScript -->
                  </div>
                </div>
              </div>
            </b:includable>
          </b:widget>

          <!-- About Widget -->
          <b:widget id='HTML5' locked='false' title='About Kanahola' type='HTML'>
            <b:includable id='main'>
              <div class='widget about-widget'>
                <h3 class='widget-title'><data:title/></h3>
                <div class='widget-content'>
                  <div class='about-content'>
                    <img src='https://via.placeholder.com/300x200' alt='About Kanahola' class='about-image'/>
                    <p>Kanahola Magazine is your source for the latest in lifestyle, travel, food, and culture. Join us as we explore the world around us.</p>
                    <a href='/p/about.html' class='read-more'>Read More</a>
                  </div>
                </div>
              </div>
            </b:includable>
          </b:widget>
        </b:section>

        <!-- Popular Posts Widget -->
        <b:section id='sidebar' showaddelement='true'>
          <b:widget id='PopularPosts1' locked='false' title='Popular Posts' type='PopularPosts'/>
          <b:widget id='Label1' locked='false' title='Categories' type='Label'/>
          <b:widget id='FollowByEmail1' locked='false' title='Subscribe by Email' type='FollowByEmail'/>
          <b:widget id='BlogArchive1' locked='false' title='Archive' type='BlogArchive'/>
        </b:section>

        <b:section class='sidebar-section' id='sidebar-bottom' maxwidgets='2' showaddelement='true'>
          <!-- Sidebar Ad (Bottom) Widget -->
          <b:widget id='HTML9' locked='false' title='Advertisement' type='HTML'>
            <b:includable id='main'>
              <div class='widget'>
                <div class='widget-content'>
                  <div class='ad-container sidebar-ad' id='sidebar-ad-2'>
                    <span class='ad-label'>Advertisement</span>
                    <!-- Ad content will be inserted by JavaScript -->
                  </div>
                </div>
              </div>
            </b:includable>
          </b:widget>
        </b:section>
      </aside>
    </div>

    <!-- Footer -->
    <footer class='footer'>
      <b:section class='footer-section' id='footer-widgets' maxwidgets='4' showaddelement='true'>
        <!-- Footer Widget 1 -->
        <b:widget id='HTML6' locked='false' title='About Kanahola' type='HTML'>
          <b:includable id='main'>
            <div class='footer-widget'>
              <h3><data:title/></h3>
              <div class='widget-content'>
                <p>Kanahola Magazine is your source for the latest in lifestyle, travel, food, and culture.</p>
              </div>
            </div>
          </b:includable>
        </b:widget>

        <!-- Footer Widget 2 -->
        <b:widget id='HTML7' locked='false' title='Categories' type='HTML'>
          <b:includable id='main'>
            <div class='footer-widget'>
              <h3><data:title/></h3>
              <div class='widget-content'>
                <ul>
                  <li><a href='/search/label/lifestyle'>Lifestyle</a></li>
                  <li><a href='/search/label/travel'>Travel</a></li>
                  <li><a href='/search/label/food'>Food</a></li>
                  <li><a href='/search/label/culture'>Culture</a></li>
                </ul>
              </div>
            </div>
          </b:includable>
        </b:widget>

        <!-- Footer Widget 3 -->
        <b:widget id='LinkList1' locked='false' title='Quick Links' type='LinkList'>
          <b:includable id='main'>
            <div class='footer-widget'>
              <h3><data:title/></h3>
              <div class='widget-content'>
                <ul>
                  <b:loop values='data:links' var='link'>
                    <li><a expr:href='data:link.target'><data:link.name/></a></li>
                  </b:loop>
                </ul>
              </div>
            </div>
          </b:includable>
        </b:widget>

        <!-- Footer Widget 4 -->
        <b:widget id='HTML8' locked='false' title='Follow Us' type='HTML'>
          <b:includable id='main'>
            <div class='footer-widget'>
              <h3><data:title/></h3>
              <div class='widget-content'>
                <div class='social-icons'>
                  <a href='#' aria-label='Facebook'><i class='fa fa-facebook'></i></a>
                  <a href='#' aria-label='Twitter'><i class='fa fa-twitter'></i></a>
                  <a href='#' aria-label='Instagram'><i class='fa fa-instagram'></i></a>
                  <a href='#' aria-label='Pinterest'><i class='fa fa-pinterest'></i></a>
                </div>
              </div>
            </div>
          </b:includable>
        </b:widget>
      </b:section>

      <div class='footer-bottom'>
        <p>&copy; <script>document.write(new Date().getFullYear())</script> Kanahola Magazine. All Rights Reserved.</p>
      </div>
    </footer>
  </div>

  <!-- Loading indicator for SPA -->
  <div class='page-loader' style='display: none;'>
    <div class='loader-spinner'></div>
  </div>

  <!-- Exit Intent Newsletter Popup -->
  <div class='exit-intent-popup' id='exit-intent-popup'>
    <div class='exit-intent-popup-content'>
      <button class='exit-intent-popup-close' aria-label='Close popup'>&times;</button>
      <h2>Before You Go!</h2>
      <p>Subscribe to our newsletter and never miss our latest content, exclusive offers, and updates.</p>
      <form class='newsletter-form-input' id='exit-intent-newsletter-form'>
        <input type='text' name='name' placeholder='Your Name' required/>
        <input type='email' name='email' placeholder='Your Email' required/>
        <button type='submit'>Subscribe</button>
      </form>
    </div>
  </div>

  <!-- Ad Blocker Notice -->
  <div class='ad-blocker-notice' id='ad-blocker-notice'>
    <div class='ad-blocker-notice-content'>
      <h2>We noticed you're using an ad blocker</h2>
      <p>We need money to write and buy media rights. Please consider supporting us by disabling your ad blocker for our site. Thank you for your cooperation!</p>
      <button id='ad-blocker-notice-close'>Continue to Site</button>
    </div>
  </div>

  <!-- jQuery library (required for SPA functionality) -->
  <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>

  <!-- EmailKit Newsletter Integration -->
  <script async data-uid="11e1f6b801" src="https://thedo.kit.com/11e1f6b801/index.js"></script>

  <!-- Mobile Gestures Script is already included inline in the head section -->

  <!-- Offline Status Indicator -->
  <div class='offline-status' id='offline-status'>
    <div class='offline-status-content'>
      <i class='fas fa-wifi-slash'></i>
      <span>You are offline. Some features may be limited.</span>
    </div>
  </div>

  <!-- Defer non-critical JavaScript -->
  <script>
    // Lazy load Font Awesome
    function loadFontAwesome() {
      const fontAwesome = document.createElement('link');
      fontAwesome.rel = 'stylesheet';
      fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css';
      document.head.appendChild(fontAwesome);
    }

    // Simplified offline detection for Blogger compatibility
    function initOfflineDetection() {
      const offlineStatus = document.getElementById('offline-status');

      // Check if currently offline
      if (!navigator.onLine) {
        offlineStatus.classList.add('active');
      }

      // Listen for online/offline events
      window.addEventListener('online', function() {
        offlineStatus.classList.remove('active');

        // Show online notification
        showNotification('You are back online!', 'success');
      });

      window.addEventListener('offline', function() {
        offlineStatus.classList.add('active');

        // Show offline notification
        showNotification('You are offline. Some features may be limited.', 'warning');
      });

      // Helper function to show notifications
      function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = 'notification ' + (type || '');
        notification.innerHTML = '<div class="notification-content">' + message + '</div>';
        document.body.appendChild(notification);

        // Show with animation
        setTimeout(function() {
          notification.classList.add('active');
        }, 100);

        // Hide after delay
        setTimeout(function() {
          notification.classList.remove('active');
          setTimeout(function() {
            notification.remove();
          }, 300);
        }, 3000);
      }

      // Create offline page if it doesn't exist
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        // Create a simple offline page
        const offlineHtml = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>You're Offline - Kanahola Magazine</title>
            <style>
              body {
                font-family: 'Source Sans Pro', sans-serif;
                text-align: center;
                padding: 40px 20px;
                background-color: #f8f9fa;
                color: #333;
              }
              .container {
                max-width: 600px;
                margin: 0 auto;
                background: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }
              h1 { color: #e63946; margin-bottom: 20px; }
              .offline-icon { font-size: 60px; margin-bottom: 20px; }
              .button {
                background: #e63946;
                color: white;
                padding: 12px 24px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                transition: background 0.3s;
              }
              .button:hover {
                background: #d62b39;
              }
              .cached-content {
                margin-top: 30px;
                text-align: left;
                border-top: 1px solid #eee;
                padding-top: 20px;
              }
              .cached-content h2 {
                font-size: 18px;
                margin-bottom: 15px;
              }
              .cached-links {
                list-style: none;
                padding: 0;
              }
              .cached-links li {
                margin-bottom: 10px;
              }
              .cached-links a {
                color: #1d3557;
                text-decoration: none;
              }
              .cached-links a:hover {
                text-decoration: underline;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="offline-icon"></div>
              <h1>You're Offline</h1>
              <p>Please check your internet connection and try again.</p>
              <button class="button" onclick="window.location.reload()">Try Again</button>

              <div class="cached-content">
                <h2>Available Offline Content</h2>
                <p>You can still access these previously visited pages:</p>
                <ul class="cached-links" id="cached-links">
                  <!-- Links will be populated by JavaScript -->
                  <li><a href="/">Home</a></li>
                </ul>
              </div>
            </div>

            <script>
              // This script will run when the offline page is shown
              // It attempts to list cached pages that are available offline
              if ('caches' in window) {
                caches.open('kanahola-v1').then(cache => {
                  cache.keys().then(requests => {
                    const htmlRequests = requests.filter(request => {
                      const url = new URL(request.url);
                      return url.pathname === '/' ||
                             !url.pathname.includes('.') ||
                             url.pathname.includes('/p/') ||
                             url.pathname.includes('/search/label/');
                    });

                    const cachedLinksList = document.getElementById('cached-links');
                    if (htmlRequests.length > 0) {
                      cachedLinksList.innerHTML = '';
                      htmlRequests.forEach(request => {
                        const url = new URL(request.url);
                        const title = url.pathname === '/' ? 'Home' :
                                     url.pathname.includes('/p/') ? url.pathname.split('/p/')[1].replace(/-/g, ' ') :
                                     url.pathname.includes('/search/label/') ? url.pathname.split('/search/label/')[1] :
                                     url.pathname;

                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = request.url;
                        a.textContent = title.charAt(0).toUpperCase() + title.slice(1);
                        li.appendChild(a);
                        cachedLinksList.appendChild(li);
                      });
                    }
                  });
                });
              }
            </script>
          </body>
          </html>
        `;

        // Store the offline page in cache
        if ('caches' in window) {
          caches.open('kanahola-v1').then(cache => {
            cache.put(new Request('/offline.html'), new Response(offlineHtml, {
              headers: { 'Content-Type': 'text/html' }
            }));
          });
        }
      }
    }

    // UX Enhancements
    (function($) {
      'use strict';

      // Initialize all UX enhancements
      function initUXEnhancements() {
        initReadingProgressBar();
        initDarkModeToggle();
        initFontSizeControls();
        initPrintFriendlyVersion();
        initEstimatedReadingTime();
        initInfiniteScroll();
        initEnhancedComments();
        initNewsletterForms();
        initExitIntentPopup();
        initContentGating();
        initAdManagement();
        initAdBlockerDetection();
        initSocialProofElements();
        initSocialMediaPreviewTool();
        initOfflineDetection();

        // New content features
        initRecommendationSystem();
        initResponsiveGalleries();
        initAccordionSections();
        initContentTabs();
        initTableOfContents();

        // Listen for custom event when new content is loaded via infinite scroll
        document.addEventListener('kanahola:newContentLoaded', function() {
          // Re-initialize components that need to be applied to new content
          initLazyLoading();
          initSyntaxHighlighting();
          initLightbox();
          initRecommendationSystem();
          initResponsiveGalleries();
          initAccordionSections();
          initContentTabs();

          // Announce to screen readers that new content has been loaded
          announceToScreenReader('New content has been loaded');
        });
      }

      // Helper function for screen reader announcements
      function announceToScreenReader(message) {
        // Create or get the live region
        let liveRegion = document.getElementById('sr-announcer');

        if (!liveRegion) {
          liveRegion = document.createElement('div');
          liveRegion.id = 'sr-announcer';
          liveRegion.setAttribute('aria-live', 'polite');
          liveRegion.setAttribute('aria-atomic', 'true');
          liveRegion.className = 'sr-only';
          liveRegion.style.position = 'absolute';
          liveRegion.style.width = '1px';
          liveRegion.style.height = '1px';
          liveRegion.style.padding = '0';
          liveRegion.style.margin = '-1px';
          liveRegion.style.overflow = 'hidden';
          liveRegion.style.clip = 'rect(0, 0, 0, 0)';
          liveRegion.style.whiteSpace = 'nowrap';
          liveRegion.style.border = '0';
          document.body.appendChild(liveRegion);
        }

        // Set the message
        liveRegion.textContent = message;

        // Clear after a short delay
        setTimeout(() => {
          liveRegion.textContent = '';
        }, 3000);
      }

      // 1. Enhanced Reading Progress Bar
      function initReadingProgressBar() {
        if (!isArticlePage()) return;

        const progressContainer = $('.reading-progress-container');
        const progressBar = $('.reading-progress-bar');
        const progressText = $('.reading-progress-text');
        const progressToggle = $('.reading-progress-toggle');
        const article = $('.post-body');
        const articleContainer = $('.single-post');

        if (article.length === 0 || progressBar.length === 0) return;

        // Create reading progress text indicator if it doesn't exist
        if (progressText.length === 0 && articleContainer.length > 0) {
          articleContainer.append('<div class="reading-progress-text">0% read</div>');
        }

        // Check for saved preference
        const progressEnabled = localStorage.getItem('kanahola-progress-indicator') !== 'false';

        // Set initial state
        if (!progressEnabled) {
          progressContainer.addClass('hidden');
          progressToggle.removeClass('active');
        } else {
          progressContainer.removeClass('hidden');
          progressToggle.addClass('active');
        }

        // Toggle progress indicator on click
        progressToggle.on('click', function() {
          const isVisible = !progressContainer.hasClass('hidden');

          if (isVisible) {
            progressContainer.addClass('hidden');
            progressToggle.removeClass('active');
            localStorage.setItem('kanahola-progress-indicator', 'false');
          } else {
            progressContainer.removeClass('hidden');
            progressToggle.addClass('active');
            localStorage.setItem('kanahola-progress-indicator', 'true');
          }
        });

        // Get all headings in the article for section tracking
        const headings = article.find('h1, h2, h3, h4, h5, h6');
        const sections = [];

        // Create sections array with positions
        if (headings.length > 0) {
          headings.each(function(index) {
            // Add ID to the heading for scroll targeting if it doesn't have one
            if (!$(this).attr('id')) {
              $(this).attr('id', `section-${index}`);
            }

            sections.push({
              element: $(this),
              position: $(this).offset().top,
              title: $(this).text(),
              id: $(this).attr('id')
            });
          });
        }

        // Create enhanced table of contents if there are headings
        if (sections.length > 0 && $('.table-of-contents').length === 0) {
          // Create TOC HTML with toggle button
          let tocHtml = `
            <div class="table-of-contents">
              <div class="table-of-contents-header">
                <h4>Table of Contents</h4>
                <button class="table-of-contents-toggle" aria-label="Toggle table of contents">
                  <i class="fas fa-chevron-up"></i><span class="toggle-text">Collapse</span>
                </button>
              </div>
              <ul>`;

          // Generate TOC items with proper hierarchy
          sections.forEach(function(section, index) {
            const headingLevel = parseInt(section.element.prop('tagName').replace('H', ''));
            const indent = (headingLevel - 1) * 15; // Indent based on heading level

            tocHtml += `<li style="margin-left: ${indent}px">
                          <a href="#${section.id}" class="toc-link" data-level="${headingLevel}">${section.title}</a>
                        </li>`;
          });

          tocHtml += `
              </ul>
            </div>
            <button class="toc-mobile-toggle" aria-label="Show table of contents">
              <i class="fas fa-list"></i>
            </button>
            <div class="toc-overlay"></div>`;

          // Insert TOC after post meta
          $('.post-meta').after(tocHtml);

          // Get TOC preference from localStorage
          const tocCollapsed = localStorage.getItem('kanahola-toc-collapsed') === 'true';
          const tocFloating = localStorage.getItem('kanahola-toc-floating') === 'true';

          // Apply saved preferences
          if (tocCollapsed) {
            $('.table-of-contents').addClass('collapsed');
            $('.table-of-contents-toggle .toggle-text').text('Expand');
            $('.table-of-contents-toggle i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
          }

          if (tocFloating) {
            $('.table-of-contents').addClass('floating');
          }

          // Toggle TOC collapse/expand
          $('.table-of-contents-toggle').on('click', function() {
            const toc = $('.table-of-contents');
            toc.toggleClass('collapsed');

            // Update toggle button text and icon
            if (toc.hasClass('collapsed')) {
              $(this).find('.toggle-text').text('Expand');
              $(this).find('i').removeClass('fa-chevron-up').addClass('fa-chevron-down');
              localStorage.setItem('kanahola-toc-collapsed', 'true');
            } else {
              $(this).find('.toggle-text').text('Collapse');
              $(this).find('i').removeClass('fa-chevron-down').addClass('fa-chevron-up');
              localStorage.setItem('kanahola-toc-collapsed', 'false');
            }
          });

          // Add floating TOC toggle to post tools
          if ($('.post-tools .tools-buttons').length > 0) {
            const floatingTocButton = $(`
              <button class="tool-button toggle-floating-toc">
                <i class="fas fa-thumbtack"></i> ${tocFloating ? 'Unpin TOC' : 'Pin TOC'}
              </button>
            `);

            $('.post-tools .tools-buttons').append(floatingTocButton);

            // Toggle floating TOC
            $('.toggle-floating-toc').on('click', function() {
              const toc = $('.table-of-contents');
              toc.toggleClass('floating');

              if (toc.hasClass('floating')) {
                $(this).html('<i class="fas fa-thumbtack"></i> Unpin TOC');
                localStorage.setItem('kanahola-toc-floating', 'true');
              } else {
                $(this).html('<i class="fas fa-thumbtack"></i> Pin TOC');
                localStorage.setItem('kanahola-toc-floating', 'false');
              }
            });
          }

          // Mobile TOC toggle
          $('.toc-mobile-toggle').on('click', function() {
            $('.table-of-contents').addClass('mobile-visible');
            $('.toc-overlay').addClass('active');
          });

          // Close mobile TOC when clicking overlay
          $('.toc-overlay').on('click', function() {
            $('.table-of-contents').removeClass('mobile-visible');
            $('.toc-overlay').removeClass('active');
          });

          // Smooth scroll to section when TOC link is clicked
          $('.toc-link').on('click', function(e) {
            e.preventDefault();
            const targetId = $(this).attr('href');
            const targetElement = $(targetId);

            if (targetElement.length > 0) {
              // Close mobile TOC if open
              $('.table-of-contents').removeClass('mobile-visible');
              $('.toc-overlay').removeClass('active');

              // Smooth scroll to target
              $('html, body').animate({
                scrollTop: targetElement.offset().top - 100 // Offset for fixed header
              }, 500);
            }
          });
        }

        // Throttled scroll handler for better performance
        const scrollHandler = throttle(function() {
          const windowHeight = $(window).height();
          const documentHeight = $(document).height();
          const scrollTop = $(window).scrollTop();
          const articleTop = article.offset().top;
          const articleHeight = article.height();
          const articleBottom = articleTop + articleHeight;

          // Calculate reading progress
          let progress = 0;
          let currentSection = '';

          if (scrollTop > articleTop) {
            // Calculate progress based on visible content rather than just scroll position
            // This gives a more accurate representation of reading progress
            const visibleContentHeight = Math.min(windowHeight, articleBottom - scrollTop);
            const totalScrollableContent = articleHeight - windowHeight;
            const scrollProgress = Math.max(0, scrollTop - articleTop);

            if (totalScrollableContent > 0) {
              progress = Math.min(scrollProgress / totalScrollableContent, 1) * 100;
            } else {
              // For very short articles
              progress = scrollTop >= articleTop ? 100 : 0;
            }

            // Find current section with improved algorithm
            if (sections.length > 0) {
              // Find the section that is currently in view
              // Start from the last section and work backwards
              for (let i = sections.length - 1; i >= 0; i--) {
                // Add offset for better UX - consider a section active when the user has scrolled
                // a bit past its start position (150px is a good value for most layouts)
                if (scrollTop + 150 > sections[i].position) {
                  currentSection = sections[i].title;

                  // Highlight current section in TOC
                  $('.toc-link').removeClass('active');
                  const activeLink = $(`.toc-link[href="#${sections[i].id}"]`);
                  activeLink.addClass('active');

                  // If TOC is floating, ensure the active item is visible by scrolling if needed
                  const toc = $('.table-of-contents');
                  if (toc.hasClass('floating') && !toc.hasClass('collapsed')) {
                    const tocContainer = toc.find('ul');
                    const activeLinkTop = activeLink.position().top;
                    const tocScrollTop = tocContainer.scrollTop();
                    const tocHeight = tocContainer.height();

                    // If active link is not visible, scroll to it
                    if (activeLinkTop < 0 || activeLinkTop > tocHeight) {
                      tocContainer.animate({
                        scrollTop: tocScrollTop + activeLinkTop - (tocHeight / 2)
                      }, 200);
                    }
                  }
                  break;
                }
              }
            }
          }

          // Update progress bar with smooth animation
          // Use requestAnimationFrame for smoother updates
          requestAnimationFrame(function() {
            progressBar.css('width', progress + '%');
          });

          // Update progress text
          if ($('.reading-progress-text').length > 0) {
            // Format the progress text with current section info
            const progressTextContent = Math.round(progress) + '% read' +
                                      (currentSection ? '  Current section: ' + currentSection : '');

            $('.reading-progress-text').text(progressTextContent);

            // Show/hide progress text based on scroll position
            // Only show when actively reading the article
            if (scrollTop > articleTop && scrollTop < articleBottom - windowHeight) {
              $('.reading-progress-text').addClass('visible');
            } else {
              $('.reading-progress-text').removeClass('visible');
            }
          }
        }, 100); // Throttle to 100ms for smooth updates without performance impact

        // Track scroll position and update progress
        $(window).on('scroll', scrollHandler);

        // Trigger scroll event to initialize progress
        $(window).trigger('scroll');

        // Update section positions on window resize
        $(window).on('resize', throttle(function() {
          // Recalculate section positions
          if (sections.length > 0) {
            sections.forEach(function(section, index) {
              section.position = section.element.offset().top;
            });
          }

          // Trigger scroll handler to update progress
          scrollHandler();
        }, 200));
      }

      // 2. Enhanced Dark Mode Toggle with System Preference Detection
      function initDarkModeToggle() {
        const themeToggle = $('.theme-toggle');
        const themeIcon = $('.theme-toggle-icon');
        const htmlElement = $('html');

        // Function to set theme
        function setTheme(theme) {
          if (theme === 'dark') {
            // Update HTML class for Blogger compatibility
            htmlElement.addClass('dark');

            // Update icon
            themeIcon.removeClass('fa-moon').addClass('fa-sun');

            // Update localStorage
            localStorage.setItem('kanahola-theme', 'dark');

            // Update meta theme-color for browser UI
            $('meta[name="theme-color"]').attr('content', '#121212');

            // Update ARIA attributes
            $('.theme-toggle').attr('aria-checked', 'true');
            $('#theme-toggle-checkbox').attr('aria-checked', 'true');

            // Dispatch theme change event for other components
            document.dispatchEvent(new CustomEvent('themeChanged', {
              detail: { theme: 'dark' }
            }));
          } else {
            // Update HTML class for Blogger compatibility
            htmlElement.removeClass('dark');

            // Update icon
            themeIcon.removeClass('fa-sun').addClass('fa-moon');

            // Update localStorage
            localStorage.setItem('kanahola-theme', 'light');

            // Update meta theme-color for browser UI
            $('meta[name="theme-color"]').attr('content', '#4a90e2');

            // Update ARIA attributes
            $('.theme-toggle').attr('aria-checked', 'false');
            $('#theme-toggle-checkbox').attr('aria-checked', 'false');

            // Dispatch theme change event for other components
            document.dispatchEvent(new CustomEvent('themeChanged', {
              detail: { theme: 'light' }
            }));
          }
        }

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('kanahola-theme');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

        if (savedTheme) {
          // User has a saved preference
          setTheme(savedTheme);
        } else if (prefersDarkScheme.matches) {
          // User has no saved preference but system prefers dark mode
          setTheme('dark');
        } else {
          // Default to light mode
          setTheme('light');
        }

        // Toggle theme on click
        themeToggle.on('click', function() {
          if (htmlElement.hasClass('dark')) {
            setTheme('light');
          } else {
            setTheme('dark');
          }
        });

        // Listen for system preference changes
        prefersDarkScheme.addEventListener('change', function(e) {
          // Only change theme if user hasn't set a preference
          if (!localStorage.getItem('kanahola-theme')) {
            setTheme(e.matches ? 'dark' : 'light');
          }
        });

        // Add theme toggle to sidebar if not already present
        if ($('.theme-toggle-container').length === 0) {
          const themeToggleHtml = `
            <div class="theme-toggle-container">
              <span id="theme-toggle-label">Dark Mode</span>
              <label class="toggle-switch" for="theme-toggle-checkbox">
                <input type="checkbox" id="theme-toggle-checkbox" ${htmlElement.hasClass('dark') ? 'checked' : ''}
                       aria-labelledby="theme-toggle-label" role="switch" aria-checked="${htmlElement.hasClass('dark') ? 'true' : 'false'}">
                <span class="toggle-slider"></span>
              </label>
            </div>
          `;

          // Add after font size controls
          $('.font-size-controls').after(themeToggleHtml);

          // Sync checkbox with current theme
          $('#theme-toggle-checkbox').on('change', function() {
            if (this.checked) {
              setTheme('dark');
            } else {
              setTheme('light');
            }
          });
        }

        // Add transition class after a delay to prevent flash during initial load
        setTimeout(() => {
          htmlElement.addClass('theme-transition');
        }, 300);
      }

      // 3. Enhanced Font Size Controls with rem-based sizing
      function initFontSizeControls() {
        if (!isArticlePage()) return;

        const fontSizeButtons = $('.font-size-btn');
        const htmlElement = $('html');

        // Check for saved font size preference
        const savedFontSize = localStorage.getItem('kanahola-font-size');
        if (savedFontSize) {
          htmlElement.removeClass('font-size-small font-size-medium font-size-large font-size-xlarge')
               .addClass('font-size-' + savedFontSize);
        } else {
          htmlElement.addClass('font-size-medium'); // Default
        }

        // Set active button
        fontSizeButtons.each(function() {
          const size = $(this).data('size');
          if (htmlElement.hasClass('font-size-' + size)) {
            $(this).addClass('active');
          }
        });

        // Change font size on click
        fontSizeButtons.on('click', function() {
          const size = $(this).data('size');

          // Remove all font size classes
          htmlElement.removeClass('font-size-small font-size-medium font-size-large font-size-xlarge');

          // Add selected font size class
          htmlElement.addClass('font-size-' + size);

          // Save preference
          localStorage.setItem('kanahola-font-size', size);

          // Update active button
          fontSizeButtons.removeClass('active');
          $(this).addClass('active');

          // Announce font size change for screen readers
          const sizeText = size === 'small' ? 'small' :
                          size === 'medium' ? 'medium' :
                          size === 'large' ? 'large' : 'extra large';

          announceToScreenReader(`Font size changed to ${sizeText}`);
        });

        // Add ARIA attributes for accessibility
        fontSizeButtons.attr('role', 'button');
        fontSizeButtons.attr('aria-pressed', 'false');
        fontSizeButtons.each(function() {
          const size = $(this).data('size');
          if (htmlElement.hasClass('font-size-' + size)) {
            $(this).attr('aria-pressed', 'true');
          }
        });
      }

      // 3.1 Print-Friendly Version
      function initPrintFriendlyVersion() {
        if (!isArticlePage()) return;

        const postTools = $('.post-tools .tools-buttons');

        // Only add print button if it doesn't exist
        if (postTools.length > 0 && postTools.find('.print-button').length === 0) {
          // Create print button
          const printButton = $(`
            <button class="tool-button print-button" aria-label="Print this article">
              <i class="fas fa-print"></i> Print Version
            </button>
          `);

          // Add to post tools
          postTools.prepend(printButton);

          // Add click handler
          printButton.on('click', function() {
            preparePrintVersion();
            window.print();
          });
        }

        // Function to prepare the page for printing
        function preparePrintVersion() {
          // Add current URL and date to the single post for print footer
          const singlePost = $('.single-post');
          const currentDate = new Date().toLocaleDateString();

          singlePost.attr('data-url', window.location.href);
          singlePost.attr('data-print-date', currentDate);

          // Ensure all images are loaded before printing
          const images = singlePost.find('img');
          let imagesLoaded = 0;

          if (images.length === 0) {
            return; // No images to load
          }

          // Show loading indicator
          const loadingIndicator = $('<div class="print-loading">Preparing images for printing...</div>');
          loadingIndicator.css({
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            background: 'rgba(0,0,0,0.7)',
            color: 'white',
            padding: '15px 20px',
            borderRadius: '5px',
            zIndex: 9999
          });

          $('body').append(loadingIndicator);

          // Check each image
          images.each(function() {
            const img = $(this);

            // If image is already loaded
            if (img[0].complete) {
              imagesLoaded++;
              if (imagesLoaded === images.length) {
                loadingIndicator.remove();
              }
            } else {
              // Wait for image to load
              img.on('load', function() {
                imagesLoaded++;
                if (imagesLoaded === images.length) {
                  loadingIndicator.remove();
                }
              });

              // Handle error
              img.on('error', function() {
                imagesLoaded++;
                if (imagesLoaded === images.length) {
                  loadingIndicator.remove();
                }
              });
            }
          });

          // Set timeout to remove loading indicator after 5 seconds
          // (in case some images fail to load)
          setTimeout(function() {
            loadingIndicator.remove();
          }, 5000);
        }
      }

      // 4. Estimated Reading Time
      function initEstimatedReadingTime() {
        if (!isArticlePage()) return;

        const article = $('.post-body');
        const readingTimeElement = $('.reading-time-text');

        if (article.length === 0 || readingTimeElement.length === 0) return;

        // Get article text
        const text = article.text();

        // Calculate reading time (average reading speed: 200 words per minute)
        const wordCount = text.trim().split(/\s+/).length;
        const readingTime = Math.ceil(wordCount / 200);

        // Update reading time element
        readingTimeElement.text(readingTime + ' min read');
      }

      // 5. Enhanced Infinite Scroll with IntersectionObserver
      function initInfiniteScroll() {
        if (!isCategoryPage()) return;

        const postGrid = $('.post-grid');
        const nextPageLink = $('.blog-pager-older-link');
        const infiniteScrollToggle = $('#infinite-scroll-toggle');
        const loader = $('.infinite-scroll-loader');

        if (postGrid.length === 0 || nextPageLink.length === 0) return;

        // Check for saved preference
        const infiniteScrollEnabled = localStorage.getItem('kanahola-infinite-scroll') === 'true';
        infiniteScrollToggle.prop('checked', infiniteScrollEnabled);

        // Save preference on change
        infiniteScrollToggle.on('change', function() {
          localStorage.setItem('kanahola-infinite-scroll', this.checked);

          // Show or hide the sentinel based on toggle state
          if (this.checked) {
            $('#infinite-scroll-sentinel').show();
          } else {
            $('#infinite-scroll-sentinel').hide();
          }
        });

        // Create a sentinel element that will trigger loading when it comes into view
        if ($('#infinite-scroll-sentinel').length === 0) {
          const sentinel = $('<div id="infinite-scroll-sentinel" style="height: 10px; margin: 20px 0;"></div>');
          postGrid.after(sentinel);

          // Hide sentinel if infinite scroll is disabled
          if (!infiniteScrollEnabled) {
            sentinel.hide();
          }
        }

        // Track loaded pages for browser history
        let currentPage = 1;
        let loadedPages = new Set([currentPage]);

        // Update URL without reloading the page
        function updateBrowserHistory(pageNum, pageUrl) {
          if (window.history && window.history.pushState) {
            // Extract the page path without query parameters
            const urlObj = new URL(pageUrl, window.location.origin);

            // Only update history if this is a new page
            if (!loadedPages.has(pageNum)) {
              loadedPages.add(pageNum);

              // Update the browser history
              const historyTitle = document.title + ' - Page ' + pageNum;
              window.history.pushState({ page: pageNum }, historyTitle, urlObj.pathname + urlObj.search);

              // Update analytics if available
              if (typeof gtag === 'function') {
                gtag('config', 'UA-XXXXXXXX-X', {
                  'page_path': urlObj.pathname + urlObj.search
                });
              }
            }
          }
        }

        // Function to load more posts
        let isLoading = false;
        function loadMorePosts() {
          if (isLoading || !nextPageLink.length || !infiniteScrollToggle.prop('checked')) return;

          isLoading = true;
          loader.addClass('active');

          // Load next page
          $.ajax({
            url: nextPageLink.attr('href'),
            type: 'GET',
            success: function(response) {
              const $html = $(response);
              const newPosts = $html.find('.post-card');
              const newNextPageLink = $html.find('.blog-pager-older-link');

              // Append new posts
              postGrid.append(newPosts);

              // Extract page number from URL if available
              let nextPageNum = currentPage + 1;
              if (nextPageLink.attr('href').includes('page=')) {
                const pageMatch = nextPageLink.attr('href').match(/page=(\d+)/);
                if (pageMatch && pageMatch[1]) {
                  nextPageNum = parseInt(pageMatch[1]);
                }
              }

              // Update browser history
              updateBrowserHistory(nextPageNum, nextPageLink.attr('href'));
              currentPage = nextPageNum;

              // Update next page link
              if (newNextPageLink.length) {
                nextPageLink.attr('href', newNextPageLink.attr('href'));

                // Move the sentinel after the new posts
                $('#infinite-scroll-sentinel').appendTo(postGrid.parent());
              } else {
                nextPageLink.remove();
                $('#infinite-scroll-sentinel').remove();
              }

              // Initialize lazy loading for new images
              initLazyLoading();

              // Initialize any other components for new content
              initSyntaxHighlighting();

              // Dispatch custom event for other scripts to know new content was loaded
              document.dispatchEvent(new CustomEvent('kanahola:newContentLoaded'));

              isLoading = false;
              loader.removeClass('active');
            },
            error: function(xhr, status, error) {
              console.error('Error loading more posts:', error);
              isLoading = false;
              loader.removeClass('active');

              // Show error message
              const errorMsg = $('<div class="infinite-scroll-error">Error loading more posts. <button class="retry-load">Try Again</button></div>');
              $('#infinite-scroll-sentinel').before(errorMsg);

              // Add retry handler
              $('.retry-load').on('click', function() {
                errorMsg.remove();
                loadMorePosts();
              });
            }
          });
        }

        // Use IntersectionObserver to detect when sentinel comes into view
        if ('IntersectionObserver' in window) {
          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting && infiniteScrollToggle.prop('checked')) {
                loadMorePosts();
              }
            });
          }, { rootMargin: '200px' }); // Start loading when sentinel is 200px from viewport

          // Observe the sentinel element
          const sentinel = document.getElementById('infinite-scroll-sentinel');
          if (sentinel) {
            observer.observe(sentinel);
          }
        } else {
          // Fallback for browsers without IntersectionObserver
          $(window).on('scroll', function() {
            // Only proceed if infinite scroll is enabled
            if (!infiniteScrollToggle.prop('checked')) return;

            const scrollHeight = $(document).height();
            const scrollPosition = $(window).height() + $(window).scrollTop();

            // If scrolled to bottom and not already loading
            if ((scrollHeight - scrollPosition) / scrollHeight < 0.1 && !isLoading && nextPageLink.length) {
              loadMorePosts();
            }
          });
        }

        // Handle browser back/forward navigation
        $(window).on('popstate', function(event) {
          if (event.originalEvent.state && event.originalEvent.state.page) {
            const targetPage = event.originalEvent.state.page;

            // If we need to go back to the first page and we're not there
            if (targetPage === 1 && currentPage > 1) {
              window.location.reload(); // Simplest way to handle going back to page 1
            }

            // If we need to navigate to a page we've already loaded
            // This is complex to implement perfectly without reloading
            // For a complete solution, we would need to track DOM elements by page
          }
        });
      }

      // 6. Enhanced Comments
      function initEnhancedComments() {
        if (!isArticlePage()) return;

        const commentsSection = $('.comments');

        if (commentsSection.length === 0) return;

        // Add reply buttons to comments
        $('.comment').each(function() {
          const comment = $(this);
          const commentId = comment.attr('id');

          if (!commentId) return;

          // Add reply button if not already present
          if (comment.find('.comment-reply').length === 0) {
            const replyButton = $('<a class="comment-reply">Reply</a>');
            const actionsDiv = comment.find('.comment-actions');

            if (actionsDiv.length === 0) {
              comment.append('<div class="comment-actions"></div>');
              comment.find('.comment-actions').append(replyButton);
            } else {
              actionsDiv.append(replyButton);
            }

            // Create reply form
            const replyForm = $('<div class="reply-form">' +
                               '<textarea placeholder="Write your reply..."></textarea>' +
                               '<button type="button">Submit</button>' +
                               '</div>');

            comment.append(replyForm);

            // Toggle reply form on click
            replyButton.on('click', function() {
              replyForm.toggleClass('active');
              replyForm.find('textarea').focus();
            });

            // Handle reply submission
            replyForm.find('button').on('click', function() {
              const replyText = replyForm.find('textarea').val().trim();

              if (replyText === '') return;

              // Get the comment form
              const commentForm = $('#comment-form');

              if (commentForm.length === 0) return;

              // Set the parent comment ID
              const parentInput = commentForm.find('input[name="parentID"]');

              if (parentInput.length === 0) {
                commentForm.append('<input type="hidden" name="parentID" value="' + commentId.replace('c', '') + '">');
              } else {
                parentInput.val(commentId.replace('c', ''));
              }

              // Set the comment text
              commentForm.find('textarea').val(replyText);

              // Submit the form via AJAX
              const formData = commentForm.serialize();
              const formAction = commentForm.attr('action');

              $.ajax({
                url: formAction,
                type: 'POST',
                data: formData,
                success: function(response) {
                  // Create a new comment element
                  const newComment = $('<div class="comment">' +
                                     '<div class="comment-header">' +
                                     '<span class="comment-author">' + (userData ? userData.displayName : 'Anonymous') + '</span>' +
                                     '<span class="comment-date">Just now</span>' +
                                     '</div>' +
                                     '<div class="comment-content">' + replyText + '</div>' +
                                     '</div>');

                  // Add to comment replies
                  let repliesContainer = comment.find('.comment-replies');

                  if (repliesContainer.length === 0) {
                    comment.append('<div class="comment-replies"></div>');
                    repliesContainer = comment.find('.comment-replies');
                  }

                  repliesContainer.append(newComment);

                  // Clear and hide the reply form
                  replyForm.find('textarea').val('');
                  replyForm.removeClass('active');
                },
                error: function() {
                  alert('Error posting comment. Please try again.');
                }
              });
            });
          }
        });
      }

      // Helper function to check if current page is an article
      function isArticlePage() {
        return $('.single-post').length > 0;
      }

      // Helper function to check if current page is a category/index page
      function isCategoryPage() {
        return $('.post-grid').length > 0 && !isArticlePage();
      }

      // 7. Newsletter Forms Integration with EmailKit
      function initNewsletterForms() {
        // Add click handlers to open EmailKit modal
        $('.newsletter-trigger').on('click', function(e) {
          e.preventDefault();
          // Open EmailKit modal
          window.openEmailKitModal();

          // Special handling for premium content trigger
          if ($(this).attr('id') === 'premium-content-trigger') {
            // Show the gated content
            const premiumGate = $(this).closest('.premium-content-gate');
            const hiddenContent = premiumGate.next('.premium-content-hidden');

            premiumGate.slideUp();
            hiddenContent.slideDown();

            // Save that user has subscribed to premium content
            localStorage.setItem('kanahola-premium-subscriber', 'true');
          }
        });

        // Convert existing forms to use EmailKit
        $('#sidebar-newsletter-form').on('submit', function(e) {
          e.preventDefault();
          // Open EmailKit modal instead of submitting the form directly
          window.openEmailKitModal();
        });

        // Handle exit intent newsletter form
        $('#exit-intent-newsletter-form').on('submit', function(e) {
          e.preventDefault();
          // Open EmailKit modal
          window.openEmailKitModal();
          // Close our custom exit intent popup
          $('#exit-intent-popup').removeClass('active');
          // Don't show exit intent popup again for this session
          sessionStorage.setItem('kanahola-exit-intent-shown', 'true');
        });

        // Handle premium content gate form
        $('#premium-content-form').on('submit', function(e) {
          e.preventDefault();

          // Show the gated content
          const premiumGate = $(this).closest('.premium-content-gate');
          const hiddenContent = premiumGate.next('.premium-content-hidden');

          premiumGate.slideUp();
          hiddenContent.slideDown();

          // Save that user has subscribed to premium content
          localStorage.setItem('kanahola-premium-subscriber', 'true');

          // Open EmailKit modal
          window.openEmailKitModal();
        });

        // Check if user is already a premium subscriber
        if (localStorage.getItem('kanahola-premium-subscriber') === 'true') {
          $('.premium-content-gate').hide();
          $('.premium-content-hidden').show();
        }

        // Create a global function to open the EmailKit modal
        window.openEmailKitModal = function() {
          // Check if EmailKit is loaded
          if (typeof window.EmailKit !== 'undefined' && typeof window.EmailKit.openModal === 'function') {
            window.EmailKit.openModal('11e1f6b801');
          } else {
            console.log('EmailKit not loaded yet. Trying again in 500ms...');
            // Try again in 500ms if EmailKit is not loaded yet
            setTimeout(function() {
              if (typeof window.EmailKit !== 'undefined' && typeof window.EmailKit.openModal === 'function') {
                window.EmailKit.openModal('11e1f6b801');
              } else {
                console.error('EmailKit could not be loaded.');
                // Fallback to showing a message
                alert('Newsletter subscription is currently unavailable. Please try again later.');
              }
            }, 500);
          }

          // Save that user has interacted with newsletter
          localStorage.setItem('kanahola-newsletter-interaction', 'true');
        };

        // Listen for EmailKit success event
        document.addEventListener('emailkit:success', function(event) {
          console.log('EmailKit subscription successful!');
          // Save that user has subscribed
          localStorage.setItem('kanahola-newsletter-subscriber', 'true');

          // Also mark as premium subscriber if premium content exists on the page
          if ($('.premium-content-gate').length > 0) {
            localStorage.setItem('kanahola-premium-subscriber', 'true');

            // Show the gated content if it exists
            $('.premium-content-gate').slideUp();
            $('.premium-content-hidden').slideDown();
          }

          // Show a success message
          const successMessage = $('<div class="newsletter-success-toast">Thanks for subscribing! Check your email to confirm your subscription.</div>');
          $('body').append(successMessage);

          // Remove the message after 5 seconds
          setTimeout(function() {
            successMessage.fadeOut(function() {
              $(this).remove();
            });
          }, 5000);

          // Close exit intent popup if it's open
          $('#exit-intent-popup').removeClass('active');
        });
      }

      // 8. Exit Intent Popup with EmailKit Integration
      function initExitIntentPopup() {
        // Only show exit intent popup if user hasn't subscribed yet
        if (localStorage.getItem('kanahola-newsletter-subscriber') === 'true') {
          return;
        }

        // Only show once per session
        if (sessionStorage.getItem('kanahola-exit-intent-shown') === 'true') {
          return;
        }

        // Detect when user is about to leave the page
        let showOnce = true;
        $(document).on('mouseleave', function(e) {
          // Only trigger when mouse leaves the top of the page
          if (e.clientY < 5 && showOnce) {
            showOnce = false;

            // Open EmailKit modal directly instead of our custom popup
            window.openEmailKitModal();

            // Mark as shown for this session
            sessionStorage.setItem('kanahola-exit-intent-shown', 'true');
          }
        });

        // Keep the custom popup handlers for backward compatibility
        // Close popup when clicking the close button
        $('.exit-intent-popup-close').on('click', function() {
          $('#exit-intent-popup').removeClass('active');
        });

        // Close popup when clicking outside the content
        $('#exit-intent-popup').on('click', function(e) {
          if ($(e.target).is('#exit-intent-popup')) {
            $('#exit-intent-popup').removeClass('active');
          }
        });
      }

      // 9. Content Gating
      function initContentGating() {
        if (!isArticlePage()) return;

        // Check if premium content exists on the page
        if ($('.premium-content-gate').length === 0) return;

        // Hide premium content initially
        $('.premium-content-hidden').hide();

        // Show content if user is already a premium subscriber
        if (localStorage.getItem('kanahola-premium-subscriber') === 'true') {
          $('.premium-content-gate').hide();
          $('.premium-content-hidden').show();
        }
      }

      // 10. Ad Management with Amazon Sponsored Products
      function initAdManagement() {
        // Define ad slots
        const adSlots = {
          'sidebar-ad-1': {
            width: 300,
            height: 250,
            type: 'sidebar'
          },
          'sidebar-ad-2': {
            width: 300,
            height: 250,
            type: 'sidebar'
          },
          'in-content-ad': {
            width: 728,
            height: 90,
            type: 'in-content'
          }
        };

        // Load ads for each slot
        for (const slotId in adSlots) {
          if (adSlots.hasOwnProperty(slotId)) {
            const slot = adSlots[slotId];
            const adElement = $('#' + slotId);

            if (adElement.length > 0) {
              loadAd(slotId, slot);
            }
          }
        }

        // Insert in-content ads after X paragraphs
        if (isArticlePage()) {
          const paragraphs = $('.post-body p');

          if (paragraphs.length >= 4) {
            // Insert after 3rd paragraph
            const adHtml = `
              <div class="ad-container in-content-ad" id="in-content-ad">
                <span class="ad-label">Advertisement</span>
                <!-- Ad content will be inserted by JavaScript -->
              </div>
            `;

            $(paragraphs[2]).after(adHtml);

            // Load the ad
            loadAd('in-content-ad', adSlots['in-content-ad']);
          }

          // Insert Amazon Sponsored Products widgets
          insertAmazonSponsoredProducts(paragraphs);
        }

        // Function to load ads with lazy loading
        function loadAd(slotId, slotInfo) {
          const adElement = $('#' + slotId);

          // Create a placeholder for the ad
          const placeholderHtml = `
            <div class="ad-placeholder" style="width: ${slotInfo.width}px; height: ${slotInfo.height}px; margin: 0 auto;">
              <div class="ad-placeholder-text">Ad</div>
            </div>
          `;

          adElement.html(placeholderHtml);

          // Use Intersection Observer for lazy loading
          if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  // Load the actual ad
                  loadActualAd(slotId, slotInfo);

                  // Stop observing once loaded
                  observer.unobserve(entry.target);
                }
              });
            }, { rootMargin: '100px' });

            observer.observe(adElement[0]);
          } else {
            // Fallback for browsers that don't support Intersection Observer
            loadActualAd(slotId, slotInfo);
          }
        }

        // Function to load the actual ad content
        function loadActualAd(slotId, slotInfo) {
          const adElement = $('#' + slotId);

          // In a real implementation, this would load an ad from your ad network
          // For demo purposes, we'll just show a placeholder
          const adHtml = `
            <div class="ad-content" style="width: ${slotInfo.width}px; height: ${slotInfo.height}px; margin: 0 auto; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; border: 1px solid #ddd;">
              <div style="text-align: center;">
                <div style="font-size: 14px; color: #666;">Advertisement</div>
                <div style="font-size: 12px; color: #999; margin-top: 5px;">${slotInfo.width}x${slotInfo.height}</div>
              </div>
            </div>
          `;

          adElement.html(adHtml);
        }

        // Function to insert Amazon Sponsored Products widgets
        function insertAmazonSponsoredProducts(paragraphs) {
          // Only insert if we have enough paragraphs
          if (paragraphs.length < 4) return;

          // Define insertion points (after 3rd and 8th paragraphs)
          const insertionPoints = [2, 7]; // 0-based index

          // Get post categories/tags for product targeting
          const categories = [];
          $('.post-categories a, .post-tags a, .post-labels a').each(function() {
            categories.push($(this).text().trim().toLowerCase());
          });

          // Get post title and content for keyword extraction
          const postTitle = $('.post-title').text().trim();
          const postContent = $('.post-body').text().trim();

          // Extract keywords from post title and content
          const keywords = extractKeywords(postTitle + ' ' + postContent);

          // Determine product category based on post content
          const productCategory = determineProductCategory(categories, keywords);

          // Insert widgets at specified positions
          insertionPoints.forEach((position, index) => {
            if (paragraphs.length > position) {
              // Create unique widget ID
              const widgetId = `amazon-products-widget-${index + 1}`;

              // Create widget HTML
              const widgetHtml = createAmazonWidgetHtml(widgetId, productCategory, index);

              // Insert after the specified paragraph
              $(paragraphs[position]).after(widgetHtml);

              // Initialize the widget with lazy loading
              initAmazonWidget(widgetId, productCategory, keywords);
            }
          });
        }

        // Function to extract keywords from text
        function extractKeywords(text) {
          // Remove common words and punctuation
          const commonWords = ['the', 'and', 'or', 'but', 'for', 'with', 'in', 'on', 'at', 'to', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'by', 'of', 'that', 'this', 'these', 'those', 'it', 'its'];

          // Convert to lowercase and remove punctuation
          const cleanText = text.toLowerCase().replace(/[^\w\s]/g, '');

          // Split into words and filter out common words and short words
          const words = cleanText.split(/\s+/).filter(word =>
            word.length > 3 && !commonWords.includes(word)
          );

          // Count word frequency
          const wordCounts = {};
          words.forEach(word => {
            wordCounts[word] = (wordCounts[word] || 0) + 1;
          });

          // Sort by frequency
          const sortedWords = Object.keys(wordCounts).sort((a, b) =>
            wordCounts[b] - wordCounts[a]
          );

          // Return top keywords (up to 5)
          return sortedWords.slice(0, 5);
        }

        // Function to determine product category based on post content
        function determineProductCategory(categories, keywords) {
          // Define category mappings
          const categoryMappings = {
            'technology': ['electronics', 'computers', 'gadgets', 'tech'],
            'kitchen': ['cooking', 'food', 'recipe', 'baking', 'kitchen'],
            'home': ['decor', 'furniture', 'home', 'garden', 'diy'],
            'beauty': ['makeup', 'skincare', 'beauty', 'cosmetics'],
            'fashion': ['clothing', 'fashion', 'style', 'accessories', 'shoes'],
            'books': ['books', 'reading', 'literature', 'novel', 'author'],
            'fitness': ['workout', 'exercise', 'fitness', 'gym', 'health'],
            'toys': ['kids', 'toys', 'games', 'children', 'play'],
            'office': ['office', 'work', 'productivity', 'business'],
            'pets': ['pet', 'dog', 'cat', 'animal']
          };

          // Check if any categories match our mappings
          for (const category of categories) {
            for (const [productCat, keywords] of Object.entries(categoryMappings)) {
              if (keywords.some(keyword => category.includes(keyword))) {
                return productCat;
              }
            }
          }

          // Check if any keywords match our mappings
          for (const keyword of keywords) {
            for (const [productCat, keywordList] of Object.entries(categoryMappings)) {
              if (keywordList.some(k => keyword.includes(k) || k.includes(keyword))) {
                return productCat;
              }
            }
          }

          // Default to a general category if no matches
          return 'bestsellers';
        }

        // Function to create Amazon widget HTML
        function createAmazonWidgetHtml(widgetId, category, position) {
          // Determine widget title based on category
          let widgetTitle = 'Recommended Products';

          switch (category) {
            case 'technology':
              widgetTitle = 'Recommended Tech Products';
              break;
            case 'kitchen':
              widgetTitle = 'Kitchen Essentials';
              break;
            case 'home':
              widgetTitle = 'Home & Decor Picks';
              break;
            case 'beauty':
              widgetTitle = 'Beauty Recommendations';
              break;
            case 'fashion':
              widgetTitle = 'Fashion Finds';
              break;
            case 'books':
              widgetTitle = 'Books You Might Like';
              break;
            case 'fitness':
              widgetTitle = 'Fitness Gear';
              break;
            case 'toys':
              widgetTitle = 'Top Toys & Games';
              break;
            case 'office':
              widgetTitle = 'Office Essentials';
              break;
            case 'pets':
              widgetTitle = 'Pet Supplies';
              break;
            default:
              widgetTitle = 'Recommended Products';
          }

          // Create widget HTML
          return `
            <div id="${widgetId}" class="amazon-products-widget" data-category="${category}" data-position="${position}">
              <div class="amazon-products-widget-header">
                <h3 class="amazon-products-widget-title">${widgetTitle}</h3>
                <span class="amazon-products-sponsored-label">Sponsored</span>
              </div>
              <div class="amazon-products-container">
                <div class="amazon-products-loading">
                  <div class="loader-spinner"></div>
                </div>
              </div>
            </div>
          `;
        }

        // Function to initialize Amazon widget with lazy loading
        function initAmazonWidget(widgetId, category, keywords) {
          const widgetElement = $(`#${widgetId}`);

          // Use Intersection Observer for lazy loading
          if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  // Load the Amazon products
                  loadAmazonProducts(widgetId, category, keywords);

                  // Stop observing once loaded
                  observer.unobserve(entry.target);
                }
              });
            }, { rootMargin: '200px' });

            observer.observe(widgetElement[0]);
          } else {
            // Fallback for browsers that don't support Intersection Observer
            loadAmazonProducts(widgetId, category, keywords);
          }
        }

        // Function to load Amazon products
        function loadAmazonProducts(widgetId, category, keywords) {
          const widgetElement = $(`#${widgetId}`);
          const productsContainer = widgetElement.find('.amazon-products-container');

          // In a real implementation, this would use the Amazon Product Advertising API
          // For demo purposes, we'll use sample data

          // Simulate API delay
          setTimeout(() => {
            // Get sample products based on category
            const products = getSampleProducts(category, keywords);

            // Clear loading indicator
            productsContainer.empty();

            // Add products to container
            products.forEach(product => {
              const productHtml = createProductCardHtml(product);
              productsContainer.append(productHtml);
            });

            // Initialize Amazon OneLink for international users (in real implementation)
            if (typeof window.amzn_assoc_placement !== 'undefined') {
              window.amzn_assoc_placement = widgetId;
              window.amzn_assoc_tracking_id = 'YOUR_TRACKING_ID';
              window.amzn_assoc_linkid = generateUniqueId();
              window.amzn_assoc_region = 'US';

              // Refresh Amazon links
              if (typeof window.amznjs !== 'undefined' && typeof window.amznjs.TPALinkMapper !== 'undefined') {
                window.amznjs.TPALinkMapper.getTPALinks();
              }
            }
          }, 500);
        }

        // Function to create product card HTML
        function createProductCardHtml(product) {
          // Format price
          const formattedPrice = product.price.toFixed(2);

          // Generate star rating HTML
          const starsHtml = generateStarRating(product.rating);

          // Create product card HTML
          return `
            <a href="${product.url}" target="_blank" rel="nofollow sponsored" class="amazon-product-card">
              <div class="amazon-product-image-container">
                <img src="${product.image}" alt="${product.title}" class="amazon-product-image">
              </div>
              <div class="amazon-product-content">
                <div class="amazon-product-title">${product.title}</div>
                <div class="amazon-product-price">$${formattedPrice}</div>
                <div class="amazon-product-rating">
                  <div class="amazon-product-stars">${starsHtml}</div>
                  <div class="amazon-product-reviews">(${product.reviews})</div>
                </div>
                ${product.prime ? '<div class="amazon-product-prime"><i class="fab fa-amazon"></i> Prime</div>' : ''}
                <div class="amazon-product-button">View on Amazon</div>
              </div>
            </a>
          `;
        }

        // Function to generate star rating HTML
        function generateStarRating(rating) {
          const fullStars = Math.floor(rating);
          const halfStar = rating % 1 >= 0.5;
          const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

          let starsHtml = '';

          // Add full stars
          for (let i = 0; i < fullStars; i++) {
            starsHtml += '<i class="fas fa-star"></i>';
          }

          // Add half star if needed
          if (halfStar) {
            starsHtml += '<i class="fas fa-star-half-alt"></i>';
          }

          // Add empty stars
          for (let i = 0; i < emptyStars; i++) {
            starsHtml += '<i class="far fa-star"></i>';
          }

          return starsHtml;
        }

        // Function to generate a unique ID for tracking
        function generateUniqueId() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        }

        // Function to get sample products based on category
        function getSampleProducts(category, keywords) {
          // Sample product data (in a real implementation, this would come from the Amazon API)
          const sampleProducts = {
            'technology': [
              { id: 'tech1', title: 'Wireless Bluetooth Earbuds', price: 49.99, rating: 4.5, reviews: 12543, prime: true, image: 'https://via.placeholder.com/300x300?text=Earbuds', url: 'https://amazon.com/dp/B01234567?tag=YOUR_TRACKING_ID' },
              { id: 'tech2', title: 'Smart Watch with Fitness Tracker', price: 89.99, rating: 4.2, reviews: 8765, prime: true, image: 'https://via.placeholder.com/300x300?text=SmartWatch', url: 'https://amazon.com/dp/B01234568?tag=YOUR_TRACKING_ID' },
              { id: 'tech3', title: 'Portable Bluetooth Speaker', price: 39.99, rating: 4.7, reviews: 5432, prime: true, image: 'https://via.placeholder.com/300x300?text=Speaker', url: 'https://amazon.com/dp/B01234569?tag=YOUR_TRACKING_ID' },
              { id: 'tech4', title: 'Wireless Charging Pad', price: 24.99, rating: 4.3, reviews: 3210, prime: false, image: 'https://via.placeholder.com/300x300?text=ChargingPad', url: 'https://amazon.com/dp/B01234570?tag=YOUR_TRACKING_ID' }
            ],
            'kitchen': [
              { id: 'kitchen1', title: 'Instant Pot Pressure Cooker', price: 89.95, rating: 4.8, reviews: 45678, prime: true, image: 'https://via.placeholder.com/300x300?text=InstantPot', url: 'https://amazon.com/dp/B01234571?tag=YOUR_TRACKING_ID' },
              { id: 'kitchen2', title: 'Air Fryer XL', price: 119.99, rating: 4.6, reviews: 23456, prime: true, image: 'https://via.placeholder.com/300x300?text=AirFryer', url: 'https://amazon.com/dp/B01234572?tag=YOUR_TRACKING_ID' },
              { id: 'kitchen3', title: 'Professional Chef Knife', price: 49.95, rating: 4.9, reviews: 7890, prime: true, image: 'https://via.placeholder.com/300x300?text=ChefKnife', url: 'https://amazon.com/dp/B01234573?tag=YOUR_TRACKING_ID' },
              { id: 'kitchen4', title: 'Silicone Baking Mats Set', price: 14.99, rating: 4.7, reviews: 5678, prime: false, image: 'https://via.placeholder.com/300x300?text=BakingMats', url: 'https://amazon.com/dp/B01234574?tag=YOUR_TRACKING_ID' }
            ],
            'home': [
              { id: 'home1', title: 'Smart LED Light Bulbs', price: 39.99, rating: 4.5, reviews: 9876, prime: true, image: 'https://via.placeholder.com/300x300?text=SmartBulbs', url: 'https://amazon.com/dp/B01234575?tag=YOUR_TRACKING_ID' },
              { id: 'home2', title: 'Robot Vacuum Cleaner', price: 199.99, rating: 4.4, reviews: 7654, prime: true, image: 'https://via.placeholder.com/300x300?text=RobotVacuum', url: 'https://amazon.com/dp/B01234576?tag=YOUR_TRACKING_ID' },
              { id: 'home3', title: 'Weighted Blanket', price: 59.99, rating: 4.6, reviews: 12345, prime: true, image: 'https://via.placeholder.com/300x300?text=Blanket', url: 'https://amazon.com/dp/B01234577?tag=YOUR_TRACKING_ID' },
              { id: 'home4', title: 'Essential Oil Diffuser', price: 29.99, rating: 4.3, reviews: 6543, prime: false, image: 'https://via.placeholder.com/300x300?text=Diffuser', url: 'https://amazon.com/dp/B01234578?tag=YOUR_TRACKING_ID' }
            ],
            'bestsellers': [
              { id: 'best1', title: 'Wireless Earbuds', price: 49.99, rating: 4.5, reviews: 12543, prime: true, image: 'https://via.placeholder.com/300x300?text=Earbuds', url: 'https://amazon.com/dp/B01234567?tag=YOUR_TRACKING_ID' },
              { id: 'best2', title: 'Instant Pot Pressure Cooker', price: 89.95, rating: 4.8, reviews: 45678, prime: true, image: 'https://via.placeholder.com/300x300?text=InstantPot', url: 'https://amazon.com/dp/B01234571?tag=YOUR_TRACKING_ID' },
              { id: 'best3', title: 'Robot Vacuum Cleaner', price: 199.99, rating: 4.4, reviews: 7654, prime: true, image: 'https://via.placeholder.com/300x300?text=RobotVacuum', url: 'https://via.placeholder.com/300x300?text=RobotVacuum', url: 'https://amazon.com/dp/B01234576?tag=YOUR_TRACKING_ID' },
              { id: 'best4', title: 'Smart LED Light Bulbs', price: 39.99, rating: 4.5, reviews: 9876, prime: true, image: 'https://via.placeholder.com/300x300?text=SmartBulbs', url: 'https://amazon.com/dp/B01234575?tag=YOUR_TRACKING_ID' }
            ]
          };

          // Add more categories as needed

          // Return products for the specified category, or bestsellers if category not found
          return sampleProducts[category] || sampleProducts['bestsellers'];
        }
      }

      // 11. Ad Blocker Detection
      function initAdBlockerDetection() {
        // Only check once per session
        if (sessionStorage.getItem('kanahola-adblock-notice-shown') === 'true') {
          return;
        }

        // Create a bait element that ad blockers typically hide
        const bait = $('<div class="ad-bait" style="height: 1px; width: 1px; position: absolute; left: -10000px; top: -10000px;"><img src="ad-banner.jpg" alt=""></div>');
        $('body').append(bait);

        // Check if the bait is hidden (indicating ad blocker)
        setTimeout(function() {
          const baitIsHidden = bait.height() === 0 || bait.is(':hidden');

          if (baitIsHidden) {
            // Show ad blocker notice
            $('#ad-blocker-notice').addClass('active');

            // Mark as shown for this session
            sessionStorage.setItem('kanahola-adblock-notice-shown', 'true');
          }

          // Remove the bait
          bait.remove();
        }, 1000);

        // Close ad blocker notice when clicking the close button
        $('#ad-blocker-notice-close').on('click', function() {
          $('#ad-blocker-notice').removeClass('active');
        });
      }

      // 12. Social Proof Elements
      function initSocialProofElements() {
        // Initialize post view counter
        initPostViewCounter();

        // Initialize social share counters
        initSocialShareCounters();

        // Initialize reading time with engagement metrics
        initReadingEngagementMetrics();

        // Initialize popular posts by view count
        initPopularPostsByViewCount();
      }

      // 13. Content Recommendation System
      function initRecommendationSystem() {
        if (!isArticlePage()) return;

        // Get current post labels/tags
        const currentLabels = [];
        $('.post-tags .tags a').each(function() {
          currentLabels.push($(this).text().trim().toLowerCase());
        });

        if (currentLabels.length === 0) return; // No labels to base recommendations on

        // Create recommendation container if it doesn't exist
        if ($('.post-recommendations').length === 0) {
          const recommendationsHtml = `
            <div class="post-recommendations">
              <h3>Recommended Articles</h3>
              <div class="recommendations-container">
                <div class="recommendations-loading">
                  <div class="spinner"></div>
                  <p>Finding similar articles...</p>
                </div>
                <div class="recommendations-grid"></div>
              </div>
            </div>
          `;

          // Add to related posts section or create one
          if ($('.related-posts').length > 0) {
            $('.related-posts').before(recommendationsHtml);
          } else {
            $('.post-footer').append(recommendationsHtml);
          }
        }

        // Function to calculate similarity score between two label sets
        function calculateSimilarity(labelsA, labelsB) {
          // Jaccard similarity coefficient
          const intersection = labelsA.filter(label => labelsB.includes(label)).length;
          const union = new Set([...labelsA, ...labelsB]).size;

          return intersection / union;
        }

        // Get all posts from the blog
        const fetchRecommendations = async () => {
          try {
            // In a real implementation, this would fetch from the Blogger API
            // For SPA template, we'll use posts already in the DOM or fetch from feed

            const recommendationsGrid = $('.recommendations-grid');
            const currentPostUrl = window.location.pathname;
            const allPosts = [];

            // Collect posts from the homepage or category pages
            $('.post-card').each(function() {
              const postCard = $(this);
              const postUrl = postCard.find('.post-title a').attr('href');

              // Skip current post
              if (postUrl === currentPostUrl) return;

              const postTitle = postCard.find('.post-title').text().trim();
              const postImage = postCard.find('.post-thumbnail').attr('src') || '';
              const postExcerpt = postCard.find('.post-excerpt').text().trim();

              // Get labels if available
              const postLabels = [];
              postCard.find('.post-meta .post-labels a').each(function() {
                postLabels.push($(this).text().trim().toLowerCase());
              });

              allPosts.push({
                url: postUrl,
                title: postTitle,
                image: postImage,
                excerpt: postExcerpt,
                labels: postLabels,
                similarity: 0 // Will be calculated
              });
            });

            // If we don't have enough posts from the DOM, fetch from feed
            if (allPosts.length < 6) {
              // Fetch from feed (simplified for template)
              // In a real implementation, use the Blogger API

              // For now, generate some placeholder recommendations
              for (let i = allPosts.length; i < 6; i++) {
                allPosts.push({
                  url: `/sample-post-${i}`,
                  title: `Sample Recommended Post ${i}`,
                  image: 'https://via.placeholder.com/300x200',
                  excerpt: 'This is a placeholder for a recommended post based on your interests.',
                  labels: [currentLabels[Math.floor(Math.random() * currentLabels.length)]],
                  similarity: 0
                });
              }
            }

            // Calculate similarity scores
            allPosts.forEach(post => {
              post.similarity = calculateSimilarity(currentLabels, post.labels);
            });

            // Sort by similarity score (highest first)
            allPosts.sort((a, b) => b.similarity - a.similarity);

            // Take top 3-6 recommendations
            const recommendations = allPosts.slice(0, Math.min(6, allPosts.length));

            // Clear loading indicator
            $('.recommendations-loading').hide();

            // Display recommendations
            if (recommendations.length > 0) {
              recommendations.forEach(post => {
                const recommendationCard = `
                  <div class="recommendation-card" data-similarity="${post.similarity.toFixed(2)}">
                    <a href="${post.url}" class="recommendation-image-link">
                      <img src="${post.image}" alt="${post.title}" class="recommendation-image" loading="lazy">
                    </a>
                    <div class="recommendation-content">
                      <h4 class="recommendation-title">
                        <a href="${post.url}">${post.title}</a>
                      </h4>
                      <p class="recommendation-excerpt">${post.excerpt.substring(0, 100)}...</p>
                      <div class="recommendation-meta">
                        <span class="recommendation-similarity">
                          <i class="fas fa-percentage"></i> ${Math.round(post.similarity * 100)}% match
                        </span>
                      </div>
                    </div>
                  </div>
                `;

                recommendationsGrid.append(recommendationCard);
              });
            } else {
              recommendationsGrid.html('<p>No similar articles found.</p>');
            }
          } catch (error) {
            console.error('Error fetching recommendations:', error);
            $('.recommendations-loading').html('<p>Could not load recommendations.</p>');
          }
        };

        // Fetch recommendations after a short delay
        setTimeout(fetchRecommendations, 1000);
      }

      // 14. Responsive Gallery Layouts
      function initResponsiveGalleries() {
        if (!isArticlePage()) return;

        // Find potential gallery containers
        $('.post-body').find('div:has(> img:nth-child(1) + img:nth-child(2))').each(function() {
          // Skip if already processed
          if ($(this).hasClass('gallery-container')) return;

          const container = $(this);
          const images = container.find('img');

          // Only process if there are multiple images
          if (images.length < 2) return;

          // Add gallery classes
          container.addClass('gallery-container');

          // Determine gallery layout based on image count
          if (images.length === 2) {
            container.addClass('gallery-two-column');
          } else if (images.length === 3) {
            container.addClass('gallery-three-column');
          } else if (images.length === 4) {
            container.addClass('gallery-four-column');
          } else if (images.length > 4) {
            container.addClass('gallery-masonry');
          }

          // Add ARIA attributes for accessibility
          container.attr('role', 'region');
          container.attr('aria-label', 'Image gallery');

          // Wrap images in figure elements with captions if not already
          images.each(function(index) {
            const img = $(this);

            // Skip if already wrapped
            if (img.parent().is('figure')) return;

            // Get alt text for caption
            const altText = img.attr('alt') || '';

            // Wrap with figure and add caption
            img.wrap(`<figure class="gallery-item" role="img" aria-label="${altText}"></figure>`);

            // Add caption if alt text exists
            if (altText) {
              img.after(`<figcaption>${altText}</figcaption>`);
            }

            // Add data attributes for lightbox
            img.attr('data-gallery-index', index);
            img.attr('tabindex', '0');

            // Add click event for lightbox
            img.on('click', function() {
              openLightbox(container, index);
            });

            // Add keyboard accessibility
            img.on('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                openLightbox(container, index);
              }
            });
          });
        });

        // Process video embeds for responsive layout
        $('.post-body iframe[src*="youtube"], .post-body iframe[src*="vimeo"]').each(function() {
          const iframe = $(this);

          // Skip if already wrapped
          if (iframe.parent().hasClass('video-container')) return;

          // Wrap with responsive container
          iframe.wrap('<div class="video-container" role="region" aria-label="Video content"></div>');

          // Add loading attribute for better performance
          iframe.attr('loading', 'lazy');

          // Add title if missing
          if (!iframe.attr('title')) {
            iframe.attr('title', 'Embedded video');
          }
        });

        // Function to open lightbox
        function openLightbox(gallery, index) {
          // Create lightbox if it doesn't exist
          if ($('#gallery-lightbox').length === 0) {
            const lightboxHtml = `
              <div id="gallery-lightbox" class="gallery-lightbox" role="dialog" aria-modal="true" aria-label="Image gallery lightbox">
                <div class="lightbox-content">
                  <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
                  <button class="lightbox-prev" aria-label="Previous image">&lt;</button>
                  <button class="lightbox-next" aria-label="Next image">&gt;</button>
                  <div class="lightbox-image-container"></div>
                  <div class="lightbox-caption"></div>
                  <div class="lightbox-counter"></div>
                </div>
              </div>
            `;

            $('body').append(lightboxHtml);

            // Add event listeners
            $('#gallery-lightbox .lightbox-close').on('click', closeLightbox);
            $('#gallery-lightbox .lightbox-prev').on('click', showPrevImage);
            $('#gallery-lightbox .lightbox-next').on('click', showNextImage);

            // Close on background click
            $('#gallery-lightbox').on('click', function(e) {
              if (e.target === this) {
                closeLightbox();
              }
            });

            // Keyboard navigation
            $(document).on('keydown.lightbox', function(e) {
              if (e.key === 'Escape') {
                closeLightbox();
              } else if (e.key === 'ArrowLeft') {
                showPrevImage();
              } else if (e.key === 'ArrowRight') {
                showNextImage();
              }
            });
          }

          // Store current gallery and index
          const lightbox = $('#gallery-lightbox');
          lightbox.data('gallery', gallery);
          lightbox.data('index', index);
          lightbox.data('total', gallery.find('img').length);

          // Show current image
          showImage(index);

          // Show lightbox
          lightbox.addClass('active');
          $('body').addClass('lightbox-open');

          // Set focus to lightbox for accessibility
          lightbox.focus();
        }

        // Function to show image in lightbox
        function showImage(index) {
          const lightbox = $('#gallery-lightbox');
          const gallery = lightbox.data('gallery');
          const total = lightbox.data('total');

          // Ensure index is within bounds
          index = (index + total) % total;

          // Update current index
          lightbox.data('index', index);

          // Get image and caption
          const img = gallery.find(`img[data-gallery-index="${index}"]`);
          const caption = img.next('figcaption').text() || img.attr('alt') || '';

          // Update lightbox content
          const imageContainer = lightbox.find('.lightbox-image-container');
          imageContainer.empty().append(`<img src="${img.attr('src')}" alt="${img.attr('alt') || ''}">`);

          lightbox.find('.lightbox-caption').text(caption);
          lightbox.find('.lightbox-counter').text(`${index + 1} / ${total}`);

          // Show/hide navigation buttons
          lightbox.find('.lightbox-prev, .lightbox-next').toggle(total > 1);
        }

        // Function to show previous image
        function showPrevImage() {
          const lightbox = $('#gallery-lightbox');
          const currentIndex = lightbox.data('index');
          showImage(currentIndex - 1);
        }

        // Function to show next image
        function showNextImage() {
          const lightbox = $('#gallery-lightbox');
          const currentIndex = lightbox.data('index');
          showImage(currentIndex + 1);
        }

        // Function to close lightbox
        function closeLightbox() {
          const lightbox = $('#gallery-lightbox');
          lightbox.removeClass('active');
          $('body').removeClass('lightbox-open');

          // Remove keyboard event handler
          $(document).off('keydown.lightbox');

          // Return focus to the image that was clicked
          const gallery = lightbox.data('gallery');
          const index = lightbox.data('index');
          gallery.find(`img[data-gallery-index="${index}"]`).focus();
        }
      }

      // 15. Accordion/Collapsible Sections
      function initAccordionSections() {
        if (!isArticlePage()) return;

        // Find potential accordion containers
        $('.post-body').find('div[class*="accordion"], div[class*="collapsible"]').each(function() {
          // Skip if already processed
          if ($(this).hasClass('accordion-processed')) return;

          const container = $(this);
          container.addClass('accordion-processed');

          // Find all headings that could be accordion headers
          const headers = container.find('h2, h3, h4, h5, h6');

          headers.each(function() {
            const header = $(this);
            const content = getContentUntilNextHeader(header);

            if (!content.length) return;

            // Create accordion structure
            header.addClass('accordion-header');
            header.attr('role', 'button');
            header.attr('aria-expanded', 'false');
            header.attr('tabindex', '0');
            header.attr('aria-controls', `accordion-${generateId(header.text())}`);

            // Add toggle icon
            header.append('<span class="accordion-icon" aria-hidden="true"></span>');

            // Wrap content in panel
            content.wrapAll(`<div class="accordion-panel" id="accordion-${generateId(header.text())}" role="region" aria-labelledby="${header.attr('id') || ''}" hidden></div>`);

            // Add click event
            header.on('click', toggleAccordion);

            // Add keyboard accessibility
            header.on('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleAccordion.call(this);
              }
            });
          });
        });

        // Function to get content until next header
        function getContentUntilNextHeader(header) {
          const contents = $();
          let nextElement = header.next();

          while (nextElement.length && !nextElement.is('h2, h3, h4, h5, h6')) {
            contents.push(nextElement[0]);
            nextElement = nextElement.next();
          }

          return contents;
        }

        // Function to generate ID from text
        function generateId(text) {
          return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        }

        // Function to toggle accordion
        function toggleAccordion() {
          const header = $(this);
          const panelId = header.attr('aria-controls');
          const panel = $(`#${panelId}`);
          const isExpanded = header.attr('aria-expanded') === 'true';

          // Toggle state
          header.attr('aria-expanded', !isExpanded);

          if (isExpanded) {
            panel.slideUp(300, function() {
              panel.attr('hidden', '');
            });
          } else {
            panel.slideDown(300).removeAttr('hidden');
          }
        }
      }

      // 16. Content Tabs
      function initContentTabs() {
        if (!isArticlePage()) return;

        // Find potential tab containers
        $('.post-body').find('div[class*="tabs"]').each(function() {
          // Skip if already processed
          if ($(this).hasClass('tabs-processed')) return;

          const container = $(this);
          container.addClass('tabs-processed');

          // Find all headings that could be tab headers
          const headers = container.find('h3, h4, h5, h6');

          if (headers.length < 2) return; // Need at least 2 tabs

          // Create tabs structure
          const tabsId = `tabs-${Math.floor(Math.random() * 10000)}`;
          const tabList = $(`<div class="tabs-list" role="tablist" aria-label="Content tabs"></div>`);

          // Insert tab list before first header
          headers.first().before(tabList);

          // Process each header as a tab
          headers.each(function(index) {
            const header = $(this);
            const content = getContentUntilNextHeader(header);
            const tabId = `tab-${tabsId}-${index}`;
            const panelId = `panel-${tabsId}-${index}`;

            // Create tab button
            const tabButton = $(`<button id="${tabId}" class="tab-button" role="tab" aria-selected="${index === 0}" aria-controls="${panelId}" tabindex="${index === 0 ? 0 : -1}">${header.text()}</button>`);
            tabList.append(tabButton);

            // Create tab panel
            content.wrapAll(`<div id="${panelId}" class="tab-panel" role="tabpanel" aria-labelledby="${tabId}" ${index === 0 ? '' : 'hidden'}></div>`);

            // Hide original header
            header.hide();

            // Add click event
            tabButton.on('click', function() {
              activateTab(tabButton);
            });

            // Add keyboard navigation
            tabButton.on('keydown', function(e) {
              handleTabKeydown(e, index, headers.length);
            });
          });

          // Function to activate a tab
          function activateTab(tabButton) {
            // Deactivate all tabs
            tabList.find('.tab-button').attr('aria-selected', 'false').attr('tabindex', '-1');
            container.find('.tab-panel').attr('hidden', '');

            // Activate selected tab
            tabButton.attr('aria-selected', 'true').attr('tabindex', '0');
            $(`#${tabButton.attr('aria-controls')}`).removeAttr('hidden');

            // Focus the tab button
            tabButton.focus();
          }

          // Function to handle keyboard navigation
          function handleTabKeydown(e, index, total) {
            let newIndex;

            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
              newIndex = (index - 1 + total) % total;
              e.preventDefault();
            } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
              newIndex = (index + 1) % total;
              e.preventDefault();
            } else if (e.key === 'Home') {
              newIndex = 0;
              e.preventDefault();
            } else if (e.key === 'End') {
              newIndex = total - 1;
              e.preventDefault();
            } else {
              return;
            }

            // Activate the new tab
            activateTab(tabList.find('.tab-button').eq(newIndex));
          }
        });

        // Function to get content until next header
        function getContentUntilNextHeader(header) {
          const contents = $();
          let nextElement = header.next();

          while (nextElement.length && !nextElement.is('h3, h4, h5, h6')) {
            contents.push(nextElement[0]);
            nextElement = nextElement.next();
          }

          return contents;
        }
      }

      // 12.1 Post View Counter
      function initPostViewCounter() {
        if (!isArticlePage()) return;

        const postId = $('.single-post').data('post-id') || window.location.pathname;
        const viewCountElement = $('.post-view-counter');

        if (viewCountElement.length === 0) return;

        // Get view count from localStorage
        const viewCounts = JSON.parse(localStorage.getItem('kanahola-view-counts') || '{}');

        // Increment view count for this post
        if (!viewCounts[postId]) {
          viewCounts[postId] = 0;
        }
        viewCounts[postId]++;

        // Save updated view counts
        localStorage.setItem('kanahola-view-counts', JSON.stringify(viewCounts));

        // Update view count display
        viewCountElement.html(`<i class="fas fa-eye"></i> ${viewCounts[postId]} views`);
      }

      // 12.2 Social Share Counters
      function initSocialShareCounters() {
        if (!isArticlePage()) return;

        const shareContainer = $('.social-share-container');

        if (shareContainer.length === 0) return;

        // Get current URL and title for sharing
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);

        // Set up share URLs
        const shareUrls = {
          facebook: `https://www.facebook.com/sharer/sharer.php?u=${url}`,
          twitter: `https://twitter.com/intent/tweet?url=${url}&text=${title}`,
          pinterest: `https://pinterest.com/pin/create/button/?url=${url}&description=${title}`,
          linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${url}`,
          whatsapp: `https://api.whatsapp.com/send?text=${title} ${url}`
        };

        // Add click handlers for share buttons
        shareContainer.find('.social-share-button').each(function() {
          const platform = $(this).data('platform');

          if (shareUrls[platform]) {
            $(this).attr('href', shareUrls[platform]);
            $(this).attr('target', '_blank');
            $(this).attr('rel', 'noopener noreferrer');

            // Track share clicks
            $(this).on('click', function() {
              incrementShareCount(platform);
            });
          }
        });

        // Load initial share counts
        loadShareCounts();

        // Function to load share counts from localStorage
        function loadShareCounts() {
          const postId = $('.single-post').data('post-id') || window.location.pathname;
          const shareCounts = JSON.parse(localStorage.getItem('kanahola-share-counts') || '{}');

          if (!shareCounts[postId]) {
            shareCounts[postId] = {
              facebook: 0,
              twitter: 0,
              pinterest: 0,
              linkedin: 0,
              whatsapp: 0
            };
          }

          // Update share count displays
          for (const platform in shareCounts[postId]) {
            const count = shareCounts[postId][platform];
            $(`.social-share-counter[data-platform="${platform}"]`).text(count);
          }
        }

        // Function to increment share count
        function incrementShareCount(platform) {
          const postId = $('.single-post').data('post-id') || window.location.pathname;
          const shareCounts = JSON.parse(localStorage.getItem('kanahola-share-counts') || '{}');

          if (!shareCounts[postId]) {
            shareCounts[postId] = {};
          }

          if (!shareCounts[postId][platform]) {
            shareCounts[postId][platform] = 0;
          }

          shareCounts[postId][platform]++;

          // Save updated share counts
          localStorage.setItem('kanahola-share-counts', JSON.stringify(shareCounts));

          // Update share count display
          $(`.social-share-counter[data-platform="${platform}"]`).text(shareCounts[postId][platform]);
        }
      }

      // 12.3 Reading Time with Engagement Metrics
      function initReadingEngagementMetrics() {
        if (!isArticlePage()) return;

        const article = $('.post-body');
        const engagementMeter = $('.engagement-meter-fill');

        if (article.length === 0 || engagementMeter.length === 0) return;

        // Track scroll depth and time spent
        let maxScrollDepth = 0;
        let startTime = Date.now();
        let isEngaged = true;

        // Update engagement on scroll
        $(window).on('scroll', function() {
          const windowHeight = $(window).height();
          const documentHeight = $(document).height();
          const scrollTop = $(window).scrollTop();
          const articleTop = article.offset().top;
          const articleHeight = article.height();
          const articleBottom = articleTop + articleHeight;

          // Calculate scroll depth as percentage
          if (scrollTop > articleTop && scrollTop < articleBottom) {
            const articleScrolled = scrollTop - articleTop;
            const scrollDepth = Math.min(articleScrolled / articleHeight, 1) * 100;

            // Update max scroll depth
            if (scrollDepth > maxScrollDepth) {
              maxScrollDepth = scrollDepth;

              // Update engagement meter
              engagementMeter.css('width', maxScrollDepth + '%');
            }
          }
        });

        // Track if user is engaged (active on page)
        $(document).on('mousemove keydown', function() {
          isEngaged = true;
        });

        // Check engagement every 5 seconds
        setInterval(function() {
          if (!isEngaged) return;

          isEngaged = false;

          // Calculate time spent in seconds
          const timeSpent = Math.floor((Date.now() - startTime) / 1000);

          // Save engagement metrics
          saveEngagementMetrics(maxScrollDepth, timeSpent);
        }, 5000);

        // Save engagement metrics when leaving the page
        $(window).on('beforeunload', function() {
          const timeSpent = Math.floor((Date.now() - startTime) / 1000);
          saveEngagementMetrics(maxScrollDepth, timeSpent);
        });

        // Function to save engagement metrics
        function saveEngagementMetrics(scrollDepth, timeSpent) {
          const postId = $('.single-post').data('post-id') || window.location.pathname;
          const engagementMetrics = JSON.parse(localStorage.getItem('kanahola-engagement-metrics') || '{}');

          if (!engagementMetrics[postId]) {
            engagementMetrics[postId] = {
              maxScrollDepth: 0,
              totalTimeSpent: 0,
              visits: 0
            };
          }

          // Update metrics
          engagementMetrics[postId].maxScrollDepth = Math.max(engagementMetrics[postId].maxScrollDepth, scrollDepth);
          engagementMetrics[postId].totalTimeSpent += timeSpent;
          engagementMetrics[postId].visits++;

          // Save updated metrics
          localStorage.setItem('kanahola-engagement-metrics', JSON.stringify(engagementMetrics));
        }
      }

      // 12.4 Popular Posts by View Count
      function initPopularPostsByViewCount() {
        const popularPostsWidget = $('.popular-posts-widget');

        if (popularPostsWidget.length === 0) return;

        // Get view counts from localStorage
        const viewCounts = JSON.parse(localStorage.getItem('kanahola-view-counts') || '{}');

        // Sort posts by view count
        const sortedPosts = Object.keys(viewCounts).sort((a, b) => {
          return viewCounts[b] - viewCounts[a];
        });

        // Display top 5 posts
        // Note: In a real implementation, you would fetch the actual post data
        // For demo purposes, we'll just show placeholder data
        if (sortedPosts.length > 0) {
          let popularPostsHtml = '<h3 class="widget-title">Popular Posts</h3>';

          for (let i = 0; i < Math.min(5, sortedPosts.length); i++) {
            const postId = sortedPosts[i];
            const viewCount = viewCounts[postId];

            popularPostsHtml += `
              <div class="popular-post-item">
                <div class="popular-post-thumbnail">
                  <img src="https://via.placeholder.com/80x80" alt="Popular post">
                </div>
                <div class="popular-post-content">
                  <h4 class="popular-post-title"><a href="${postId}">Popular Article ${i + 1}</a></h4>
                  <div class="popular-post-meta">
                    <span class="post-view-counter"><i class="fas fa-eye"></i> ${viewCount} views</span>
                  </div>
                </div>
              </div>
            `;
          }

          popularPostsWidget.html(popularPostsHtml);
        }
      }

      // 12.5 Social Media Preview Tool
      function initSocialMediaPreviewTool() {
        // Only initialize on post edit/compose pages
        if (!isEditPage()) return;

        // Create the preview tool container if it doesn't exist
        if ($('#social-preview-tool').length === 0) {
          const previewToolHtml = `
            <div id="social-preview-tool" class="social-preview-tool">
              <div class="social-preview-header">
                <h3>Social Media Preview</h3>
                <div class="social-preview-tabs">
                  <button class="preview-tab active" data-platform="facebook">Facebook</button>
                  <button class="preview-tab" data-platform="twitter">Twitter</button>
                  <button class="preview-tab" data-platform="linkedin">LinkedIn</button>
                </div>
              </div>
              <div class="social-preview-content">
                <div class="preview-platform facebook active">
                  <div class="facebook-preview">
                    <div class="fb-preview-header">
                      <div class="fb-profile">
                        <div class="fb-profile-image"></div>
                        <div class="fb-profile-info">
                          <div class="fb-page-name">Kanahola Magazine</div>
                          <div class="fb-post-time">Just now  <i class="fas fa-globe"></i></div>
                        </div>
                      </div>
                    </div>
                    <div class="fb-preview-text"></div>
                    <div class="fb-preview-card">
                      <div class="fb-preview-image"></div>
                      <div class="fb-preview-content">
                        <div class="fb-preview-domain">kanaholamagazine.com</div>
                        <div class="fb-preview-title"></div>
                        <div class="fb-preview-description"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="preview-platform twitter">
                  <div class="twitter-preview">
                    <div class="twitter-preview-header">
                      <div class="twitter-profile-image"></div>
                      <div class="twitter-profile-info">
                        <div class="twitter-name">Kanahola Magazine</div>
                        <div class="twitter-handle">@kanahola</div>
                      </div>
                    </div>
                    <div class="twitter-preview-text">Check out our latest article!</div>
                    <div class="twitter-preview-card">
                      <div class="twitter-preview-image"></div>
                      <div class="twitter-preview-content">
                        <div class="twitter-preview-title"></div>
                        <div class="twitter-preview-description"></div>
                        <div class="twitter-preview-domain">kanaholamagazine.com</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="preview-platform linkedin">
                  <div class="linkedin-preview">
                    <div class="linkedin-preview-header">
                      <div class="linkedin-profile">
                        <div class="linkedin-profile-image"></div>
                        <div class="linkedin-profile-info">
                          <div class="linkedin-name">Kanahola Magazine</div>
                          <div class="linkedin-meta">Company  Just now</div>
                        </div>
                      </div>
                    </div>
                    <div class="linkedin-preview-text">Check out our latest article!</div>
                    <div class="linkedin-preview-card">
                      <div class="linkedin-preview-image"></div>
                      <div class="linkedin-preview-content">
                        <div class="linkedin-preview-title"></div>
                        <div class="linkedin-preview-description"></div>
                        <div class="linkedin-preview-domain">kanaholamagazine.com</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="social-preview-customize">
                <h4>Customize Social Appearance</h4>
                <div class="customize-field">
                  <label for="social-title">Title</label>
                  <input type="text" id="social-title" placeholder="Enter title for social media">
                </div>
                <div class="customize-field">
                  <label for="social-description">Description</label>
                  <textarea id="social-description" placeholder="Enter description for social media"></textarea>
                </div>
                <div class="customize-field">
                  <label for="social-image">Image URL</label>
                  <input type="text" id="social-image" placeholder="Enter image URL for social media">
                  <button id="detect-images-btn" class="btn-secondary">Detect Images</button>
                </div>
                <div class="image-suggestions" style="display: none;">
                  <h5>Suggested Images</h5>
                  <div class="image-suggestions-grid"></div>
                </div>
                <div class="customize-actions">
                  <button id="update-preview-btn" class="btn-primary">Update Preview</button>
                  <button id="apply-metadata-btn" class="btn-secondary">Apply to Post</button>
                </div>
              </div>
            </div>
          `;

          // Add the preview tool to the page
          $('.post-editor-sidebar, .sidebar, #sidebar').append(previewToolHtml);

          // Add styles for the preview tool
          const previewToolStyles = `
            <style>
              .social-preview-tool {
                background-color: var(--light-gray);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              }

              .social-preview-header {
                margin-bottom: 15px;
              }

              .social-preview-tabs {
                display: flex;
                border-bottom: 1px solid var(--border-color);
                margin-top: 10px;
              }

              .preview-tab {
                background: none;
                border: none;
                padding: 8px 15px;
                cursor: pointer;
                font-weight: 500;
                color: var(--dark-gray);
                border-bottom: 2px solid transparent;
              }

              .preview-tab.active {
                color: var(--primary-color);
                border-bottom: 2px solid var(--primary-color);
              }

              .social-preview-content {
                background-color: var(--background-color);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 20px;
              }

              .preview-platform {
                display: none;
                padding: 15px;
              }

              .preview-platform.active {
                display: block;
              }

              /* Facebook Preview Styles */
              .facebook-preview {
                font-family: Helvetica, Arial, sans-serif;
              }

              .fb-profile {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
              }

              .fb-profile-image {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background-color: #4267B2;
                margin-right: 10px;
              }

              .fb-page-name {
                font-weight: bold;
                font-size: 14px;
              }

              .fb-post-time {
                font-size: 12px;
                color: #65676B;
              }

              .fb-preview-text {
                margin-bottom: 10px;
                font-size: 14px;
              }

              .fb-preview-card {
                border: 1px solid #E4E6EB;
                border-radius: 8px;
                overflow: hidden;
              }

              .fb-preview-image {
                height: 200px;
                background-color: #F0F2F5;
                background-size: cover;
                background-position: center;
              }

              .fb-preview-content {
                padding: 10px 12px;
                background-color: #F0F2F5;
              }

              .fb-preview-domain {
                font-size: 12px;
                color: #65676B;
                text-transform: uppercase;
                margin-bottom: 5px;
              }

              .fb-preview-title {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 5px;
                color: #050505;
              }

              .fb-preview-description {
                font-size: 14px;
                color: #65676B;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
              }

              /* Twitter Preview Styles */
              .twitter-preview {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                background-color: #ffffff;
                border-radius: 12px;
                border: 1px solid #E1E8ED;
                overflow: hidden;
              }

              .twitter-preview-header {
                display: flex;
                align-items: center;
                padding: 12px 16px;
              }

              .twitter-profile-image {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                background-color: #1DA1F2;
                margin-right: 10px;
              }

              .twitter-name {
                font-weight: bold;
                font-size: 15px;
              }

              .twitter-handle {
                font-size: 14px;
                color: #657786;
              }

              .twitter-preview-text {
                padding: 0 16px 10px;
                font-size: 15px;
              }

              .twitter-preview-card {
                border: 1px solid #E1E8ED;
                border-radius: 12px;
                overflow: hidden;
                margin: 0 16px 16px;
              }

              .twitter-preview-image {
                height: 180px;
                background-color: #E1E8ED;
                background-size: cover;
                background-position: center;
              }

              .twitter-preview-content {
                padding: 12px;
              }

              .twitter-preview-title {
                font-weight: bold;
                font-size: 15px;
                margin-bottom: 5px;
                color: #14171A;
              }

              .twitter-preview-description {
                font-size: 14px;
                color: #657786;
                margin-bottom: 5px;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
              }

              .twitter-preview-domain {
                font-size: 14px;
                color: #657786;
              }

              /* LinkedIn Preview Styles */
              .linkedin-preview {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                background-color: #ffffff;
                border: 1px solid #E6E9EC;
                border-radius: 8px;
                overflow: hidden;
              }

              .linkedin-preview-header {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                border-bottom: 1px solid #E6E9EC;
              }

              .linkedin-profile-image {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                background-color: #0077B5;
                margin-right: 10px;
              }

              .linkedin-name {
                font-weight: bold;
                font-size: 14px;
              }

              .linkedin-meta {
                font-size: 12px;
                color: #666666;
              }

              .linkedin-preview-text {
                padding: 12px 16px;
                font-size: 14px;
              }

              .linkedin-preview-card {
                border: 1px solid #E6E9EC;
                overflow: hidden;
                margin: 0 16px 16px;
              }

              .linkedin-preview-image {
                height: 180px;
                background-color: #F3F6F8;
                background-size: cover;
                background-position: center;
              }

              .linkedin-preview-content {
                padding: 12px;
              }

              .linkedin-preview-title {
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 5px;
              }

              .linkedin-preview-description {
                font-size: 13px;
                color: #666666;
                margin-bottom: 5px;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
              }

              .linkedin-preview-domain {
                font-size: 12px;
                color: #666666;
              }

              /* Customize Section Styles */
              .social-preview-customize {
                background-color: var(--background-color);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 15px;
              }

              .customize-field {
                margin-bottom: 15px;
              }

              .customize-field label {
                display: block;
                margin-bottom: 5px;
                font-weight: 500;
              }

              .customize-field input,
              .customize-field textarea {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 14px;
              }

              .customize-field textarea {
                height: 80px;
                resize: vertical;
              }

              .customize-actions {
                display: flex;
                gap: 10px;
                margin-top: 20px;
              }

              .btn-primary {
                background-color: var(--primary-color);
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
              }

              .btn-secondary {
                background-color: var(--light-gray);
                color: var(--text-color);
                border: 1px solid var(--border-color);
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
              }

              .image-suggestions {
                margin-top: 15px;
                margin-bottom: 15px;
              }

              .image-suggestions-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                margin-top: 10px;
              }

              .image-suggestion {
                height: 80px;
                background-size: cover;
                background-position: center;
                border-radius: 4px;
                cursor: pointer;
                border: 2px solid transparent;
              }

              .image-suggestion.selected {
                border-color: var(--primary-color);
              }

              /* Dark mode styles */
              html.dark .social-preview-tool {
                background-color: var(--light-gray);
              }

              html.dark .social-preview-content,
              html.dark .social-preview-customize {
                background-color: var(--card-bg);
                border-color: var(--border-color);
              }

              html.dark .preview-tab {
                color: var(--text-color);
              }

              html.dark .preview-tab.active {
                color: var(--primary-color);
                border-bottom-color: var(--primary-color);
              }

              html.dark .customize-field input,
              html.dark .customize-field textarea {
                background-color: var(--light-gray);
                color: var(--text-color);
                border-color: var(--border-color);
              }

              html.dark .btn-primary {
                background-color: var(--primary-color);
                color: var(--background-color);
              }

              html.dark .btn-secondary {
                background-color: var(--medium-gray);
                color: var(--text-color);
                border-color: var(--border-color);
              }
            </style>
          `;

          // Add the styles to the head
          $('head').append(previewToolStyles);

          // Initialize the preview tool functionality
          initSocialPreviewFunctionality();
        }
      }

      // Helper function to check if we're on an edit page
      function isEditPage() {
        return window.location.href.includes('/editor/') ||
               window.location.href.includes('/compose') ||
               window.location.href.includes('/edit') ||
               $('.post-editor').length > 0;
      }

      // Initialize social preview functionality
      function initSocialPreviewFunctionality() {
        // Tab switching
        $('.preview-tab').on('click', function() {
          const platform = $(this).data('platform');

          // Update active tab
          $('.preview-tab').removeClass('active');
          $(this).addClass('active');

          // Show selected platform preview
          $('.preview-platform').removeClass('active');
          $(`.preview-platform.${platform}`).addClass('active');
        });

        // Initialize with current post data
        updateSocialPreview();

        // Update preview button
        $('#update-preview-btn').on('click', function() {
          updateSocialPreview();
        });

        // Apply metadata button
        $('#apply-metadata-btn').on('click', function() {
          applySocialMetadata();
        });

        // Detect images button
        $('#detect-images-btn').on('click', function() {
          detectPostImages();
        });
      }

      // Update social preview with current values
      function updateSocialPreview() {
        // Get values from form or post content
        const title = $('#social-title').val() || $('.post-title').text() || document.title;
        const description = $('#social-description').val() || extractDescription();
        const imageUrl = $('#social-image').val() || extractFirstImage();

        // Update Facebook preview
        $('.fb-preview-title').text(title);
        $('.fb-preview-description').text(description);
        if (imageUrl) {
          $('.fb-preview-image').css('background-image', `url(${imageUrl})`);
        }

        // Update Twitter preview
        $('.twitter-preview-title').text(title);
        $('.twitter-preview-description').text(description);
        if (imageUrl) {
          $('.twitter-preview-image').css('background-image', `url(${imageUrl})`);
        }

        // Update LinkedIn preview
        $('.linkedin-preview-title').text(title);
        $('.linkedin-preview-description').text(description);
        if (imageUrl) {
          $('.linkedin-preview-image').css('background-image', `url(${imageUrl})`);
        }
      }

      // Extract description from post content
      function extractDescription() {
        let description = '';

        if ($('.post-excerpt').length > 0) {
          description = $('.post-excerpt').text().trim();
        } else if ($('.post-body p').length > 0) {
          description = $('.post-body p').first().text().trim();
        } else if ($('meta[name="description"]').length > 0) {
          description = $('meta[name="description"]').attr('content');
        } else {
          description = 'Kanahola Magazine - Your source for insightful articles and stories';
        }

        // Truncate description if too long
        if (description.length > 200) {
          description = description.substring(0, 197) + '...';
        }

        return description;
      }

      // Extract first image from post content
      function extractFirstImage() {
        let imageUrl = '';

        if ($('.post-featured-image img').length > 0) {
          imageUrl = $('.post-featured-image img').attr('src');
        } else if ($('.post-body img').length > 0) {
          imageUrl = $('.post-body img').first().attr('src');
        } else if ($('.author-avatar img').length > 0) {
          imageUrl = $('.author-avatar img').attr('src');
        } else {
          imageUrl = $('link[rel="icon"]').attr('href') || 'https://kanaholamagazine.com/logo.png';
        }

        return imageUrl;
      }

      // Detect all images in the post
      function detectPostImages() {
        const images = [];

        // Collect all images from the post
        if ($('.post-featured-image img').length > 0) {
          images.push($('.post-featured-image img').attr('src'));
        }

        $('.post-body img').each(function() {
          images.push($(this).attr('src'));
        });

        if (images.length === 0) {
          // No images found, use default
          images.push($('link[rel="icon"]').attr('href') || 'https://kanaholamagazine.com/logo.png');
        }

        // Display image suggestions
        displayImageSuggestions(images);
      }

      // Display image suggestions
      function displayImageSuggestions(images) {
        const suggestionsGrid = $('.image-suggestions-grid');
        suggestionsGrid.empty();

        // Add each image as a suggestion
        images.forEach((imageUrl, index) => {
          const imageHtml = `<div class="image-suggestion" data-url="${imageUrl}" style="background-image: url(${imageUrl})"></div>`;
          suggestionsGrid.append(imageHtml);
        });

        // Show the suggestions section
        $('.image-suggestions').show();

        // Add click handler for image selection
        $('.image-suggestion').on('click', function() {
          const imageUrl = $(this).data('url');

          // Update the image URL input
          $('#social-image').val(imageUrl);

          // Update the selected state
          $('.image-suggestion').removeClass('selected');
          $(this).addClass('selected');

          // Update the preview
          updateSocialPreview();
        });
      }

      // Apply social metadata to the post
      function applySocialMetadata() {
        const title = $('#social-title').val() || $('.post-title').text() || document.title;
        const description = $('#social-description').val() || extractDescription();
        const imageUrl = $('#social-image').val() || extractFirstImage();

        // Update Open Graph meta tags
        $('meta[property="og:title"]').attr('content', title);
        $('meta[property="og:description"]').attr('content', description);
        $('#og-image-meta').attr('content', imageUrl);

        // Update Twitter Card meta tags
        $('#twitter-title-meta').attr('content', title);
        $('#twitter-desc-meta').attr('content', description);
        $('#twitter-image-meta').attr('content', imageUrl);

        // Show success message
        showNotification('Social metadata applied successfully!');
      }

      // Show notification
      function showNotification(message) {
        // Create notification if it doesn't exist
        if ($('#social-notification').length === 0) {
          $('body').append(`
            <div id="social-notification" class="notification">
              <div class="notification-content">
                <i class="fas fa-check-circle"></i>
                <span class="notification-message">${message}</span>
              </div>
            </div>
          `);
        } else {
          // Update existing notification
          $('.notification-message').text(message);
        }

        // Show notification
        setTimeout(function() {
          $('#social-notification').addClass('active');
        }, 100);

        // Hide notification after 3 seconds
        setTimeout(function() {
          $('#social-notification').removeClass('active');
        }, 3000);
      }

      // Initialize on document ready
      $(document).ready(function() {
        initUXEnhancements();
      });

      // Re-initialize when SPA loads new content
      $(document).on('spa:contentLoaded', function() {
        initUXEnhancements();
      });

    })(jQuery);

    // Load scripts after page load
    window.addEventListener('load', function() {
      // Load Font Awesome asynchronously
      if ('requestIdleCallback' in window) {
        requestIdleCallback(loadFontAwesome);
        requestIdleCallback(loadPrismJS);
      } else {
        setTimeout(loadFontAwesome, 1000);
        setTimeout(loadPrismJS, 1500);
      }
    });

    // Enhanced Prism.js for code syntax highlighting
    function loadPrismJS() {
      // Load Prism CSS with theme support
      const prismCSS = document.createElement('link');
      prismCSS.rel = 'stylesheet';
      prismCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css';
      prismCSS.id = 'prism-theme';
      document.head.appendChild(prismCSS);

      // Add alternate theme for light mode
      const prismLightCSS = document.createElement('link');
      prismLightCSS.rel = 'stylesheet alternate';
      prismLightCSS.href = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-solarizedlight.min.css';
      prismLightCSS.id = 'prism-light-theme';
      document.head.appendChild(prismLightCSS);

      // Load Prism JS
      const prismJS = document.createElement('script');
      prismJS.src = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js';
      document.body.appendChild(prismJS);

      // Load Prism components for various languages (expanded list)
      const languages = [
        'markup', 'css', 'javascript', 'java', 'python',
        'bash', 'c', 'cpp', 'csharp', 'ruby', 'php',
        'typescript', 'jsx', 'tsx', 'json', 'yaml',
        'markdown', 'sql', 'go', 'kotlin', 'swift',
        'dart', 'rust', 'scala', 'haskell', 'graphql',
        'regex', 'powershell', 'docker', 'nginx'
      ];

      // Load languages in batches to improve performance
      function loadLanguageBatch(batch) {
        if (batch.length === 0) return;

        const lang = batch.shift();
        const script = document.createElement('script');
        script.src = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-${lang}.min.js`;

        script.onload = function() {
          loadLanguageBatch(batch);
        };

        document.body.appendChild(script);
      }

      // Start loading languages in batches of 5
      for (let i = 0; i < 5; i++) {
        if (languages.length > 0) {
          loadLanguageBatch(languages.slice(i * 5, (i + 1) * 5));
        }
      }

      // Load Prism plugins with enhanced functionality
      const plugins = [
        'line-numbers', 'toolbar', 'copy-to-clipboard',
        'show-language', 'match-braces', 'diff-highlight',
        'treeview', 'autoloader', 'line-highlight'
      ];

      plugins.forEach(plugin => {
        const script = document.createElement('script');
        script.src = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/${plugin}/prism-${plugin}.min.js`;
        document.body.appendChild(script);

        // Load CSS for plugins that need it
        if (['line-numbers', 'toolbar', 'match-braces', 'diff-highlight', 'treeview', 'line-highlight'].includes(plugin)) {
          const css = document.createElement('link');
          css.rel = 'stylesheet';
          css.href = `https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/${plugin}/prism-${plugin}.min.css`;
          document.head.appendChild(css);
        }
      });

      // Initialize Prism.js for code blocks with enhanced features
      prismJS.onload = function() {
        initCodeBlocks();

        // Re-initialize when theme changes
        document.addEventListener('themeChanged', function(e) {
          updatePrismTheme(e.detail.theme);
        });
      };
    }

    // Enhanced code block initialization
    function initCodeBlocks() {
      // Process all code blocks
      document.querySelectorAll('pre:not(.prism-enhanced)').forEach(pre => {
        // Mark as enhanced to avoid duplicate processing
        pre.classList.add('prism-enhanced');

        // Add line-numbers class for line numbering
        pre.classList.add('line-numbers');

        // Add data attributes for plugins
        pre.setAttribute('data-start', '1');

        // Wrap code blocks with language class if not already present
        const code = pre.querySelector('code');
        if (code) {
          // Auto-detect language if not specified
          if (!Array.from(code.classList).some(cls => cls.startsWith('language-'))) {
            const detectedLang = detectCodeLanguage(code.textContent.trim());
            code.classList.add(`language-${detectedLang}`);
          }

          // Add copy button if toolbar plugin is loaded
          if (typeof Prism.plugins.toolbar !== 'undefined') {
            Prism.plugins.toolbar.registerButton('copy-to-clipboard', function(env) {
              const button = document.createElement('button');
              button.textContent = 'Copy';
              button.className = 'copy-button';

              button.addEventListener('click', function() {
                // Copy code to clipboard
                const textToCopy = env.element.textContent;

                navigator.clipboard.writeText(textToCopy).then(
                  function() {
                    // Success feedback
                    button.textContent = 'Copied!';
                    button.classList.add('success');

                    setTimeout(function() {
                      button.textContent = 'Copy';
                      button.classList.remove('success');
                    }, 2000);
                  },
                  function() {
                    // Fallback for older browsers
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    textarea.style.position = 'fixed';
                    document.body.appendChild(textarea);
                    textarea.select();

                    try {
                      document.execCommand('copy');
                      button.textContent = 'Copied!';
                      button.classList.add('success');
                    } catch (err) {
                      button.textContent = 'Failed!';
                      button.classList.add('error');
                    }

                    document.body.removeChild(textarea);

                    setTimeout(function() {
                      button.textContent = 'Copy';
                      button.classList.remove('success', 'error');
                    }, 2000);
                  }
                );
              });

              return button;
            });
          }
        }
      });

      // Highlight all code blocks
      if (typeof Prism !== 'undefined') {
        Prism.highlightAll();
      }

      // Set initial theme based on current mode
      updatePrismTheme(document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    }

    // Advanced language detection algorithm
    function detectCodeLanguage(code) {
      // Default to markup if we can't detect
      let detectedLang = 'markup';

      // Common language patterns
      const patterns = {
        html: {
          pattern: /<\/?(?:html|head|body|div|span|h[1-6]|p|a|img|ul|ol|li|table|tr|td|th|form|input|button)/i,
          score: 0
        },
        css: {
          pattern: /(?:body|div|\.[\w-]+|#[\w-]+)\s*\{[\s\S]*?\}/i,
          score: 0
        },
        javascript: {
          pattern: /(?:function|const|let|var|return|if|for|while|document|window)\b/i,
          score: 0
        },
        typescript: {
          pattern: /(?:interface|type|namespace|enum|implements|extends|public|private|protected|readonly)\b/i,
          score: 0
        },
        python: {
          pattern: /(?:def|class|import|from|if|for|while|with|try|except)\b/i,
          score: 0
        },
        java: {
          pattern: /(?:public|private|protected|class|interface|extends|implements|import|package)\b/i,
          score: 0
        },
        php: {
          pattern: /(?:<\?php|\$\w+|function|echo|namespace|use|class|public|private|protected)\b/i,
          score: 0
        },
        ruby: {
          pattern: /(?:def|class|module|require|include|attr_accessor|if|end)\b/i,
          score: 0
        },
        bash: {
          pattern: /(?:#!/|echo|read|if|then|else|fi|for|do|done|case|esac)\b/i,
          score: 0
        },
        csharp: {
          pattern: /(?:using|namespace|class|public|private|protected|void|string|int|bool|var|async|await)\b/i,
          score: 0
        },
        json: {
          pattern: /^\s*\{\s*"[\w\s]+"\s*:/i,
          score: 0
        },
        xml: {
          pattern: /<?xml|<\w+:[\w-]+|xmlns:/i,
          score: 0
        },
        sql: {
          pattern: /(?:SELECT|INSERT|UPDATE|DELETE|CREATE|ALTER|DROP|FROM|WHERE|GROUP BY|ORDER BY|HAVING)\b/i,
          score: 0
        },
        markdown: {
          pattern: /(?:^#{1,6}\s|^>\s|^-\s|^[0-9]+\.\s|^```)/im,
          score: 0
        }
      };

      // Calculate scores for each language
      for (const lang in patterns) {
        const matches = (code.match(patterns[lang].pattern) || []).length;
        patterns[lang].score = matches;
      }

      // Find language with highest score
      let highestScore = 0;
      for (const lang in patterns) {
        if (patterns[lang].score > highestScore) {
          highestScore = patterns[lang].score;
          detectedLang = lang;
        }
      }

      // Special case handling
      if (detectedLang === 'xml' && patterns.html.score > 0) {
        detectedLang = 'html';
      }

      if (detectedLang === 'javascript' && patterns.typescript.score > 0) {
        detectedLang = 'typescript';
      }

      // Map to Prism's language identifiers
      const langMap = {
        'html': 'markup',
        'xml': 'markup',
        'javascript': 'javascript',
        'typescript': 'typescript',
        'css': 'css',
        'python': 'python',
        'java': 'java',
        'php': 'php',
        'ruby': 'ruby',
        'bash': 'bash',
        'csharp': 'csharp',
        'json': 'json',
        'sql': 'sql',
        'markdown': 'markdown'
      };

      return langMap[detectedLang] || 'markup';
    }

    // Update Prism theme based on current mode
    function updatePrismTheme(theme) {
      const darkTheme = document.getElementById('prism-theme');
      const lightTheme = document.getElementById('prism-light-theme');

      if (theme === 'dark') {
        darkTheme.rel = 'stylesheet';
        lightTheme.rel = 'stylesheet alternate';
      } else {
        darkTheme.rel = 'stylesheet alternate';
        lightTheme.rel = 'stylesheet';
      }
    }

    // Enhanced Media Gallery Functionality
    (function($) {
      'use strict';

      // Initialize gallery when content is loaded
      function initGallery() {
        // Find all galleries in the content
        $('.post-body').find('div:has(> img + img)').each(function() {
          // Skip if already processed
          if ($(this).hasClass('gallery')) return;

          // Convert to gallery if it contains multiple images
          const images = $(this).find('img');
          if (images.length >= 2) {
            $(this).addClass('gallery');

            // Wrap each image in a gallery item
            images.each(function() {
              const img = $(this);
              const caption = img.attr('alt') || '';

              // Skip if already wrapped
              if (img.parent().hasClass('gallery-item')) return;

              // Create gallery item
              img.wrap('<div class="gallery-item"></div>');

              // Add caption if available
              if (caption) {
                img.after(`<div class="gallery-caption">${caption}</div>`);
              }
            });

            // Add click handler for lightbox
            $(this).find('.gallery-item').on('click', function() {
              openGalleryLightbox($(this));
            });
          }
        });

        // Add lightbox to single images
        $('.post-body').find('img').each(function() {
          const img = $(this);

          // Skip if already processed or part of a gallery
          if (img.parent().hasClass('gallery-item') || img.parent().hasClass('lightbox-item')) return;

          const caption = img.attr('alt') || '';

          // Wrap in lightbox item
          img.wrap('<div class="lightbox-item"></div>');

          // Add overlay with icon
          img.after('<div class="image-lightbox-overlay"><button class="lightbox-button" aria-label="View full image"><i class="fas fa-search-plus"></i></button></div>');

          // Add click handler
          img.parent('.lightbox-item').on('click', function() {
            openImageLightbox(img, caption);
          });
        });
      }

      // Open gallery lightbox
      function openGalleryLightbox(clickedItem) {
        const gallery = clickedItem.parent();
        const items = gallery.find('.gallery-item');
        const currentIndex = items.index(clickedItem);

        // Create lightbox HTML
        const lightboxHTML = `
          <div class="image-lightbox">
            <div class="lightbox-content">
              <img class="lightbox-image" src="${clickedItem.find('img').attr('src')}" alt="${clickedItem.find('img').attr('alt') || ''}">
              <div class="lightbox-caption">${clickedItem.find('.gallery-caption').text() || ''}</div>
              <div class="lightbox-controls">
                <button class="lightbox-control prev-btn" aria-label="Previous image"><i class="fas fa-chevron-left"></i></button>
                <button class="lightbox-control next-btn" aria-label="Next image"><i class="fas fa-chevron-right"></i></button>
              </div>
              <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
              <div class="lightbox-counter">${currentIndex + 1} / ${items.length}</div>
            </div>
          </div>
        `;

        // Add to body
        $('body').append(lightboxHTML);
        $('body').css('overflow', 'hidden');

        // Show lightbox with animation
        setTimeout(() => {
          $('.image-lightbox').addClass('active');
        }, 10);

        // Handle navigation
        let index = currentIndex;

        $('.prev-btn').on('click', function(e) {
          e.stopPropagation();
          index = (index - 1 + items.length) % items.length;
          updateLightboxContent(items.eq(index), index, items.length);
        });

        $('.next-btn').on('click', function(e) {
          e.stopPropagation();
          index = (index + 1) % items.length;
          updateLightboxContent(items.eq(index), index, items.length);
        });

        // Close on click outside or close button
        $('.image-lightbox, .lightbox-close').on('click', function(e) {
          if (e.target === this || $(e.target).hasClass('lightbox-close') || $(e.target).parent().hasClass('lightbox-close')) {
            closeLightbox();
          }
        });

        // Prevent closing when clicking on content
        $('.lightbox-content').on('click', function(e) {
          e.stopPropagation();
        });

        // Keyboard navigation
        $(document).on('keydown.lightbox', function(e) {
          if (e.key === 'Escape') {
            closeLightbox();
          } else if (e.key === 'ArrowLeft') {
            $('.prev-btn').trigger('click');
          } else if (e.key === 'ArrowRight') {
            $('.next-btn').trigger('click');
          }
        });
      }

      // Update lightbox content
      function updateLightboxContent(item, index, total) {
        const img = item.find('img');
        const caption = item.find('.gallery-caption').text() || '';

        $('.lightbox-image').attr('src', img.attr('src')).attr('alt', img.attr('alt') || '');
        $('.lightbox-caption').text(caption);
        $('.lightbox-counter').text(`${index + 1} / ${total}`);
      }

      // Open single image lightbox
      function openImageLightbox(img, caption) {
        // Create lightbox HTML
        const lightboxHTML = `
          <div class="image-lightbox">
            <div class="lightbox-content">
              <img class="lightbox-image" src="${img.attr('src')}" alt="${img.attr('alt') || ''}">
              <div class="lightbox-caption">${caption}</div>
              <button class="lightbox-close" aria-label="Close lightbox">&times;</button>
            </div>
          </div>
        `;

        // Add to body
        $('body').append(lightboxHTML);
        $('body').css('overflow', 'hidden');

        // Show lightbox with animation
        setTimeout(() => {
          $('.image-lightbox').addClass('active');
        }, 10);

        // Close on click outside or close button
        $('.image-lightbox, .lightbox-close').on('click', function(e) {
          if (e.target === this || $(e.target).hasClass('lightbox-close') || $(e.target).parent().hasClass('lightbox-close')) {
            closeLightbox();
          }
        });

        // Prevent closing when clicking on content
        $('.lightbox-content').on('click', function(e) {
          e.stopPropagation();
        });

        // Keyboard navigation
        $(document).on('keydown.lightbox', function(e) {
          if (e.key === 'Escape') {
            closeLightbox();
          }
        });
      }

      // Close lightbox
      function closeLightbox() {
        $('.image-lightbox').removeClass('active');

        setTimeout(() => {
          $('.image-lightbox').remove();
          $('body').css('overflow', '');
          $(document).off('keydown.lightbox');
        }, 300);
      }

      // Initialize on document ready
      $(document).ready(function() {
        initGallery();
      });

      // Re-initialize when SPA loads new content
      $(document).on('spa:contentLoaded', function() {
        initGallery();
      });

    })(jQuery);

    // Basic SEO Suggestions via JavaScript
    (function($) {
      'use strict';

      // Only run in admin mode
      function initSEOSuggestions() {
        // Check if we're in the Blogger editor
        if (window.location.href.indexOf('blogger.com/blogger.g') === -1) return;

        // Create SEO panel
        const seoPanel = $(`
          <div id="seo-suggestions-panel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 9999; padding: 15px; max-height: 400px; overflow-y: auto;">
            <h3 style="margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px;">SEO Suggestions</h3>
            <div id="seo-suggestions-content"></div>
          </div>
        `);

        // Add to body
        $('body').append(seoPanel);

        // Analyze post when editor content changes
        const observer = new MutationObserver(debounce(analyzePost, 1000));

        // Start observing the editor
        const editorElement = $('#postingComposeBox, .posting');
        if (editorElement.length) {
          observer.observe(editorElement[0], { childList: true, subtree: true });

          // Initial analysis
          analyzePost();
        }
      }

      // Analyze post content for SEO
      function analyzePost() {
        const suggestions = [];

        // Get post title
        const titleElement = $('#postingTitleBox, .title');
        const title = titleElement.length ? titleElement.val() || titleElement.text() : '';

        // Get post content
        const contentElement = $('#postingComposeBox, .posting');
        const content = contentElement.length ? contentElement.text() : '';

        // Check title length
        if (title.length === 0) {
          suggestions.push({ type: 'error', message: 'Post title is missing.' });
        } else if (title.length < 30) {
          suggestions.push({ type: 'warning', message: 'Title is too short. Aim for 50-60 characters.' });
        } else if (title.length > 60) {
          suggestions.push({ type: 'warning', message: 'Title is too long. Keep it under 60 characters.' });
        } else {
          suggestions.push({ type: 'success', message: 'Title length is good.' });
        }

        // Check for headings
        const headings = content.match(/<h[1-6][^>]*>.*?<\/h[1-6]>/gi) || [];
        if (headings.length === 0) {
          suggestions.push({ type: 'warning', message: 'No headings found. Use H2-H4 tags to structure your content.' });
        } else {
          suggestions.push({ type: 'success', message: `Found ${headings.length} headings. Good structure!` });
        }

        // Check content length
        const wordCount = content.split(/\s+/).length;
        if (wordCount < 300) {
          suggestions.push({ type: 'warning', message: 'Content is too short. Aim for at least 300 words.' });
        } else if (wordCount > 300 && wordCount < 600) {
          suggestions.push({ type: 'info', message: 'Content length is acceptable but could be longer for better SEO.' });
        } else {
          suggestions.push({ type: 'success', message: `Good content length: ${wordCount} words.` });
        }

        // Check for images
        const images = content.match(/<img[^>]*>/gi) || [];
        if (images.length === 0) {
          suggestions.push({ type: 'warning', message: 'No images found. Add at least one image with alt text.' });
        } else {
          // Check for alt text
          const imagesWithAlt = content.match(/<img[^>]*alt=["'][^"']+["'][^>]*>/gi) || [];
          if (imagesWithAlt.length < images.length) {
            suggestions.push({ type: 'warning', message: `${images.length - imagesWithAlt.length} images missing alt text.` });
          } else {
            suggestions.push({ type: 'success', message: 'All images have alt text. Great!' });
          }
        }

        // Check for links
        const links = content.match(/<a[^>]*href=["'][^"']+["'][^>]*>.*?<\/a>/gi) || [];
        if (links.length === 0) {
          suggestions.push({ type: 'info', message: 'No links found. Consider adding internal or external links.' });
        } else {
          suggestions.push({ type: 'success', message: `Found ${links.length} links.` });
        }

        // Update suggestions panel
        updateSuggestions(suggestions);
      }

      // Update suggestions panel
      function updateSuggestions(suggestions) {
        const content = $('#seo-suggestions-content');
        content.empty();

        if (suggestions.length === 0) {
          content.html('<p>No suggestions available.</p>');
          return;
        }

        const list = $('<ul style="padding-left: 20px; margin-top: 10px;"></ul>');

        suggestions.forEach(suggestion => {
          const color = suggestion.type === 'error' ? '#e63946' :
                        suggestion.type === 'warning' ? '#f4a261' :
                        suggestion.type === 'info' ? '#457b9d' : '#2a9d8f';

          list.append(`<li style="margin-bottom: 8px; color: ${color};">${suggestion.message}</li>`);
        });

        content.append(list);
      }

      // Debounce function to limit how often a function is called
      function debounce(func, wait) {
        let timeout;
        return function() {
          const context = this;
          const args = arguments;
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(context, args), wait);
        };
      }

      // Initialize on document ready
      $(document).ready(function() {
        // Delay initialization to ensure Blogger editor is loaded
        setTimeout(initSEOSuggestions, 2000);
      });

    })(jQuery);

    // Structured Data and Rich Snippets Manager
    (function($) {
      'use strict';

      // Initialize structured data manager
      function initStructuredDataManager() {
        // Set up event listeners for SPA navigation
        $(document).on('spa:contentLoaded', updateStructuredData);

        // Initial update
        updateStructuredData();

        // Listen for URL changes (for SPA navigation)
        let lastUrl = window.location.href;
        const urlObserver = new MutationObserver(function(mutations) {
          if (lastUrl !== window.location.href) {
            lastUrl = window.location.href;
            updateStructuredData();
          }
        });

        // Observe the document for URL changes
        urlObserver.observe(document, { subtree: true, childList: true });
      }

      // Update structured data based on current page content
      function updateStructuredData() {
        // Determine page type
        const isArticlePage = $('.single-post').length > 0;
        const isHomePage = $('.featured-section').length > 0 && !isArticlePage;

        // Update canonical URL meta tag
        updateCanonicalUrl();

        // Update core schema
        updateCoreSchema(isArticlePage);

        // Update breadcrumb schema if on article page
        if (isArticlePage) {
          updateBreadcrumbSchema();

          // Detect and update specialized schemas
          detectAndUpdateSpecializedSchemas();
        }
      }

      // Update canonical URL meta tag
      function updateCanonicalUrl() {
        const canonicalUrl = window.location.href.split('#')[0].split('?')[0];

        // Update canonical meta tag
        $('meta[name="canonical"]').attr('content', canonicalUrl);
        $('link[rel="canonical"]').attr('href', canonicalUrl);

        // Update Open Graph URL
        $('meta[property="og:url"]').attr('content', canonicalUrl);

        // Update Twitter URL
        $('meta[name="twitter:url"]').attr('content', canonicalUrl);
      }

      // Update core schema based on page content
      function updateCoreSchema(isArticlePage) {
        if (!$('#core-schema').length) return;

        const schemaScript = $('#core-schema');
        let schemaData = JSON.parse(schemaScript.html());

        if (isArticlePage) {
          // Update BlogPosting schema
          const article = $('.single-post');
          const postTitle = article.find('.post-title').text().trim();
          const postDescription = article.find('.post-body p').first().text().trim();
          const postImage = article.find('.post-featured-image img').attr('src') || '';
          const postUrl = window.location.href.split('#')[0].split('?')[0];
          const postDate = article.find('.post-date').text().trim();
          const postAuthor = article.find('.post-author').text().replace('by', '').trim();
          const postContent = article.find('.post-body').text().trim();
          const postLabels = [];

          // Extract labels/tags
          article.find('.post-tags a').each(function() {
            postLabels.push($(this).text().trim());
          });

          // Update schema properties
          schemaData.headline = postTitle;
          schemaData.description = postDescription;
          if (postImage) {
            schemaData.image = [postImage];
          }
          schemaData.mainEntityOfPage["@id"] = postUrl;
          schemaData.author.name = postAuthor || "Kanahola Magazine";
          schemaData.keywords = postLabels;
          schemaData.wordCount = Math.round(postContent.split(/\s+/).length);

          // Try to extract comment count
          const commentCount = $('.comments h3').text().match(/\d+/);
          if (commentCount) {
            schemaData.commentCount = commentCount[0];
          }

          // Set article section from first label
          if (postLabels.length > 0) {
            schemaData.articleSection = postLabels[0];
          }
        } else {
          // Update WebSite schema
          const siteTitle = $('.logo').text().trim() || "Kanahola Magazine";
          const siteDescription = $('meta[name="description"]').attr('content') || '';
          const siteUrl = window.location.origin;

          // Update schema properties
          schemaData.name = siteTitle;
          schemaData.description = siteDescription;
          schemaData.url = siteUrl;
        }

        // Update the schema script
        schemaScript.html(JSON.stringify(schemaData, null, 2));
      }

      // Update breadcrumb schema
      function updateBreadcrumbSchema() {
        if (!$('#breadcrumb-schema').length) return;

        const schemaScript = $('#breadcrumb-schema');
        let schemaData = JSON.parse(schemaScript.html());

        const article = $('.single-post');
        const postTitle = article.find('.post-title').text().trim();
        const postUrl = window.location.href.split('#')[0].split('?')[0];
        const homeUrl = window.location.origin;

        // Update last item in breadcrumb
        const lastItem = schemaData.itemListElement[schemaData.itemListElement.length - 1];
        lastItem.name = postTitle;
        lastItem.item = postUrl;

        // Update home URL
        schemaData.itemListElement[0].item = homeUrl;

        // Update category URL if present
        if (schemaData.itemListElement.length > 2) {
          const categoryName = article.find('.post-tags a').first().text().trim();
          if (categoryName) {
            schemaData.itemListElement[1].name = categoryName;
            schemaData.itemListElement[1].item = homeUrl + '/search/label/' + encodeURIComponent(categoryName);
          }
        }

        // Update the schema script
        schemaScript.html(JSON.stringify(schemaData, null, 2));
      }

      // Detect and update specialized schemas based on content
      function detectAndUpdateSpecializedSchemas() {
        const article = $('.single-post');
        const postContent = article.find('.post-body').html();
        const postTitle = article.find('.post-title').text().trim();
        const postUrl = window.location.href.split('#')[0].split('?')[0];
        const postImage = article.find('.post-featured-image img').attr('src') || '';
        const postDate = article.find('.post-date').text().trim();
        const postAuthor = article.find('.post-author').text().replace('by', '').trim() || "Kanahola Magazine";

        // Check for Recipe content
        if (postContent.includes('recipe-ingredients') ||
            (postContent.includes('Ingredients') && postContent.includes('Instructions'))) {
          updateRecipeSchema(article, postTitle, postUrl, postImage, postDate, postAuthor);
        }

        // Check for FAQ content
        if (postContent.includes('faq-section') ||
            postContent.includes('<h2>FAQ</h2>') ||
            postContent.includes('<h3>Frequently Asked Questions</h3>')) {
          updateFAQSchema(article, postTitle, postUrl);
        }

        // Check for HowTo content
        if (postContent.includes('howto-steps') ||
            postContent.includes('<h2>How To</h2>') ||
            postContent.includes('<h3>Step-by-Step Guide</h3>')) {
          updateHowToSchema(article, postTitle, postUrl, postImage, postDate, postAuthor);
        }

        // Check for Review content
        if (postContent.includes('product-review') ||
            postContent.includes('<h2>Review</h2>') ||
            postContent.includes('rating-value')) {
          updateReviewSchema(article, postTitle, postUrl, postImage, postDate, postAuthor);
        }
      }

      // Update Recipe schema
      function updateRecipeSchema(article, postTitle, postUrl, postImage, postDate, postAuthor) {
        if (!$('#recipe-schema').length) return;

        const schemaScript = $('#recipe-schema');
        let schemaData = JSON.parse(schemaScript.html());

        // Basic recipe data
        schemaData.name = postTitle;
        schemaData.image = postImage;
        schemaData.author.name = postAuthor;
        schemaData.datePublished = postDate;
        schemaData.description = article.find('.post-body p').first().text().trim();
        schemaData.url = postUrl;

        // Extract recipe-specific data
        const recipeYield = article.find('.recipe-yield').text().trim() ||
                           article.find('strong:contains("Servings")').next().text().trim() ||
                           "4 servings";

        const prepTime = article.find('.prep-time').text().trim() ||
                        article.find('strong:contains("Prep Time")').next().text().trim() ||
                        "PT30M";

        const cookTime = article.find('.cook-time').text().trim() ||
                        article.find('strong:contains("Cook Time")').next().text().trim() ||
                        "PT1H";

        // Update recipe properties
        schemaData.recipeYield = recipeYield;
        schemaData.prepTime = prepTime.includes("PT") ? prepTime : "PT" + prepTime.replace(/\s+/g, "");
        schemaData.cookTime = cookTime.includes("PT") ? cookTime : "PT" + cookTime.replace(/\s+/g, "");
        schemaData.totalTime = "PT" + (parseInt(schemaData.prepTime.replace(/\D/g, "")) +
                                     parseInt(schemaData.cookTime.replace(/\D/g, ""))) + "M";

        // Extract ingredients
        const ingredients = [];
        article.find('.recipe-ingredients li, .ingredients li').each(function() {
          ingredients.push($(this).text().trim());
        });

        if (ingredients.length === 0) {
          // Try to find ingredients section
          let inIngredientsSection = false;
          article.find('h2, h3, h4, p, li').each(function() {
            const text = $(this).text().trim();

            if (text === "Ingredients" || text === "INGREDIENTS") {
              inIngredientsSection = true;
            } else if ($(this).is('h2, h3, h4') && inIngredientsSection) {
              inIngredientsSection = false;
            } else if (inIngredientsSection && $(this).is('li')) {
              ingredients.push(text);
            }
          });
        }

        // Extract instructions
        const instructions = [];
        article.find('.recipe-instructions li, .instructions li').each(function() {
          instructions.push({
            "@type": "HowToStep",
            "text": $(this).text().trim()
          });
        });

        if (instructions.length === 0) {
          // Try to find instructions section
          let inInstructionsSection = false;
          article.find('h2, h3, h4, p, li').each(function() {
            const text = $(this).text().trim();

            if (text === "Instructions" || text === "INSTRUCTIONS" || text === "Directions" || text === "DIRECTIONS") {
              inInstructionsSection = true;
            } else if ($(this).is('h2, h3, h4') && inInstructionsSection) {
              inInstructionsSection = false;
            } else if (inInstructionsSection && $(this).is('li')) {
              instructions.push({
                "@type": "HowToStep",
                "text": text
              });
            }
          });
        }

        // Update ingredients and instructions
        schemaData.recipeIngredient = ingredients;
        schemaData.recipeInstructions = instructions;

        // Make schema visible and update
        schemaScript.removeAttr('style');
        schemaScript.html(JSON.stringify(schemaData, null, 2));
      }

      // Update FAQ schema
      function updateFAQSchema(article, postTitle, postUrl) {
        if (!$('#faq-schema').length) return;

        const schemaScript = $('#faq-schema');
        let schemaData = JSON.parse(schemaScript.html());

        // Extract FAQ items
        const faqItems = [];

        // Look for FAQ sections with specific markup
        article.find('.faq-item').each(function() {
          const question = $(this).find('.faq-question').text().trim();
          const answer = $(this).find('.faq-answer').text().trim();

          if (question && answer) {
            faqItems.push({
              "@type": "Question",
              "name": question,
              "acceptedAnswer": {
                "@type": "Answer",
                "text": answer
              }
            });
          }
        });

        // If no specific markup, try to detect Q&A patterns
        if (faqItems.length === 0) {
          // Look for h3/h4 followed by paragraphs
          article.find('h3, h4').each(function() {
            const question = $(this).text().trim();
            let answer = "";

            // Get all paragraphs until next heading
            let nextElement = $(this).next();
            while (nextElement.length && !nextElement.is('h1, h2, h3, h4, h5, h6')) {
              if (nextElement.is('p')) {
                answer += nextElement.text().trim() + " ";
              }
              nextElement = nextElement.next();
            }

            answer = answer.trim();

            // Check if this looks like a Q&A
            if (question && answer &&
                (question.endsWith('?') ||
                 question.toLowerCase().includes('what') ||
                 question.toLowerCase().includes('how') ||
                 question.toLowerCase().includes('why') ||
                 question.toLowerCase().includes('when'))) {
              faqItems.push({
                "@type": "Question",
                "name": question,
                "acceptedAnswer": {
                  "@type": "Answer",
                  "text": answer
                }
              });
            }
          });
        }

        // Update FAQ schema
        schemaData.mainEntity = faqItems;

        // Only make schema visible if we found FAQ items
        if (faqItems.length > 0) {
          schemaScript.removeAttr('style');
          schemaScript.html(JSON.stringify(schemaData, null, 2));
        }
      }

      // Update HowTo schema
      function updateHowToSchema(article, postTitle, postUrl, postImage, postDate, postAuthor) {
        if (!$('#howto-schema').length) return;

        const schemaScript = $('#howto-schema');
        let schemaData = JSON.parse(schemaScript.html());

        // Basic HowTo data
        schemaData.name = postTitle;
        schemaData.description = article.find('.post-body p').first().text().trim();
        schemaData.image = postImage;

        // Extract time information
        const totalTime = article.find('.howto-time').text().trim() ||
                         article.find('strong:contains("Total Time")').next().text().trim() ||
                         "PT1H";

        schemaData.totalTime = totalTime.includes("PT") ? totalTime : "PT" + totalTime.replace(/\s+/g, "");

        // Extract tools and supplies
        const tools = [];
        article.find('.howto-tools li, .tools li').each(function() {
          tools.push($(this).text().trim());
        });

        const supplies = [];
        article.find('.howto-supplies li, .supplies li, .materials li').each(function() {
          supplies.push($(this).text().trim());
        });

        // Extract steps
        const steps = [];
        article.find('.howto-steps li, .steps li').each(function() {
          const stepText = $(this).text().trim();
          const stepImage = $(this).find('img').attr('src') || '';

          const step = {
            "@type": "HowToStep",
            "text": stepText
          };

          if (stepImage) {
            step.image = stepImage;
          }

          steps.push(step);
        });

        // If no specific markup, try to detect steps from numbered lists
        if (steps.length === 0) {
          let inStepsSection = false;
          article.find('h2, h3, h4, ol li').each(function() {
            const text = $(this).text().trim();

            if ($(this).is('h2, h3, h4') &&
                (text.includes('Steps') || text.includes('Instructions') || text.includes('Procedure'))) {
              inStepsSection = true;
            } else if ($(this).is('h2, h3, h4') && inStepsSection) {
              inStepsSection = false;
            } else if (inStepsSection && $(this).is('li')) {
              steps.push({
                "@type": "HowToStep",
                "text": text
              });
            }
          });
        }

        // Update HowTo properties
        schemaData.tool = tools;
        schemaData.supply = supplies;
        schemaData.step = steps;

        // Only make schema visible if we found steps
        if (steps.length > 0) {
          schemaScript.removeAttr('style');
          schemaScript.html(JSON.stringify(schemaData, null, 2));
        }
      }

      // Update Review schema
      function updateReviewSchema(article, postTitle, postUrl, postImage, postDate, postAuthor) {
        if (!$('#review-schema').length) return;

        const schemaScript = $('#review-schema');
        let schemaData = JSON.parse(schemaScript.html());

        // Extract product information
        const productName = article.find('.product-name').text().trim() ||
                           article.find('h2:contains("Product Review")').next('h3').text().trim() ||
                           postTitle.replace('Review', '').replace('review', '').trim();

        const productImage = article.find('.product-image').attr('src') || postImage;

        const productDescription = article.find('.product-description').text().trim() ||
                                 article.find('h3:contains("Product Description")').next('p').text().trim() ||
                                 article.find('.post-body p').first().text().trim();

        const brandName = article.find('.brand-name').text().trim() ||
                         article.find('strong:contains("Brand")').next().text().trim() ||
                         "Brand";

        // Extract rating
        let ratingValue = "5";
        article.find('.rating-value, .review-rating').each(function() {
          const ratingText = $(this).text().trim();
          const ratingMatch = ratingText.match(/(\d+(\.\d+)?)\s*\/\s*\d+/);

          if (ratingMatch) {
            ratingValue = ratingMatch[1];
          }
        });

        // Update Review schema
        schemaData.itemReviewed.name = productName;
        schemaData.itemReviewed.image = productImage;
        schemaData.itemReviewed.description = productDescription;
        schemaData.itemReviewed.brand.name = brandName;

        schemaData.reviewRating.ratingValue = ratingValue;
        schemaData.name = postTitle;
        schemaData.author.name = postAuthor;
        schemaData.datePublished = postDate;

        // Extract review body
        let reviewBody = "";
        let inReviewSection = false;

        article.find('h2, h3, h4, p').each(function() {
          const text = $(this).text().trim();

          if ($(this).is('h2, h3, h4') &&
              (text.includes('Review') || text.includes('Verdict') || text.includes('Conclusion'))) {
            inReviewSection = true;
          } else if ($(this).is('h2, h3, h4') && inReviewSection) {
            inReviewSection = false;
          } else if (inReviewSection && $(this).is('p')) {
            reviewBody += text + " ";
          }
        });

        // If no specific review section found, use first few paragraphs
        if (!reviewBody) {
          article.find('.post-body p').slice(0, 3).each(function() {
            reviewBody += $(this).text().trim() + " ";
          });
        }

        schemaData.reviewBody = reviewBody.trim();

        // Only make schema visible if we have enough data
        if (productName && ratingValue) {
          schemaScript.removeAttr('style');
          schemaScript.html(JSON.stringify(schemaData, null, 2));
        }
      }

      // Create visual breadcrumb navigation
      function createVisualBreadcrumbs() {
        // Only create breadcrumbs on article pages
        if (!$('.single-post').length) return;

        // Check if breadcrumbs already exist
        if ($('.visual-breadcrumbs').length) return;

        const article = $('.single-post');
        const postTitle = article.find('.post-title').text().trim();
        const homeUrl = window.location.origin;

        // Get category from first tag
        let categoryName = '';
        let categoryUrl = '';

        if (article.find('.post-tags a').length) {
          categoryName = article.find('.post-tags a').first().text().trim();
          categoryUrl = homeUrl + '/search/label/' + encodeURIComponent(categoryName);
        }

        // Create breadcrumb HTML
        let breadcrumbHtml = `
          <div class="visual-breadcrumbs">
            <a href="${homeUrl}">Home</a>
            <span class="breadcrumb-separator"></span>
        `;

        if (categoryName) {
          breadcrumbHtml += `
            <a href="${categoryUrl}">${categoryName}</a>
            <span class="breadcrumb-separator"></span>
          `;
        }

        breadcrumbHtml += `
            <span class="current-page">${postTitle}</span>
          </div>
        `;

        // Add breadcrumbs to the page
        article.prepend(breadcrumbHtml);

        // Add breadcrumb styles if not already present
        if (!$('#breadcrumb-styles').length) {
          $('head').append(`
            <style id="breadcrumb-styles">
              .visual-breadcrumbs {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                margin-bottom: var(--spacing-md);
                font-size: 0.9rem;
                color: var(--dark-gray);
              }
              .visual-breadcrumbs a {
                color: var(--secondary-color);
                text-decoration: none;
                transition: color 0.2s ease;
              }
              .visual-breadcrumbs a:hover {
                color: var(--primary-color);
                text-decoration: underline;
              }
              .breadcrumb-separator {
                margin: 0 var(--spacing-xs);
              }
              .current-page {
                color: var(--dark-gray);
                font-weight: 500;
                max-width: 300px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              }

              /* Dark mode styles */
              body.dark-mode .visual-breadcrumbs {
                color: var(--dark-text);
              }
              body.dark-mode .visual-breadcrumbs a {
                color: var(--dark-link-color);
              }
              body.dark-mode .visual-breadcrumbs a:hover {
                color: var(--dark-link-hover-color);
              }
              body.dark-mode .current-page {
                color: var(--dark-text);
              }
            </style>
          `);
        }
      }

      // Initialize on document ready
      $(document).ready(function() {
        initStructuredDataManager();
        createVisualBreadcrumbs();
      });

      // Re-initialize when SPA loads new content
      $(document).on('spa:contentLoaded', function() {
        createVisualBreadcrumbs();
      });

    })(jQuery);
  </script>
</body>
</html>
